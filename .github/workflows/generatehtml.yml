name: Generate Proposal HTML

on:
  workflow_dispatch: #periodic
    inputs:
      logLevel:
        description: "Log lev"
        required: true
        default: "warning"
  schedule:
    - cron: "0 0 * * *"

# on:
#   schedule:
#   - cron: "0 0 * * *"

#on: push

jobs:
  generateHTML:
    env:
      JBAL_VERSION: "2201.0.3"
      GITHUB_TOKEN: ${{secrets.BALLERINA_BOT_TOKEN}}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          token: ${{ secrets.BALLERINA_BOT_TOKEN }}
      - name: Download jBallerina deb
        run: |
          echo "djaebfaefakf"
          curl -L "https://github.com/ballerina-platform/ballerina-distribution/releases/download/v$JBAL_VERSION/ballerina-$JBAL_VERSION-swan-lake-linux-x64.deb" > $HOME/ballerina-$JBAL_VERSION-swan-lake-linux-x64.deb
      - name: Install jBallerina deb
        run: |
          sudo dpkg -i $HOME/ballerina-$JBAL_VERSION-swan-lake-linux-x64.deb
          echo "/usr/lib/ballerina/bin" >> $GITHUB_PATH
          echo "/usr/lib/ballerina/dependencies/jdk-11.0.8+10-jre/bin/java" >> $GITHUB_PATH
      - name: Run Proposals Bot
        run: |
          bal run .github/scripts/bal_proposals_bot
      - name: Commit files
        id: commit
        run: |
          if git diff-index --quiet HEAD --; then
              echo "No changes"
          else
              git config --local user.email "bgpbimsara@gmail.com"
              git config --local user.name "bimsarapathiraja"
              git add --all
              if [-z "$(git status --porcelain)"]; then
                echo "::set-output name=push::false"
              else
                git commit -m "Generate proposal HTML" -a
                echo "::set-output name=push::true"
              fi
          fi
        shell: bash
      - name: Push changes
        run: |
          git config --global user.email "bgpbimsara@gmail.com"
          git config --global user.name "bimsarapathiraja"
          git push 
        env:
          GITHUB_TOKEN: ${{ secrets.BALLERINA_BOT_TOKEN }}
