---
layout: ballerina-example-page
title: Retry
description: 
keywords: 
permalink: /1.2/learn/by-example/websocket-retry
active: websocket-retry
redirect_from:
  - /v1-2/learn/by-example/websocket-retry
  - /v1-2/learn/by-example/websocket-retry.html
---
<div class="row cBallerina-io-Gray-row">
        <div class="container cBallerinaBySampleContainer">
            <div class="FullCode">
                <div class="highlight"><pre><span class="kn">import</span> <span class="nx">ballerina</span><span class="o">/</span><span class="nx">http</span><span class="p">;</span>
<span class="kn">import</span> <span class="nx">ballerina</span><span class="o">/</span><span class="nx">log</span><span class="p">;</span>

<span class="nx">final</span> <span class="kt">string</span> <span class="nx">ASSOCIATED_CONNECTION</span> <span class="p">=</span> <span class="s">&quot;ASSOCIATED_CONNECTION&quot;</span><span class="p">;</span>

<span class="c1">// The URL of the remote backend.</span>
<span class="kd">const</span> <span class="kt">string</span> <span class="nx">REMOTE_BACKEND</span> <span class="p">=</span> <span class="s">&quot;ws://localhost:9095/retry/ws&quot;</span><span class="p">;</span>

<span class="nd">@http:WebSocketServiceConfig {</span>
    <span class="nx">path</span><span class="p">:</span> <span class="s">&quot;/retry/ws&quot;</span>
<span class="p">}</span>
<span class="kd">service</span> <span class="nx">retryProxyService</span> <span class="nx">on</span> <span class="nx">new</span> <span class="nx">http</span><span class="p">:</span><span class="nx">Listener</span><span class="p">(</span><span class="mi">9090</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">// This resource gets invoked when a new client connects.</span>
    <span class="c1">// Since messages to the server are not read by the service until</span>
    <span class="c1">// the execution of the `onOpen` resource finishes,</span>
    <span class="c1">// operations, which should happen before reading messages should be done</span>
    <span class="c1">// in the `onOpen` resource.</span>
    <span class="kd">resource</span> <span class="kd">function</span> <span class="nx">onOpen</span><span class="p">(</span><span class="nx">http</span><span class="p">:</span><span class="nx">WebSocketCaller</span> <span class="nx">caller</span><span class="p">)</span> <span class="p">{</span>

        <span class="c1">// Defines the webSocket client.</span>
        <span class="nx">http</span><span class="p">:</span><span class="nx">WebSocketClient</span> <span class="nx">wsClientEp</span> <span class="p">=</span> <span class="nx">new</span> <span class="p">(</span>
        <span class="nx">REMOTE_BACKEND</span><span class="p">,</span>
        <span class="p">{</span>
            <span class="nx">callbackService</span><span class="p">:</span> <span class="nx">retryClientService</span><span class="p">,</span>
            <span class="c1">// When creating client endpoint, if `readyOnConnect` flag is set to</span>
            <span class="c1">// `false`, client endpoint does not start reading frames automatically.</span>
            <span class="nx">readyOnConnect</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
            <span class="c1">// Retry configuration options.</span>
            <span class="nx">retryConfig</span><span class="p">:</span> <span class="p">{</span>
                <span class="c1">// The number of milliseconds to delay before attempting to reconnect.</span>
                <span class="nx">intervalInMillis</span><span class="p">:</span> <span class="mi">3000</span><span class="p">,</span>
                <span class="c1">// The maximum number of retry attempts.</span>
                <span class="c1">// If the count is zero, the client will retry indefinitely.</span>
                <span class="nx">maxCount</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
                <span class="c1">// The rate of increase of the reconnect delay.</span>
                <span class="nx">backOffFactor</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">,</span>
                <span class="c1">// Upper limit of the retry interval in milliseconds. If</span>
                <span class="c1">// `intervalInMillis` into `backOffFactor` value exceeded</span>
                <span class="c1">// `maxWaitIntervalInMillis` interval value, then</span>
                <span class="c1">// `maxWaitIntervalInMillis` will be considered as the retry interval.</span>
                <span class="nx">maxWaitIntervalInMillis</span><span class="p">:</span> <span class="mi">20000</span>
            <span class="p">}</span>
        <span class="p">});</span>

        <span class="c1">// Associate connections before starting to read messages.</span>
        <span class="nx">wsClientEp</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="nx">ASSOCIATED_CONNECTION</span><span class="p">,</span> <span class="nx">caller</span><span class="p">);</span>
        <span class="nx">caller</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="nx">ASSOCIATED_CONNECTION</span><span class="p">,</span> <span class="nx">wsClientEp</span><span class="p">);</span>

        <span class="c1">// Once the client is ready to receive frames, the remote function `ready`</span>
        <span class="c1">// of the client needs to be called separately.</span>
        <span class="k">var</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">wsClientEp</span><span class="o">-&gt;</span><span class="nx">ready</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span> <span class="nx">is</span> <span class="nx">http</span><span class="p">:</span><span class="nx">WebSocketError</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">log</span><span class="p">:</span><span class="nx">printError</span><span class="p">(</span><span class="s">&quot;Error calling ready on client&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// This resource gets invoked upon receiving a new text frame from a client.</span>
    <span class="kd">resource</span> <span class="kd">function</span> <span class="nx">onText</span><span class="p">(</span><span class="nx">http</span><span class="p">:</span><span class="nx">WebSocketCaller</span> <span class="nx">caller</span><span class="p">,</span> <span class="kt">string</span> <span class="nx">text</span><span class="p">,</span>
                                <span class="kt">boolean</span> <span class="nx">finalFrame</span><span class="p">)</span> <span class="p">{</span>

        <span class="nx">http</span><span class="p">:</span><span class="nx">WebSocketClient</span> <span class="nx">clientEp</span> <span class="p">=</span> <span class="nx">getAssociatedClientEndpoint</span><span class="p">(</span><span class="nx">caller</span><span class="p">);</span>
        <span class="k">var</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">clientEp</span><span class="o">-&gt;</span><span class="nx">pushText</span><span class="p">(</span><span class="nx">text</span><span class="p">,</span> <span class="nx">finalFrame</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span> <span class="nx">is</span> <span class="nx">http</span><span class="p">:</span><span class="nx">WebSocketError</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">log</span><span class="p">:</span><span class="nx">printError</span><span class="p">(</span><span class="s">&quot;Error occurred when sending text message&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// This resource gets invoked when an error occurs in the connection.</span>
    <span class="kd">resource</span> <span class="kd">function</span> <span class="nx">onError</span><span class="p">(</span><span class="nx">http</span><span class="p">:</span><span class="nx">WebSocketCaller</span> <span class="nx">caller</span><span class="p">,</span> <span class="nx">error</span> <span class="nx">err</span><span class="p">)</span> <span class="p">{</span>

        <span class="nx">http</span><span class="p">:</span><span class="nx">WebSocketClient</span> <span class="nx">clientEp</span> <span class="p">=</span> <span class="nx">getAssociatedClientEndpoint</span><span class="p">(</span><span class="nx">caller</span><span class="p">);</span>
        <span class="k">var</span> <span class="nx">e</span> <span class="p">=</span> <span class="nx">clientEp</span><span class="o">-&gt;</span><span class="nx">close</span><span class="p">(</span><span class="nx">statusCode</span> <span class="p">=</span> <span class="mi">1011</span><span class="p">,</span> <span class="nx">reason</span> <span class="p">=</span> <span class="s">&quot;Unexpected condition&quot;</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">e</span> <span class="nx">is</span> <span class="nx">http</span><span class="p">:</span><span class="nx">WebSocketError</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">log</span><span class="p">:</span><span class="nx">printError</span><span class="p">(</span><span class="s">&quot;Error occurred when closing the connection&quot;</span><span class="p">,</span> <span class="nx">e</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">log</span><span class="p">:</span><span class="nx">printError</span><span class="p">(</span><span class="s">&quot;Unexpected error hence closing the connection&quot;</span><span class="p">,</span> <span class="nx">e</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// This resource gets invoked when a client connection is closed from the client side.</span>
    <span class="kd">resource</span> <span class="kd">function</span> <span class="nx">onClose</span><span class="p">(</span><span class="nx">http</span><span class="p">:</span><span class="nx">WebSocketCaller</span> <span class="nx">caller</span><span class="p">,</span> <span class="kt">int</span> <span class="nx">statusCode</span><span class="p">,</span>
                                 <span class="kt">string</span> <span class="nx">reason</span><span class="p">)</span> <span class="p">{</span>

        <span class="nx">http</span><span class="p">:</span><span class="nx">WebSocketClient</span> <span class="nx">clientEp</span> <span class="p">=</span> <span class="nx">getAssociatedClientEndpoint</span><span class="p">(</span><span class="nx">caller</span><span class="p">);</span>
        <span class="k">var</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">clientEp</span><span class="o">-&gt;</span><span class="nx">close</span><span class="p">(</span><span class="nx">statusCode</span> <span class="p">=</span> <span class="nx">statusCode</span><span class="p">,</span> <span class="nx">reason</span> <span class="p">=</span> <span class="nx">reason</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span> <span class="nx">is</span> <span class="nx">http</span><span class="p">:</span><span class="nx">WebSocketError</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">log</span><span class="p">:</span><span class="nx">printError</span><span class="p">(</span><span class="s">&quot;Error occurred when closing the connection&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Client service to receive frames from the remote server.</span>
<span class="kd">service</span> <span class="nx">retryClientService</span> <span class="p">=</span> <span class="nd">@http:WebSocketServiceConfig {} service {</span>

    <span class="c1">// This resource gets invoked upon receiving a new text frame from</span>
    <span class="c1">// the remote backend.</span>
    <span class="kd">resource</span> <span class="kd">function</span> <span class="nx">onText</span><span class="p">(</span><span class="nx">http</span><span class="p">:</span><span class="nx">WebSocketClient</span> <span class="nx">caller</span><span class="p">,</span> <span class="kt">string</span> <span class="nx">text</span><span class="p">,</span>
                                <span class="kt">boolean</span> <span class="nx">finalFrame</span><span class="p">)</span> <span class="p">{</span>

        <span class="nx">http</span><span class="p">:</span><span class="nx">WebSocketCaller</span> <span class="nx">serverEp</span> <span class="p">=</span> <span class="nx">getAssociatedServerEndpoint</span><span class="p">(</span><span class="nx">caller</span><span class="p">);</span>
        <span class="k">var</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">serverEp</span><span class="o">-&gt;</span><span class="nx">pushText</span><span class="p">(</span><span class="nx">text</span><span class="p">,</span> <span class="nx">finalFrame</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span> <span class="nx">is</span> <span class="nx">http</span><span class="p">:</span><span class="nx">WebSocketError</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">log</span><span class="p">:</span><span class="nx">printError</span><span class="p">(</span><span class="s">&quot;Error occurred when sending text message&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// This resource gets invoked when an error occurs in the connection.</span>
    <span class="kd">resource</span> <span class="kd">function</span> <span class="nx">onError</span><span class="p">(</span><span class="nx">http</span><span class="p">:</span><span class="nx">WebSocketClient</span> <span class="nx">caller</span><span class="p">,</span> <span class="nx">error</span> <span class="nx">err</span><span class="p">)</span> <span class="p">{</span>

        <span class="nx">http</span><span class="p">:</span><span class="nx">WebSocketCaller</span> <span class="nx">serverEp</span> <span class="p">=</span> <span class="nx">getAssociatedServerEndpoint</span><span class="p">(</span><span class="nx">caller</span><span class="p">);</span>
        <span class="k">var</span> <span class="nx">e</span> <span class="p">=</span> <span class="nx">serverEp</span><span class="o">-&gt;</span><span class="nx">close</span><span class="p">(</span><span class="nx">statusCode</span> <span class="p">=</span> <span class="mi">1011</span><span class="p">,</span> <span class="nx">reason</span> <span class="p">=</span> <span class="s">&quot;Unexpected condition&quot;</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">e</span> <span class="nx">is</span> <span class="nx">http</span><span class="p">:</span><span class="nx">WebSocketError</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">log</span><span class="p">:</span><span class="nx">printError</span><span class="p">(</span><span class="s">&quot;Error occurred when closing the connection&quot;</span><span class="p">,</span>
            <span class="nx">err</span> <span class="p">=</span> <span class="nx">e</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">log</span><span class="p">:</span><span class="nx">printError</span><span class="p">(</span><span class="s">&quot;Unexpected error hense closing the connection&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// This resource gets invoked when a client connection is closed by</span>
    <span class="c1">// the remote backend.</span>
    <span class="kd">resource</span> <span class="kd">function</span> <span class="nx">onClose</span><span class="p">(</span><span class="nx">http</span><span class="p">:</span><span class="nx">WebSocketClient</span> <span class="nx">caller</span><span class="p">,</span> <span class="kt">int</span> <span class="nx">statusCode</span><span class="p">,</span>
                                 <span class="kt">string</span> <span class="nx">reason</span><span class="p">)</span> <span class="p">{</span>

        <span class="nx">http</span><span class="p">:</span><span class="nx">WebSocketCaller</span> <span class="nx">serverEp</span> <span class="p">=</span> <span class="nx">getAssociatedServerEndpoint</span><span class="p">(</span><span class="nx">caller</span><span class="p">);</span>
        <span class="k">var</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">serverEp</span><span class="o">-&gt;</span><span class="nx">close</span><span class="p">(</span><span class="nx">statusCode</span> <span class="p">=</span> <span class="nx">statusCode</span><span class="p">,</span> <span class="nx">reason</span> <span class="p">=</span> <span class="nx">reason</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span> <span class="nx">is</span> <span class="nx">http</span><span class="p">:</span><span class="nx">WebSocketError</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">log</span><span class="p">:</span><span class="nx">printError</span><span class="p">(</span><span class="s">&quot;Error occurred when closing the connection&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="c1">// Function to retrieve the associated client of a particular caller.</span>
<span class="kd">function</span> <span class="nx">getAssociatedClientEndpoint</span><span class="p">(</span><span class="nx">http</span><span class="p">:</span><span class="nx">WebSocketCaller</span> <span class="nx">ep</span><span class="p">)</span>
                <span class="nx">returns</span> <span class="p">(</span><span class="nx">http</span><span class="p">:</span><span class="nx">WebSocketClient</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">http</span><span class="p">:</span><span class="nx">WebSocketClient</span> <span class="nx">wsClient</span> <span class="p">=</span> <span class="p">&lt;</span><span class="nx">http</span><span class="p">:</span><span class="nx">WebSocketClient</span><span class="p">&gt;</span><span class="nx">ep</span><span class="p">.</span>
    <span class="nx">getAttribute</span><span class="p">(</span><span class="nx">ASSOCIATED_CONNECTION</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">wsClient</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Function to retrieve the associated caller of a client.</span>
<span class="kd">function</span> <span class="nx">getAssociatedServerEndpoint</span><span class="p">(</span><span class="nx">http</span><span class="p">:</span><span class="nx">WebSocketClient</span> <span class="nx">ep</span><span class="p">)</span>
                <span class="nx">returns</span> <span class="p">(</span><span class="nx">http</span><span class="p">:</span><span class="nx">WebSocketCaller</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">http</span><span class="p">:</span><span class="nx">WebSocketCaller</span> <span class="nx">wsEndpoint</span> <span class="p">=</span> <span class="p">&lt;</span><span class="nx">http</span><span class="p">:</span><span class="nx">WebSocketCaller</span><span class="p">&gt;</span><span class="nx">ep</span><span class="p">.</span>
    <span class="nx">getAttribute</span><span class="p">(</span><span class="nx">ASSOCIATED_CONNECTION</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">wsEndpoint</span><span class="p">;</span>
<span class="p">}</span>
<span class="kn">import</span> <span class="nx">ballerina</span><span class="o">/</span><span class="nx">http</span><span class="p">;</span>
<span class="kn">import</span> <span class="nx">ballerina</span><span class="o">/</span><span class="nx">log</span><span class="p">;</span>

<span class="c1">// The annotation which is used to configure a WebSocket service.</span>
<span class="nd">@http:WebSocketServiceConfig {</span>
    <span class="nx">path</span><span class="p">:</span> <span class="s">&quot;/retry/ws&quot;</span>
<span class="p">}</span>

<span class="c1">// Define the backend service with port 9095, which is called by the client.</span>
<span class="kd">service</span> <span class="nx">server</span> <span class="nx">on</span> <span class="nx">new</span> <span class="nx">http</span><span class="p">:</span><span class="nx">Listener</span><span class="p">(</span><span class="mi">9095</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">// This resource gets invoked when a new client connects.</span>
    <span class="c1">// Since messages to the server are not read by the service</span>
    <span class="c1">// until the execution of the `onOpen` resource finishes,</span>
    <span class="c1">// operations which should happen before reading messages should be</span>
    <span class="c1">// done in the `onOpen` resource.</span>
    <span class="kd">resource</span> <span class="kd">function</span> <span class="nx">onOpen</span><span class="p">(</span><span class="nx">http</span><span class="p">:</span><span class="nx">WebSocketCaller</span> <span class="nx">caller</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">log</span><span class="p">:</span><span class="nx">printInfo</span><span class="p">(</span><span class="s">&quot;WebSocket client connected wih the server. &quot;</span> <span class="o">+</span>
        <span class="s">&quot;The Connection ID: &quot;</span> <span class="o">+</span> <span class="nx">caller</span><span class="p">.</span><span class="nx">getConnectionId</span><span class="p">());</span>
    <span class="p">}</span>

    <span class="c1">// This resource gets invoked when a server is receiving</span>
    <span class="c1">// a text message from the client.</span>
    <span class="kd">resource</span> <span class="kd">function</span> <span class="nx">onText</span><span class="p">(</span><span class="nx">http</span><span class="p">:</span><span class="nx">WebSocketCaller</span> <span class="nx">caller</span><span class="p">,</span> <span class="kt">string</span> <span class="nx">text</span><span class="p">,</span>
                                <span class="kt">boolean</span> <span class="nx">finalFrame</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">var</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">caller</span><span class="o">-&gt;</span><span class="nx">pushText</span><span class="p">(</span><span class="nx">text</span><span class="p">,</span> <span class="nx">finalFrame</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span> <span class="nx">is</span> <span class="nx">http</span><span class="p">:</span><span class="nx">WebSocketError</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">log</span><span class="p">:</span><span class="nx">printError</span><span class="p">(</span><span class="s">&quot;Error occurred when sending text message&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

            </div>

            <div class="col-xs-12 col-sm-12 col-md-12">
                <table class="cTopInfoContainer cTopControlsContainer">
                    <tr>
                        <td class="cLeftTD">
                            <h2>Retry</h2>
                            <p><p>If the WebSocket client lost a connection by the server being shut down or by getting any IOExceptions, Ballerina automatically reconnects to the same backend until the connection becomes successful or until the maximum reconnect attempts count is reached.</p>
</p>

                        </td>
                        <td class="cRightTD">
                            <div class="cTopButtonContainer">
                                
                                <div class="cButtonInfoContainer">
                                    <a class="prev" href="websocket-failover.html?is_ref_by_example=true">
                                        <span>< PREVIOUS</span>
                                        <p>Failover</p>
                                    </a>
                                </div>
                                 
                                <div class="cButtonInfoContainer">
                                    <a class="next" href="header-based-routing.html?is_ref_by_example=true">
                                        <span>NEXT ></span>
                                        <p>Header-Based Routing</p>
                                    </a>
                                </div>
                                
                            </div>
                        </td>
                    </tr>
                </table>
            </div>
            <div class="example" id="websocket-retry">
                <div class="col-xs-12 col-sm-12 col-md-12 cBBETable-container cCodeLeft">
                    <div class="cTopControlsContainer">
                        <div class="cTopControlsRow">
                            <div class="cLeftTD">
                                <div class="cBBE-links">
                                    <ul>
                                        <li>
                                            <a class="copy"><img src="/img/copy-icon.svg" /></a>
                                        </li>
                                        <li>
                                            <a target="_blank" href="https://github.com/ballerina-platform/ballerina-lang/tree/ballerina-1.2.x/examples/websocket-retry/"><img src="/img/github-logo-green.svg" /></a>
                                        </li>
                                        
                                    </ul>
                                </div>
                            </div> 
                        </div>
                    </div>
              
                    
                    <div class="codeSnippeset">

                        <div class="cBBE-body">
                            
                            <div class="cTR">

                                <div class="code leading">
                                    <div class="highlight"><pre><code class=language-ballerina>import ballerina/http;
import ballerina/log;
</code></pre></div>

                                </div>
                                <div class="docs">
                                    
                                </div>
                            </div>
                            
                            <div class="cTR">

                                <div class="code leading">
                                    <div class="highlight"><pre><code class=language-ballerina>final string ASSOCIATED_CONNECTION = &quot;ASSOCIATED_CONNECTION&quot;;
</code></pre></div>

                                </div>
                                <div class="docs">
                                    
                                </div>
                            </div>
                            
                            <div class="cTR hover-enable">

                                <div class="code leading">
                                    <div class="highlight"><pre><code class=language-ballerina>const string REMOTE_BACKEND = &quot;ws://localhost:9095/retry/ws&quot;;
</code></pre></div>

                                </div>
                                <div class="docs">
                                    
                                    <div class="cCodeDesription">
                                        <div>
                                            <p>The URL of the remote backend.</p>

                                        </div>
                                    </div>
                                    
                                </div>
                            </div>
                            
                            <div class="cTR">

                                <div class="code leading">
                                    <div class="highlight"><pre><code class=language-ballerina>@http:WebSocketServiceConfig {
    path: &quot;/retry/ws&quot;
}
service retryProxyService on new http:Listener(9090) {
</code></pre></div>

                                </div>
                                <div class="docs">
                                    
                                </div>
                            </div>
                            
                            <div class="cTR hover-enable">

                                <div class="code leading">
                                    <div class="highlight"><pre><code class=language-ballerina>    resource function onOpen(http:WebSocketCaller caller) {
</code></pre></div>

                                </div>
                                <div class="docs">
                                    
                                    <div class="cCodeDesription">
                                        <div>
                                            <p>This resource gets invoked when a new client connects.
 Since messages to the server are not read by the service until
 the execution of the <code>onOpen</code> resource finishes,
 operations, which should happen before reading messages should be done
 in the <code>onOpen</code> resource.</p>

                                        </div>
                                    </div>
                                    
                                </div>
                            </div>
                            
                            <div class="cTR hover-enable">

                                <div class="code leading">
                                    <div class="highlight"><pre><code class=language-ballerina>        http:WebSocketClient wsClientEp = new (
        REMOTE_BACKEND,
        {
            callbackService: retryClientService,
</code></pre></div>

                                </div>
                                <div class="docs">
                                    
                                    <div class="cCodeDesription">
                                        <div>
                                            <p>Defines the webSocket client.</p>

                                        </div>
                                    </div>
                                    
                                </div>
                            </div>
                            
                            <div class="cTR hover-enable">

                                <div class="code leading">
                                    <div class="highlight"><pre><code class=language-ballerina>            readyOnConnect: false,
</code></pre></div>

                                </div>
                                <div class="docs">
                                    
                                    <div class="cCodeDesription">
                                        <div>
                                            <p>When creating client endpoint, if <code>readyOnConnect</code> flag is set to
 <code>false</code>, client endpoint does not start reading frames automatically.</p>

                                        </div>
                                    </div>
                                    
                                </div>
                            </div>
                            
                            <div class="cTR hover-enable">

                                <div class="code leading">
                                    <div class="highlight"><pre><code class=language-ballerina>            retryConfig: {
</code></pre></div>

                                </div>
                                <div class="docs">
                                    
                                    <div class="cCodeDesription">
                                        <div>
                                            <p>Retry configuration options.</p>

                                        </div>
                                    </div>
                                    
                                </div>
                            </div>
                            
                            <div class="cTR hover-enable">

                                <div class="code leading">
                                    <div class="highlight"><pre><code class=language-ballerina>                intervalInMillis: 3000,
</code></pre></div>

                                </div>
                                <div class="docs">
                                    
                                    <div class="cCodeDesription">
                                        <div>
                                            <p>The number of milliseconds to delay before attempting to reconnect.</p>

                                        </div>
                                    </div>
                                    
                                </div>
                            </div>
                            
                            <div class="cTR hover-enable">

                                <div class="code leading">
                                    <div class="highlight"><pre><code class=language-ballerina>                maxCount: 20,
</code></pre></div>

                                </div>
                                <div class="docs">
                                    
                                    <div class="cCodeDesription">
                                        <div>
                                            <p>The maximum number of retry attempts.
 If the count is zero, the client will retry indefinitely.</p>

                                        </div>
                                    </div>
                                    
                                </div>
                            </div>
                            
                            <div class="cTR hover-enable">

                                <div class="code leading">
                                    <div class="highlight"><pre><code class=language-ballerina>                backOffFactor: 2.0,
</code></pre></div>

                                </div>
                                <div class="docs">
                                    
                                    <div class="cCodeDesription">
                                        <div>
                                            <p>The rate of increase of the reconnect delay.</p>

                                        </div>
                                    </div>
                                    
                                </div>
                            </div>
                            
                            <div class="cTR hover-enable">

                                <div class="code leading">
                                    <div class="highlight"><pre><code class=language-ballerina>                maxWaitIntervalInMillis: 20000
            }
        });
</code></pre></div>

                                </div>
                                <div class="docs">
                                    
                                    <div class="cCodeDesription">
                                        <div>
                                            <p>Upper limit of the retry interval in milliseconds. If
 <code>intervalInMillis</code> into <code>backOffFactor</code> value exceeded
 <code>maxWaitIntervalInMillis</code> interval value, then
 <code>maxWaitIntervalInMillis</code> will be considered as the retry interval.</p>

                                        </div>
                                    </div>
                                    
                                </div>
                            </div>
                            
                            <div class="cTR hover-enable">

                                <div class="code leading">
                                    <div class="highlight"><pre><code class=language-ballerina>        wsClientEp.setAttribute(ASSOCIATED_CONNECTION, caller);
        caller.setAttribute(ASSOCIATED_CONNECTION, wsClientEp);
</code></pre></div>

                                </div>
                                <div class="docs">
                                    
                                    <div class="cCodeDesription">
                                        <div>
                                            <p>Associate connections before starting to read messages.</p>

                                        </div>
                                    </div>
                                    
                                </div>
                            </div>
                            
                            <div class="cTR hover-enable">

                                <div class="code leading">
                                    <div class="highlight"><pre><code class=language-ballerina>        var err = wsClientEp-&gt;ready();
        if (err is http:WebSocketError) {
            log:printError(&quot;Error calling ready on client&quot;, err);
        }
    }
</code></pre></div>

                                </div>
                                <div class="docs">
                                    
                                    <div class="cCodeDesription">
                                        <div>
                                            <p>Once the client is ready to receive frames, the remote function <code>ready</code>
 of the client needs to be called separately.</p>

                                        </div>
                                    </div>
                                    
                                </div>
                            </div>
                            
                            <div class="cTR hover-enable">

                                <div class="code leading">
                                    <div class="highlight"><pre><code class=language-ballerina>    resource function onText(http:WebSocketCaller caller, string text,
                                boolean finalFrame) {
</code></pre></div>

                                </div>
                                <div class="docs">
                                    
                                    <div class="cCodeDesription">
                                        <div>
                                            <p>This resource gets invoked upon receiving a new text frame from a client.</p>

                                        </div>
                                    </div>
                                    
                                </div>
                            </div>
                            
                            <div class="cTR">

                                <div class="code leading">
                                    <div class="highlight"><pre><code class=language-ballerina>        http:WebSocketClient clientEp = getAssociatedClientEndpoint(caller);
        var err = clientEp-&gt;pushText(text, finalFrame);
        if (err is http:WebSocketError) {
            log:printError(&quot;Error occurred when sending text message&quot;, err);
        }
    }
</code></pre></div>

                                </div>
                                <div class="docs">
                                    
                                </div>
                            </div>
                            
                            <div class="cTR hover-enable">

                                <div class="code leading">
                                    <div class="highlight"><pre><code class=language-ballerina>    resource function onError(http:WebSocketCaller caller, error err) {
</code></pre></div>

                                </div>
                                <div class="docs">
                                    
                                    <div class="cCodeDesription">
                                        <div>
                                            <p>This resource gets invoked when an error occurs in the connection.</p>

                                        </div>
                                    </div>
                                    
                                </div>
                            </div>
                            
                            <div class="cTR">

                                <div class="code leading">
                                    <div class="highlight"><pre><code class=language-ballerina>        http:WebSocketClient clientEp = getAssociatedClientEndpoint(caller);
        var e = clientEp-&gt;close(statusCode = 1011, reason = &quot;Unexpected condition&quot;);
        if (e is http:WebSocketError) {
            log:printError(&quot;Error occurred when closing the connection&quot;, e);
        }
        log:printError(&quot;Unexpected error hence closing the connection&quot;, e);
    }
</code></pre></div>

                                </div>
                                <div class="docs">
                                    
                                </div>
                            </div>
                            
                            <div class="cTR hover-enable">

                                <div class="code leading">
                                    <div class="highlight"><pre><code class=language-ballerina>    resource function onClose(http:WebSocketCaller caller, int statusCode,
                                 string reason) {
</code></pre></div>

                                </div>
                                <div class="docs">
                                    
                                    <div class="cCodeDesription">
                                        <div>
                                            <p>This resource gets invoked when a client connection is closed from the client side.</p>

                                        </div>
                                    </div>
                                    
                                </div>
                            </div>
                            
                            <div class="cTR">

                                <div class="code leading">
                                    <div class="highlight"><pre><code class=language-ballerina>        http:WebSocketClient clientEp = getAssociatedClientEndpoint(caller);
        var err = clientEp-&gt;close(statusCode = statusCode, reason = reason);
        if (err is http:WebSocketError) {
            log:printError(&quot;Error occurred when closing the connection&quot;, err);
        }
    }
}
</code></pre></div>

                                </div>
                                <div class="docs">
                                    
                                </div>
                            </div>
                            
                            <div class="cTR hover-enable">

                                <div class="code leading">
                                    <div class="highlight"><pre><code class=language-ballerina>service retryClientService = @http:WebSocketServiceConfig {} service {
</code></pre></div>

                                </div>
                                <div class="docs">
                                    
                                    <div class="cCodeDesription">
                                        <div>
                                            <p>Client service to receive frames from the remote server.</p>

                                        </div>
                                    </div>
                                    
                                </div>
                            </div>
                            
                            <div class="cTR hover-enable">

                                <div class="code leading">
                                    <div class="highlight"><pre><code class=language-ballerina>    resource function onText(http:WebSocketClient caller, string text,
                                boolean finalFrame) {
</code></pre></div>

                                </div>
                                <div class="docs">
                                    
                                    <div class="cCodeDesription">
                                        <div>
                                            <p>This resource gets invoked upon receiving a new text frame from
 the remote backend.</p>

                                        </div>
                                    </div>
                                    
                                </div>
                            </div>
                            
                            <div class="cTR">

                                <div class="code leading">
                                    <div class="highlight"><pre><code class=language-ballerina>        http:WebSocketCaller serverEp = getAssociatedServerEndpoint(caller);
        var err = serverEp-&gt;pushText(text, finalFrame);
        if (err is http:WebSocketError) {
            log:printError(&quot;Error occurred when sending text message&quot;, err);
        }
    }
</code></pre></div>

                                </div>
                                <div class="docs">
                                    
                                </div>
                            </div>
                            
                            <div class="cTR hover-enable">

                                <div class="code leading">
                                    <div class="highlight"><pre><code class=language-ballerina>    resource function onError(http:WebSocketClient caller, error err) {
</code></pre></div>

                                </div>
                                <div class="docs">
                                    
                                    <div class="cCodeDesription">
                                        <div>
                                            <p>This resource gets invoked when an error occurs in the connection.</p>

                                        </div>
                                    </div>
                                    
                                </div>
                            </div>
                            
                            <div class="cTR">

                                <div class="code leading">
                                    <div class="highlight"><pre><code class=language-ballerina>        http:WebSocketCaller serverEp = getAssociatedServerEndpoint(caller);
        var e = serverEp-&gt;close(statusCode = 1011, reason = &quot;Unexpected condition&quot;);
        if (e is http:WebSocketError) {
            log:printError(&quot;Error occurred when closing the connection&quot;,
            err = e);
        }
        log:printError(&quot;Unexpected error hense closing the connection&quot;, err);
    }
</code></pre></div>

                                </div>
                                <div class="docs">
                                    
                                </div>
                            </div>
                            
                            <div class="cTR hover-enable">

                                <div class="code leading">
                                    <div class="highlight"><pre><code class=language-ballerina>    resource function onClose(http:WebSocketClient caller, int statusCode,
                                 string reason) {
</code></pre></div>

                                </div>
                                <div class="docs">
                                    
                                    <div class="cCodeDesription">
                                        <div>
                                            <p>This resource gets invoked when a client connection is closed by
 the remote backend.</p>

                                        </div>
                                    </div>
                                    
                                </div>
                            </div>
                            
                            <div class="cTR">

                                <div class="code leading">
                                    <div class="highlight"><pre><code class=language-ballerina>        http:WebSocketCaller serverEp = getAssociatedServerEndpoint(caller);
        var err = serverEp-&gt;close(statusCode = statusCode, reason = reason);
        if (err is http:WebSocketError) {
            log:printError(&quot;Error occurred when closing the connection&quot;, err);
        }
    }
};
</code></pre></div>

                                </div>
                                <div class="docs">
                                    
                                </div>
                            </div>
                            
                            <div class="cTR hover-enable">

                                <div class="code leading">
                                    <div class="highlight"><pre><code class=language-ballerina>function getAssociatedClientEndpoint(http:WebSocketCaller ep)
                returns (http:WebSocketClient) {
    http:WebSocketClient wsClient = &lt;http:WebSocketClient&gt;ep.
    getAttribute(ASSOCIATED_CONNECTION);
    return wsClient;
}
</code></pre></div>

                                </div>
                                <div class="docs">
                                    
                                    <div class="cCodeDesription">
                                        <div>
                                            <p>Function to retrieve the associated client of a particular caller.</p>

                                        </div>
                                    </div>
                                    
                                </div>
                            </div>
                            
                            <div class="cTR hover-enable">

                                <div class="code">
                                    <div class="highlight"><pre><code class=language-ballerina>function getAssociatedServerEndpoint(http:WebSocketClient ep)
                returns (http:WebSocketCaller) {
    http:WebSocketCaller wsEndpoint = &lt;http:WebSocketCaller&gt;ep.
    getAttribute(ASSOCIATED_CONNECTION);
    return wsEndpoint;
}
</code></pre></div>

                                </div>
                                <div class="docs">
                                    
                                    <div class="cCodeDesription">
                                        <div>
                                            <p>Function to retrieve the associated caller of a client.</p>

                                        </div>
                                    </div>
                                    
                                </div>
                            </div>
                            
                        </div>
                    </div>
                    
                    <div class="codeSnippeset">

                        <div class="cBBE-body">
                            
                            <div class="cTR cOutputTr">

                                <div class="code leading cOutput">
                                    <div class="highlight"><pre><code class=shell-session># To start the service, navigate to the directory that contains the
# `.bal` file and execute the `ballerina run` command.
</code></pre></div>

                                </div>
                                <div class="docs">
                                    
                                </div>
                            </div>
                            
                            <div class="cTR cOutputTr">

                                <div class="code leading cOutput">
                                    <div class="highlight"><pre><code class=shell-session>ballerina run websocket_service.bal
[ballerina/http] started HTTP/WS listener 0.0.0.0:9095
ballerina run websocket_retry.bal
[ballerina/http] started HTTP/WS listener 0.0.0.0:9090
</code></pre></div>

                                </div>
                                <div class="docs">
                                    
                                </div>
                            </div>
                            
                            <div class="cTR cOutputTr">

                                <div class="code leading cOutput">
                                    <div class="highlight"><pre><code class=shell-session># Now, this service can be invoked by any WebSocket client using the URL: &quot;ws://localhost:9090/retry/ws&quot;.
</code></pre></div>

                                </div>
                                <div class="docs">
                                    
                                </div>
                            </div>
                            
                            <div class="cTR cOutputTr">

                                <div class="code leading cOutput">
                                    <div class="highlight"><pre><code class=shell-session># To check the sample, you can use Chrome or Firefox JavaScript console and run the following commands. &lt;br&gt;
var ws = new WebSocket(&quot;ws://localhost:9090/retry/ws&quot;);
ws.onmessage = function(frame) {console.log(frame.data)};
ws.onclose = function(frame) {console.log(frame)};
</code></pre></div>

                                </div>
                                <div class="docs">
                                    
                                </div>
                            </div>
                            
                            <div class="cTR cOutputTr">

                                <div class="code leading cOutput">
                                    <div class="highlight"><pre><code class=shell-session># Send messages.
ws.send(&quot;hello world&quot;);
</code></pre></div>

                                </div>
                                <div class="docs">
                                    
                                </div>
                            </div>
                            
                            <div class="cTR cOutputTr">

                                <div class="code leading cOutput">
                                    <div class="highlight"><pre><code class=shell-session># To stop the running service, press Ctrl + C.
# Restart the service.
</code></pre></div>

                                </div>
                                <div class="docs">
                                    
                                </div>
                            </div>
                            
                            <div class="cTR cOutputTr">

                                <div class="code leading cOutput">
                                    <div class="highlight"><pre><code class=shell-session># Send messages.
ws.send(&quot;hello world&quot;);
</code></pre></div>

                                </div>
                                <div class="docs">
                                    
                                </div>
                            </div>
                            
                            <div class="cTR cOutputTr">

                                <div class="code cOutput">
                                    <div class="highlight"><pre><code class=shell-session># Close the connection.
ws.close(1000, &quot;I want to go&quot;);
</code></pre></div>

                                </div>
                                <div class="docs">
                                    
                                </div>
                            </div>
                            
                        </div>
                    </div>
                    
                    <div class="codeSnippeset">

                        <div class="cBBE-body">
                            
                            <div class="cTR">

                                <div class="code leading">
                                    <div class="highlight"><pre><code class=language-ballerina>import ballerina/http;
import ballerina/log;
</code></pre></div>

                                </div>
                                <div class="docs">
                                    
                                </div>
                            </div>
                            
                            <div class="cTR hover-enable">

                                <div class="code leading">
                                    <div class="highlight"><pre><code class=language-ballerina>@http:WebSocketServiceConfig {
    path: &quot;/retry/ws&quot;
}
</code></pre></div>

                                </div>
                                <div class="docs">
                                    
                                    <div class="cCodeDesription">
                                        <div>
                                            <p>The annotation which is used to configure a WebSocket service.</p>

                                        </div>
                                    </div>
                                    
                                </div>
                            </div>
                            
                            <div class="cTR hover-enable">

                                <div class="code leading">
                                    <div class="highlight"><pre><code class=language-ballerina>service server on new http:Listener(9095) {
</code></pre></div>

                                </div>
                                <div class="docs">
                                    
                                    <div class="cCodeDesription">
                                        <div>
                                            <p>Define the backend service with port 9095, which is called by the client.</p>

                                        </div>
                                    </div>
                                    
                                </div>
                            </div>
                            
                            <div class="cTR hover-enable">

                                <div class="code leading">
                                    <div class="highlight"><pre><code class=language-ballerina>    resource function onOpen(http:WebSocketCaller caller) {
        log:printInfo(&quot;WebSocket client connected wih the server. &quot; +
        &quot;The Connection ID: &quot; + caller.getConnectionId());
    }
</code></pre></div>

                                </div>
                                <div class="docs">
                                    
                                    <div class="cCodeDesription">
                                        <div>
                                            <p>This resource gets invoked when a new client connects.
 Since messages to the server are not read by the service
 until the execution of the <code>onOpen</code> resource finishes,
 operations which should happen before reading messages should be
 done in the <code>onOpen</code> resource.</p>

                                        </div>
                                    </div>
                                    
                                </div>
                            </div>
                            
                            <div class="cTR hover-enable">

                                <div class="code">
                                    <div class="highlight"><pre><code class=language-ballerina>    resource function onText(http:WebSocketCaller caller, string text,
                                boolean finalFrame) {
        var err = caller-&gt;pushText(text, finalFrame);
        if (err is http:WebSocketError) {
            log:printError(&quot;Error occurred when sending text message&quot;, err);
        }
    }
}
</code></pre></div>

                                </div>
                                <div class="docs">
                                    
                                    <div class="cCodeDesription">
                                        <div>
                                            <p>This resource gets invoked when a server is receiving
 a text message from the client.</p>

                                        </div>
                                    </div>
                                    
                                </div>
                            </div>
                            
                        </div>
                    </div>
                    
                    <div class="codeSnippeset">

                        <div class="cBBE-body">
                            
                            <div class="cTR cOutputTr">

                                <div class="code leading cOutput">
                                    <div class="highlight"><pre><code class=shell-session># To start the service, navigate to the directory that contains the
# `.bal` file, and use the `ballerina run` command.
ballerina run webSocket_service.bal
</code></pre></div>

                                </div>
                                <div class="docs">
                                    
                                </div>
                            </div>
                            
                            <div class="cTR cOutputTr">

                                <div class="code leading cOutput">
                                    <div class="highlight"><pre><code class=shell-session>[ballerina/http] started HTTP/WS listener 0.0.0.0:9095
2019-11-20 13:31:38,842 INFO  [] - WebSocket client connected wih the server. The Connection ID: 08d40cfffe258b13-00000bfd-00000001-a1eade696304c59e-7f64181e
</code></pre></div>

                                </div>
                                <div class="docs">
                                    
                                </div>
                            </div>
                            
                            <div class="cTR cOutputTr">

                                <div class="code leading cOutput">
                                    <div class="highlight"><pre><code class=shell-session># Stop the running service.
[ballerina/http] stopped HTTP/WS listener 0.0.0.0:9095
</code></pre></div>

                                </div>
                                <div class="docs">
                                    
                                </div>
                            </div>
                            
                            <div class="cTR cOutputTr">

                                <div class="code leading cOutput">
                                    <div class="highlight"><pre><code class=shell-session># Restart the service.
ballerina run websocket_service.bal
</code></pre></div>

                                </div>
                                <div class="docs">
                                    
                                </div>
                            </div>
                            
                            <div class="cTR cOutputTr">

                                <div class="code cOutput">
                                    <div class="highlight"><pre><code class=shell-session>[ballerina/http] started HTTP/WS listener 0.0.0.0:9095
2019-11-20 13:34:55,543 INFO  [] - WebSocket client connected wih the server. The Connection ID: 08d40cfffe258b13-0000118b-00000001-9bc9b9fb2d07c5b5-8fb73e4f
</code></pre></div>

                                </div>
                                <div class="docs">
                                    
                                </div>
                            </div>
                            
                        </div>
                    </div>
                    


                     
                </div>
            </div>
        </div>
    </div>

     <script>
            $(document).ready(function() {

                // hljs.initHighlightingOnLoad();

                $(".switch").click(function() {
                    $(".cCodeRight").toggleClass('cShow');
                    $(".cCodeLeft").toggleClass('cHide');
                });

                // register "copy to clipboard" event to elements with "copy" class
                var clipboard = new ClipboardJS('.copy', {
                    text: function(trigger) {
                        return $('.FullCode').find('pre').text();
                    }
                });

                // Register events show hide tooltip on click event
                clipboard.on('success', function(e) {
                    setTooltip(e.trigger, 'Copied!');
                    hideTooltip(e.trigger);
                });

                clipboard.on('error', function(e) {
                    setTooltip(e.trigger, 'Failed!');
                    hideTooltip(e.trigger);
                });

                $('.copy').tooltip({
                    trigger: 'click',
                    placement: 'bottom'
                });
                $("a.copy").unbind("click");
            });

            function setTooltip(btn, message) {
                $(btn).attr('data-original-title', message)
                    .tooltip('show');
            }

            function hideTooltip(btn) {
                setTimeout(function() {
                    $(btn).tooltip('hide').removeAttr('data-original-title');
                }, 1000);
            }
        </script>
