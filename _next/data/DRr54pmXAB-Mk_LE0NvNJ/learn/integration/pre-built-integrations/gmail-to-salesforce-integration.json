{"pageProps":{"samples":{"code":"<pre class=\"shiki github-light\" style=\"background-color:#fff;color:#24292e\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color:#D73A49\">import</span><span style=\"color:#24292E\"> ballerina/lang.runtime;</span></span>\n<span class=\"line\"><span style=\"color:#D73A49\">import</span><span style=\"color:#24292E\"> ballerina/log;</span></span>\n<span class=\"line\"><span style=\"color:#D73A49\">import</span><span style=\"color:#24292E\"> ballerina/mime;</span></span>\n<span class=\"line\"><span style=\"color:#D73A49\">import</span><span style=\"color:#24292E\"> ballerinax/googleapis.gmail;</span></span>\n<span class=\"line\"><span style=\"color:#D73A49\">import</span><span style=\"color:#24292E\"> ballerinax/openai.chat;</span></span>\n<span class=\"line\"><span style=\"color:#D73A49\">import</span><span style=\"color:#24292E\"> ballerinax/salesforce </span><span style=\"color:#D73A49\">as</span><span style=\"color:#24292E\"> sf;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#D73A49\">type</span><span style=\"color:#6F42C1\"> Email</span><span style=\"color:#D73A49\"> record</span><span style=\"color:#24292E\"> {</span><span style=\"color:#D73A49\">|</span></span>\n<span class=\"line\"><span style=\"color:#005CC5\">    string</span><span style=\"color:#24292E\"> 'from;</span></span>\n<span class=\"line\"><span style=\"color:#005CC5\">    string</span><span style=\"color:#24292E\"> subject;</span></span>\n<span class=\"line\"><span style=\"color:#005CC5\">    string</span><span style=\"color:#24292E\"> body;</span></span>\n<span class=\"line\"><span style=\"color:#D73A49\">|</span><span style=\"color:#24292E\">};</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#D73A49\">type</span><span style=\"color:#6F42C1\"> Name</span><span style=\"color:#D73A49\"> record</span><span style=\"color:#24292E\"> {</span><span style=\"color:#D73A49\">|</span></span>\n<span class=\"line\"><span style=\"color:#005CC5\">    string</span><span style=\"color:#24292E\"> firstName__c;</span></span>\n<span class=\"line\"><span style=\"color:#005CC5\">    string</span><span style=\"color:#24292E\"> lastName__c;</span></span>\n<span class=\"line\"><span style=\"color:#D73A49\">|</span><span style=\"color:#24292E\">};</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#D73A49\">type</span><span style=\"color:#6F42C1\"> Lead</span><span style=\"color:#D73A49\"> record</span><span style=\"color:#24292E\"> {</span><span style=\"color:#D73A49\">|</span></span>\n<span class=\"line\"><span style=\"color:#D73A49\">    *</span><span style=\"color:#24292E\">Name;</span></span>\n<span class=\"line\"><span style=\"color:#005CC5\">    string</span><span style=\"color:#24292E\"> email__c;</span></span>\n<span class=\"line\"><span style=\"color:#005CC5\">    string</span><span style=\"color:#24292E\"> phoneNumber__c;</span></span>\n<span class=\"line\"><span style=\"color:#005CC5\">    string</span><span style=\"color:#24292E\"> company__c;</span></span>\n<span class=\"line\"><span style=\"color:#005CC5\">    string</span><span style=\"color:#24292E\"> designation__c;</span></span>\n<span class=\"line\"><span style=\"color:#D73A49\">|</span><span style=\"color:#24292E\">};</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#D73A49\">configurable</span><span style=\"color:#005CC5\"> string</span><span style=\"color:#24292E\"> gmailAccessToken </span><span style=\"color:#D73A49\">=</span><span style=\"color:#D73A49\"> ?</span><span style=\"color:#24292E\">;</span></span>\n<span class=\"line\"><span style=\"color:#D73A49\">configurable</span><span style=\"color:#005CC5\"> string</span><span style=\"color:#24292E\"> openAIKey </span><span style=\"color:#D73A49\">=</span><span style=\"color:#D73A49\"> ?</span><span style=\"color:#24292E\">;</span></span>\n<span class=\"line\"><span style=\"color:#D73A49\">configurable</span><span style=\"color:#005CC5\"> string</span><span style=\"color:#24292E\"> salesforceBaseUrl </span><span style=\"color:#D73A49\">=</span><span style=\"color:#D73A49\"> ?</span><span style=\"color:#24292E\">;</span></span>\n<span class=\"line\"><span style=\"color:#D73A49\">configurable</span><span style=\"color:#005CC5\"> string</span><span style=\"color:#24292E\"> salesforceAccessToken </span><span style=\"color:#D73A49\">=</span><span style=\"color:#D73A49\"> ?</span><span style=\"color:#24292E\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#D73A49\">const </span><span style=\"color:#005CC5\">LABEL</span><span style=\"color:#D73A49\"> =</span><span style=\"color:#032F62\"> \"Lead\"</span><span style=\"color:#24292E\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#D73A49\">final</span><span style=\"color:#24292E\"> gmail</span><span style=\"color:#D73A49\">:</span><span style=\"color:#24292E\">Client gmail </span><span style=\"color:#D73A49\">=</span><span style=\"color:#D73A49\"> check</span><span style=\"color:#D73A49\"> new</span><span style=\"color:#24292E\"> ({auth</span><span style=\"color:#D73A49\">:</span><span style=\"color:#24292E\"> {token: gmailAccessToken}});</span></span>\n<span class=\"line\"><span style=\"color:#D73A49\">final</span><span style=\"color:#24292E\"> chat</span><span style=\"color:#D73A49\">:</span><span style=\"color:#24292E\">Client openAiChat </span><span style=\"color:#D73A49\">=</span><span style=\"color:#D73A49\"> check</span><span style=\"color:#D73A49\"> new</span><span style=\"color:#24292E\"> ({auth</span><span style=\"color:#D73A49\">:</span><span style=\"color:#24292E\"> {token: openAIKey}});</span></span>\n<span class=\"line\"><span style=\"color:#D73A49\">final</span><span style=\"color:#24292E\"> sf</span><span style=\"color:#D73A49\">:</span><span style=\"color:#24292E\">Client salesforce </span><span style=\"color:#D73A49\">=</span><span style=\"color:#D73A49\"> check</span><span style=\"color:#D73A49\"> new</span><span style=\"color:#24292E\"> ({baseUrl</span><span style=\"color:#D73A49\">:</span><span style=\"color:#24292E\"> salesforceBaseUrl, auth</span><span style=\"color:#D73A49\">:</span><span style=\"color:#24292E\"> {token: salesforceAccessToken}});</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#D73A49\">public</span><span style=\"color:#D73A49\"> function</span><span style=\"color:#6F42C1\"> main</span><span style=\"color:#24292E\">() </span><span style=\"color:#D73A49\">returns</span><span style=\"color:#D73A49\"> error?</span><span style=\"color:#24292E\"> {</span></span>\n<span class=\"line\"><span style=\"color:#D73A49\">    while</span><span style=\"color:#D73A49\"> true</span><span style=\"color:#24292E\"> {</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">        Email[] emails </span><span style=\"color:#D73A49\">=</span><span style=\"color:#D73A49\"> check</span><span style=\"color:#6F42C1\"> getEmails</span><span style=\"color:#24292E\">(</span><span style=\"color:#E36209\">LABEL</span><span style=\"color:#24292E\">);</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">        Lead[] leads </span><span style=\"color:#D73A49\">=</span><span style=\"color:#D73A49\"> from</span><span style=\"color:#24292E\"> Email email </span><span style=\"color:#D73A49\">in</span><span style=\"color:#24292E\"> emails</span></span>\n<span class=\"line\"><span style=\"color:#D73A49\">                       let</span><span style=\"color:#24292E\"> Lead</span><span style=\"color:#D73A49\">?</span><span style=\"color:#24292E\"> lead </span><span style=\"color:#D73A49\">=</span><span style=\"color:#6F42C1\"> generateLead</span><span style=\"color:#24292E\">(</span><span style=\"color:#E36209\">email</span><span style=\"color:#24292E\">)</span></span>\n<span class=\"line\"><span style=\"color:#D73A49\">                       where</span><span style=\"color:#24292E\"> lead </span><span style=\"color:#D73A49\">is</span><span style=\"color:#24292E\"> Lead</span></span>\n<span class=\"line\"><span style=\"color:#D73A49\">                       select</span><span style=\"color:#24292E\"> lead;</span></span>\n<span class=\"line\"><span style=\"color:#6F42C1\">        addLeadsToSalesforce</span><span style=\"color:#24292E\">(</span><span style=\"color:#E36209\">leads</span><span style=\"color:#24292E\">);</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">        runtime</span><span style=\"color:#D73A49\">:</span><span style=\"color:#6F42C1\">sleep</span><span style=\"color:#24292E\">(</span><span style=\"color:#005CC5\">600</span><span style=\"color:#24292E\">);</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">    }</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#D73A49\">function</span><span style=\"color:#6F42C1\"> getEmails</span><span style=\"color:#24292E\">(</span><span style=\"color:#005CC5\">string</span><span style=\"color:#E36209\"> label</span><span style=\"color:#24292E\">) </span><span style=\"color:#D73A49\">returns</span><span style=\"color:#24292E\"> Email[]</span><span style=\"color:#D73A49\">|error</span><span style=\"color:#24292E\"> {</span></span>\n<span class=\"line\"><span style=\"color:#005CC5\">    string</span><span style=\"color:#24292E\">[] labelIdsToMatch </span><span style=\"color:#D73A49\">=</span><span style=\"color:#D73A49\"> check</span><span style=\"color:#6F42C1\"> getLabelIds</span><span style=\"color:#24292E\">(</span><span style=\"color:#E36209\">gmail</span><span style=\"color:#24292E\">, [label]);</span></span>\n<span class=\"line\"><span style=\"color:#D73A49\">    if</span><span style=\"color:#24292E\"> labelIdsToMatch.</span><span style=\"color:#6F42C1\">length</span><span style=\"color:#24292E\">() </span><span style=\"color:#D73A49\">==</span><span style=\"color:#005CC5\"> 0</span><span style=\"color:#24292E\"> {</span></span>\n<span class=\"line\"><span style=\"color:#D73A49\">        return</span><span style=\"color:#D73A49\"> error</span><span style=\"color:#24292E\">(</span><span style=\"color:#032F62\">\"Unable to find any labels to match.\"</span><span style=\"color:#24292E\">);</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">    }</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#24292E\">    gmail</span><span style=\"color:#D73A49\">:</span><span style=\"color:#24292E\">MailThread[] matchingMailThreads </span><span style=\"color:#D73A49\">=</span><span style=\"color:#D73A49\"> check</span><span style=\"color:#6F42C1\"> getMatchingMailThreads</span><span style=\"color:#24292E\">(</span><span style=\"color:#E36209\">gmail</span><span style=\"color:#24292E\">, </span><span style=\"color:#E36209\">labelIdsToMatch</span><span style=\"color:#24292E\">);</span></span>\n<span class=\"line\"><span style=\"color:#6F42C1\">    removeLabels</span><span style=\"color:#24292E\">(</span><span style=\"color:#E36209\">gmail</span><span style=\"color:#24292E\">, </span><span style=\"color:#E36209\">matchingMailThreads</span><span style=\"color:#24292E\">, </span><span style=\"color:#E36209\">labelIdsToMatch</span><span style=\"color:#24292E\">);</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">    gmail</span><span style=\"color:#D73A49\">:</span><span style=\"color:#24292E\">Message[] matchingEmails </span><span style=\"color:#D73A49\">=</span><span style=\"color:#6F42C1\"> getMatchingEmails</span><span style=\"color:#24292E\">(</span><span style=\"color:#E36209\">gmail</span><span style=\"color:#24292E\">, </span><span style=\"color:#E36209\">matchingMailThreads</span><span style=\"color:#24292E\">);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#D73A49\">    return</span><span style=\"color:#D73A49\"> from</span><span style=\"color:#24292E\"> gmail</span><span style=\"color:#D73A49\">:</span><span style=\"color:#24292E\">Message message </span><span style=\"color:#D73A49\">in</span><span style=\"color:#24292E\"> matchingEmails</span></span>\n<span class=\"line\"><span style=\"color:#D73A49\">           let</span><span style=\"color:#24292E\"> Email</span><span style=\"color:#D73A49\">|error</span><span style=\"color:#24292E\"> email </span><span style=\"color:#D73A49\">=</span><span style=\"color:#6F42C1\"> parseEmail</span><span style=\"color:#24292E\">(</span><span style=\"color:#E36209\">message</span><span style=\"color:#24292E\">)</span></span>\n<span class=\"line\"><span style=\"color:#D73A49\">           where</span><span style=\"color:#24292E\"> email </span><span style=\"color:#D73A49\">is</span><span style=\"color:#24292E\"> Email</span></span>\n<span class=\"line\"><span style=\"color:#D73A49\">           select</span><span style=\"color:#24292E\"> email;</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#D73A49\">function</span><span style=\"color:#6F42C1\"> getLabelIds</span><span style=\"color:#24292E\">(</span><span style=\"color:#E36209\">gmail</span><span style=\"color:#D73A49\">:</span><span style=\"color:#24292E\">Client gmail, </span><span style=\"color:#005CC5\">string</span><span style=\"color:#24292E\">[] </span><span style=\"color:#E36209\">labelsToMatch</span><span style=\"color:#24292E\">) </span><span style=\"color:#D73A49\">returns</span><span style=\"color:#005CC5\"> string</span><span style=\"color:#24292E\">[]</span><span style=\"color:#D73A49\">|error</span><span style=\"color:#24292E\"> {</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">    gmail</span><span style=\"color:#D73A49\">:</span><span style=\"color:#24292E\">LabelList labelList </span><span style=\"color:#D73A49\">=</span><span style=\"color:#D73A49\"> check</span><span style=\"color:#24292E\"> gmail</span><span style=\"color:#D73A49\">-></span><span style=\"color:#6F42C1\">listLabels</span><span style=\"color:#24292E\">(</span><span style=\"color:#032F62\">\"me\"</span><span style=\"color:#24292E\">);</span></span>\n<span class=\"line\"><span style=\"color:#D73A49\">    return</span><span style=\"color:#D73A49\"> from</span><span style=\"color:#24292E\"> gmail</span><span style=\"color:#D73A49\">:</span><span style=\"color:#24292E\">Label {name, id} </span><span style=\"color:#D73A49\">in</span><span style=\"color:#24292E\"> labelList.labels</span></span>\n<span class=\"line\"><span style=\"color:#D73A49\">           where</span><span style=\"color:#24292E\"> labelsToMatch.</span><span style=\"color:#6F42C1\">indexOf</span><span style=\"color:#24292E\">(</span><span style=\"color:#E36209\">name</span><span style=\"color:#24292E\">) </span><span style=\"color:#D73A49\">!=</span><span style=\"color:#24292E\"> ()</span></span>\n<span class=\"line\"><span style=\"color:#D73A49\">           select</span><span style=\"color:#24292E\"> id;</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#D73A49\">function</span><span style=\"color:#6F42C1\"> getMatchingMailThreads</span><span style=\"color:#24292E\">(</span><span style=\"color:#E36209\">gmail</span><span style=\"color:#D73A49\">:</span><span style=\"color:#24292E\">Client gmail, </span><span style=\"color:#005CC5\">string</span><span style=\"color:#24292E\">[] </span><span style=\"color:#E36209\">labelIdsToMatch</span><span style=\"color:#24292E\">) </span><span style=\"color:#D73A49\">returns</span><span style=\"color:#24292E\"> gmail</span><span style=\"color:#D73A49\">:</span><span style=\"color:#24292E\">MailThread[]</span><span style=\"color:#D73A49\">|error</span><span style=\"color:#24292E\"> {</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">    gmail</span><span style=\"color:#D73A49\">:</span><span style=\"color:#24292E\">MsgSearchFilter searchFilter </span><span style=\"color:#D73A49\">=</span><span style=\"color:#24292E\"> {</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">        includeSpamTrash</span><span style=\"color:#D73A49\">:</span><span style=\"color:#005CC5\"> false</span><span style=\"color:#24292E\">,</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">        labelIds</span><span style=\"color:#D73A49\">:</span><span style=\"color:#24292E\"> labelIdsToMatch</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">    };</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#D73A49\">    return</span><span style=\"color:#D73A49\"> from</span><span style=\"color:#24292E\"> gmail</span><span style=\"color:#D73A49\">:</span><span style=\"color:#24292E\">MailThread mailThread </span><span style=\"color:#D73A49\">in</span><span style=\"color:#D73A49\"> check</span><span style=\"color:#24292E\"> gmail-</span><span style=\"color:#D73A49\">></span><span style=\"color:#6F42C1\">listThreads</span><span style=\"color:#24292E\">(</span><span style=\"color:#E36209\">filter</span><span style=\"color:#D73A49\"> =</span><span style=\"color:#24292E\"> searchFilter)</span></span>\n<span class=\"line\"><span style=\"color:#D73A49\">           select</span><span style=\"color:#24292E\"> mailThread;</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#D73A49\">function</span><span style=\"color:#6F42C1\"> removeLabels</span><span style=\"color:#24292E\">(</span><span style=\"color:#E36209\">gmail</span><span style=\"color:#D73A49\">:</span><span style=\"color:#24292E\">Client gmail, </span><span style=\"color:#E36209\">gmail</span><span style=\"color:#D73A49\">:</span><span style=\"color:#24292E\">MailThread[] mailThreads, </span><span style=\"color:#005CC5\">string</span><span style=\"color:#24292E\">[] </span><span style=\"color:#E36209\">labelIds</span><span style=\"color:#24292E\">) {</span></span>\n<span class=\"line\"><span style=\"color:#D73A49\">    foreach </span><span style=\"color:#24292E\">gmail</span><span style=\"color:#D73A49\">:</span><span style=\"color:#24292E\">MailThread mailThread </span><span style=\"color:#D73A49\">in</span><span style=\"color:#24292E\"> mailThreads {</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">        gmail</span><span style=\"color:#D73A49\">:</span><span style=\"color:#24292E\">MailThread</span><span style=\"color:#D73A49\">|error</span><span style=\"color:#24292E\"> removeLabelResponse </span><span style=\"color:#D73A49\">=</span><span style=\"color:#24292E\"> gmail</span><span style=\"color:#D73A49\">-></span><span style=\"color:#6F42C1\">modifyThread</span><span style=\"color:#24292E\">(mailThread.id, [], </span><span style=\"color:#E36209\">labelIds</span><span style=\"color:#24292E\">);</span></span>\n<span class=\"line\"><span style=\"color:#D73A49\">        if</span><span style=\"color:#24292E\"> removeLabelResponse </span><span style=\"color:#D73A49\">is</span><span style=\"color:#D73A49\"> error</span><span style=\"color:#24292E\"> {</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">            log</span><span style=\"color:#D73A49\">:</span><span style=\"color:#6F42C1\">printError</span><span style=\"color:#24292E\">(</span><span style=\"color:#032F62\">\"An error occured in removing the labels from the thread.\"</span><span style=\"color:#24292E\">,</span></span>\n<span class=\"line\"><span style=\"color:#E36209\">                removeLabelResponse</span><span style=\"color:#24292E\">, removeLabelResponse.</span><span style=\"color:#6F42C1\">stackTrace</span><span style=\"color:#24292E\">(), </span><span style=\"color:#E36209\">threadId</span><span style=\"color:#D73A49\"> =</span><span style=\"color:#24292E\"> mailThread.id, </span><span style=\"color:#E36209\">labelIds</span><span style=\"color:#D73A49\"> =</span><span style=\"color:#24292E\"> labelIds);</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">        }</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">    }</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#D73A49\">function</span><span style=\"color:#6F42C1\"> getMatchingEmails</span><span style=\"color:#24292E\">(</span><span style=\"color:#E36209\">gmail</span><span style=\"color:#D73A49\">:</span><span style=\"color:#24292E\">Client gmail, </span><span style=\"color:#E36209\">gmail</span><span style=\"color:#D73A49\">:</span><span style=\"color:#24292E\">MailThread[] mailThreads) </span><span style=\"color:#D73A49\">returns</span><span style=\"color:#24292E\"> gmail</span><span style=\"color:#D73A49\">:</span><span style=\"color:#24292E\">Message[] {</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">    gmail</span><span style=\"color:#D73A49\">:</span><span style=\"color:#24292E\">Message[] messages </span><span style=\"color:#D73A49\">=</span><span style=\"color:#24292E\"> [];</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#D73A49\">    foreach </span><span style=\"color:#24292E\">gmail</span><span style=\"color:#D73A49\">:</span><span style=\"color:#24292E\">MailThread mailThread </span><span style=\"color:#D73A49\">in</span><span style=\"color:#24292E\"> mailThreads {</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">        gmail</span><span style=\"color:#D73A49\">:</span><span style=\"color:#24292E\">MailThread</span><span style=\"color:#D73A49\">|error</span><span style=\"color:#24292E\"> response </span><span style=\"color:#D73A49\">=</span><span style=\"color:#24292E\"> gmail</span><span style=\"color:#D73A49\">-></span><span style=\"color:#6F42C1\">readThread</span><span style=\"color:#24292E\">(mailThread.id);</span></span>\n<span class=\"line\"><span style=\"color:#D73A49\">        if</span><span style=\"color:#24292E\"> response </span><span style=\"color:#D73A49\">is</span><span style=\"color:#D73A49\"> error</span><span style=\"color:#24292E\"> {</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">            log</span><span style=\"color:#D73A49\">:</span><span style=\"color:#6F42C1\">printError</span><span style=\"color:#24292E\">(</span><span style=\"color:#032F62\">\"An error occured while reading the email.\"</span><span style=\"color:#24292E\">, </span></span>\n<span class=\"line\"><span style=\"color:#E36209\">                response</span><span style=\"color:#24292E\">, response.</span><span style=\"color:#6F42C1\">stackTrace</span><span style=\"color:#24292E\">(), </span><span style=\"color:#E36209\">threadId</span><span style=\"color:#D73A49\"> =</span><span style=\"color:#24292E\"> mailThread.id);</span></span>\n<span class=\"line\"><span style=\"color:#D73A49\">            continue</span><span style=\"color:#24292E\">;</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">        }</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#D73A49\">        if</span><span style=\"color:#D73A49\"> !</span><span style=\"color:#24292E\">(response.messages </span><span style=\"color:#D73A49\">is</span><span style=\"color:#E36209\"> gmail</span><span style=\"color:#D73A49\">:</span><span style=\"color:#24292E\">Message[]) </span><span style=\"color:#D73A49\">||</span><span style=\"color:#24292E\"> (</span><span style=\"color:#D73A49\">&#x3C;</span><span style=\"color:#E36209\">gmail</span><span style=\"color:#D73A49\">:</span><span style=\"color:#24292E\">Message[]</span><span style=\"color:#D73A49\">></span><span style=\"color:#24292E\">response.messages).</span><span style=\"color:#6F42C1\">length</span><span style=\"color:#24292E\">() </span><span style=\"color:#D73A49\">&#x3C;</span><span style=\"color:#005CC5\"> 1</span><span style=\"color:#24292E\"> {</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">            log</span><span style=\"color:#D73A49\">:</span><span style=\"color:#6F42C1\">printError</span><span style=\"color:#24292E\">(</span><span style=\"color:#032F62\">\"Unable to find any messages in the thread.\"</span><span style=\"color:#24292E\">, </span><span style=\"color:#E36209\">threadId</span><span style=\"color:#D73A49\"> =</span><span style=\"color:#24292E\"> mailThread.id);</span></span>\n<span class=\"line\"><span style=\"color:#D73A49\">            continue</span><span style=\"color:#24292E\">;</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">        }</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#24292E\">        messages.</span><span style=\"color:#6F42C1\">push</span><span style=\"color:#24292E\">((</span><span style=\"color:#D73A49\">&#x3C;</span><span style=\"color:#E36209\">gmail</span><span style=\"color:#D73A49\">:</span><span style=\"color:#24292E\">Message[]</span><span style=\"color:#D73A49\">></span><span style=\"color:#24292E\">response.messages)[</span><span style=\"color:#005CC5\">0</span><span style=\"color:#24292E\">]);</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">    }</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#D73A49\">    return</span><span style=\"color:#24292E\"> messages;</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#D73A49\">function</span><span style=\"color:#6F42C1\"> parseEmail</span><span style=\"color:#24292E\">(</span><span style=\"color:#E36209\">gmail</span><span style=\"color:#D73A49\">:</span><span style=\"color:#24292E\">Message message) </span><span style=\"color:#D73A49\">returns</span><span style=\"color:#24292E\"> Email</span><span style=\"color:#D73A49\">|error</span><span style=\"color:#24292E\"> {</span></span>\n<span class=\"line\"><span style=\"color:#D73A49\">    do</span><span style=\"color:#24292E\"> {</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">        gmail</span><span style=\"color:#D73A49\">:</span><span style=\"color:#24292E\">MessageBodyPart bodyPart </span><span style=\"color:#D73A49\">=</span><span style=\"color:#D73A49\"> check</span><span style=\"color:#24292E\"> message.emailBodyInText.</span><span style=\"color:#6F42C1\">ensureType</span><span style=\"color:#24292E\">(</span><span style=\"color:#E36209\">gmail</span><span style=\"color:#D73A49\">:</span><span style=\"color:#24292E\">MessageBodyPart);</span></span>\n<span class=\"line\"><span style=\"color:#005CC5\">        string</span><span style=\"color:#24292E\"> bodyPartText </span><span style=\"color:#D73A49\">=</span><span style=\"color:#D73A49\"> check</span><span style=\"color:#24292E\"> bodyPart.data.</span><span style=\"color:#6F42C1\">ensureType</span><span style=\"color:#24292E\">(</span><span style=\"color:#005CC5\">string</span><span style=\"color:#24292E\">);</span></span>\n<span class=\"line\"><span style=\"color:#005CC5\">        string</span><span style=\"color:#24292E\"> body </span><span style=\"color:#D73A49\">=</span><span style=\"color:#D73A49\"> check</span><span style=\"color:#24292E\"> mime</span><span style=\"color:#D73A49\">:</span><span style=\"color:#6F42C1\">base64Decode</span><span style=\"color:#24292E\">(</span><span style=\"color:#E36209\">bodyPartText</span><span style=\"color:#24292E\">).</span><span style=\"color:#6F42C1\">ensureType</span><span style=\"color:#24292E\">(</span><span style=\"color:#005CC5\">string</span><span style=\"color:#24292E\">);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#D73A49\">        return</span><span style=\"color:#24292E\"> {</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">            'from</span><span style=\"color:#D73A49\">:</span><span style=\"color:#D73A49\"> check</span><span style=\"color:#24292E\"> message.headerFrom.</span><span style=\"color:#6F42C1\">ensureType</span><span style=\"color:#24292E\">(</span><span style=\"color:#005CC5\">string</span><span style=\"color:#24292E\">),</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">            subject</span><span style=\"color:#D73A49\">:</span><span style=\"color:#D73A49\"> check</span><span style=\"color:#24292E\"> message.headerSubject.</span><span style=\"color:#6F42C1\">ensureType</span><span style=\"color:#24292E\">(</span><span style=\"color:#005CC5\">string</span><span style=\"color:#24292E\">),</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">            body</span><span style=\"color:#D73A49\">:</span><span style=\"color:#24292E\"> body</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">        };</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">    } </span><span style=\"color:#D73A49\">on</span><span style=\"color:#D73A49\"> fail</span><span style=\"color:#D73A49\"> error</span><span style=\"color:#24292E\"> e {</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">        log</span><span style=\"color:#D73A49\">:</span><span style=\"color:#6F42C1\">printError</span><span style=\"color:#24292E\">(</span><span style=\"color:#032F62\">\"An error occured while parsing the email.\"</span><span style=\"color:#24292E\">, </span><span style=\"color:#E36209\">e</span><span style=\"color:#24292E\">, e.</span><span style=\"color:#6F42C1\">stackTrace</span><span style=\"color:#24292E\">(), </span><span style=\"color:#E36209\">message</span><span style=\"color:#D73A49\"> =</span><span style=\"color:#24292E\"> message);</span></span>\n<span class=\"line\"><span style=\"color:#D73A49\">        return</span><span style=\"color:#24292E\"> e;</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">    }</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#D73A49\">function</span><span style=\"color:#6F42C1\"> generateLead</span><span style=\"color:#24292E\">(</span><span style=\"color:#E36209\">Email</span><span style=\"color:#E36209\"> email</span><span style=\"color:#24292E\">) </span><span style=\"color:#D73A49\">returns</span><span style=\"color:#24292E\"> Lead</span><span style=\"color:#D73A49\">?</span><span style=\"color:#24292E\"> {</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">    chat</span><span style=\"color:#D73A49\">:</span><span style=\"color:#24292E\">CreateChatCompletionRequest request </span><span style=\"color:#D73A49\">=</span><span style=\"color:#24292E\"> {</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">        model</span><span style=\"color:#D73A49\">:</span><span style=\"color:#032F62\"> \"gpt-3.5-turbo\"</span><span style=\"color:#24292E\">,</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">        messages</span><span style=\"color:#D73A49\">:</span><span style=\"color:#24292E\"> [</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">            {</span></span>\n<span class=\"line\"><span style=\"color:#6F42C1\">                role</span><span style=\"color:#24292E\">: </span><span style=\"color:#032F62\">\"user\"</span><span style=\"color:#24292E\">,</span></span>\n<span class=\"line\"><span style=\"color:#6F42C1\">                content</span><span style=\"color:#24292E\">: </span><span style=\"color:#005CC5\">string</span><span style=\"color:#24292E\"> `</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">            Extract the following details in JSON from the email.</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">                {</span></span>\n<span class=\"line\"><span style=\"color:#6F42C1\">                    firstName__c</span><span style=\"color:#24292E\">: </span><span style=\"color:#005CC5\">string</span><span style=\"color:#24292E\">, </span><span style=\"color:#6A737D\">// Mandatory</span></span>\n<span class=\"line\"><span style=\"color:#6F42C1\">                    lastName__c</span><span style=\"color:#24292E\">: </span><span style=\"color:#005CC5\">string</span><span style=\"color:#24292E\">, </span><span style=\"color:#6A737D\">// Mandatory</span></span>\n<span class=\"line\"><span style=\"color:#6F42C1\">                    email__c</span><span style=\"color:#24292E\">: </span><span style=\"color:#005CC5\">string</span><span style=\"color:#6A737D\"> // Mandatory</span></span>\n<span class=\"line\"><span style=\"color:#6F42C1\">                    phoneNumber__c</span><span style=\"color:#24292E\">: </span><span style=\"color:#005CC5\">string</span><span style=\"color:#24292E\">, </span><span style=\"color:#6A737D\">// With country code. Use N/A if unable to find</span></span>\n<span class=\"line\"><span style=\"color:#6F42C1\">                    company__c</span><span style=\"color:#24292E\">: </span><span style=\"color:#005CC5\">string</span><span style=\"color:#24292E\">, </span><span style=\"color:#6A737D\">// Mandatory</span></span>\n<span class=\"line\"><span style=\"color:#6F42C1\">                    designation__c</span><span style=\"color:#24292E\">: </span><span style=\"color:#005CC5\">string</span><span style=\"color:#6A737D\"> // Not mandatory. Use N/A if unable to find</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">                }</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#24292E\">            Here is the </span><span style=\"color:#6F42C1\">email</span><span style=\"color:#24292E\">:    </span></span>\n<span class=\"line\"><span style=\"color:#24292E\">            {</span></span>\n<span class=\"line\"><span style=\"color:#6F42C1\">                from</span><span style=\"color:#24292E\">: ${email.'from},</span></span>\n<span class=\"line\"><span style=\"color:#6F42C1\">                subject</span><span style=\"color:#24292E\">: ${email.subject},</span></span>\n<span class=\"line\"><span style=\"color:#6F42C1\">                body</span><span style=\"color:#24292E\">: ${email.body}</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">            }</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">        `</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">            }</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">        ]</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">    };</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#D73A49\">    do</span><span style=\"color:#24292E\"> {</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">        chat</span><span style=\"color:#D73A49\">:</span><span style=\"color:#24292E\">CreateChatCompletionResponse response </span><span style=\"color:#D73A49\">=</span><span style=\"color:#D73A49\"> check</span><span style=\"color:#24292E\"> openAiChat</span><span style=\"color:#D73A49\">->/</span><span style=\"color:#24292E\">chat</span><span style=\"color:#D73A49\">/</span><span style=\"color:#24292E\">completions.</span><span style=\"color:#6F42C1\">post</span><span style=\"color:#24292E\">(</span><span style=\"color:#E36209\">request</span><span style=\"color:#24292E\">);</span></span>\n<span class=\"line\"><span style=\"color:#D73A49\">        if</span><span style=\"color:#24292E\"> response.choices.</span><span style=\"color:#6F42C1\">length</span><span style=\"color:#24292E\">() </span><span style=\"color:#D73A49\">&#x3C;</span><span style=\"color:#005CC5\"> 1</span><span style=\"color:#24292E\"> {</span></span>\n<span class=\"line\"><span style=\"color:#D73A49\">            check</span><span style=\"color:#D73A49\"> error</span><span style=\"color:#24292E\">(</span><span style=\"color:#032F62\">\"Unable to find any choices in the response.\"</span><span style=\"color:#24292E\">);</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">        }</span></span>\n<span class=\"line\"><span style=\"color:#005CC5\">        string</span><span style=\"color:#24292E\"> content </span><span style=\"color:#D73A49\">=</span><span style=\"color:#D73A49\"> check</span><span style=\"color:#24292E\"> response.choices[</span><span style=\"color:#005CC5\">0</span><span style=\"color:#24292E\">].message?.content.</span><span style=\"color:#6F42C1\">ensureType</span><span style=\"color:#24292E\">(</span><span style=\"color:#005CC5\">string</span><span style=\"color:#24292E\">);</span></span>\n<span class=\"line\"><span style=\"color:#D73A49\">        return</span><span style=\"color:#D73A49\"> check</span><span style=\"color:#24292E\"> content.</span><span style=\"color:#6F42C1\">fromJsonStringWithType</span><span style=\"color:#24292E\">(</span><span style=\"color:#E36209\">Lead</span><span style=\"color:#24292E\">);</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">    } </span><span style=\"color:#D73A49\">on</span><span style=\"color:#D73A49\"> fail</span><span style=\"color:#D73A49\"> error</span><span style=\"color:#24292E\"> e {</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">        log</span><span style=\"color:#D73A49\">:</span><span style=\"color:#6F42C1\">printError</span><span style=\"color:#24292E\">(</span><span style=\"color:#032F62\">\"An error occured while generating the lead.\"</span><span style=\"color:#24292E\">, </span><span style=\"color:#E36209\">e</span><span style=\"color:#24292E\">, e.</span><span style=\"color:#6F42C1\">stackTrace</span><span style=\"color:#24292E\">(), </span><span style=\"color:#E36209\">email</span><span style=\"color:#D73A49\"> =</span><span style=\"color:#24292E\"> email);</span></span>\n<span class=\"line\"><span style=\"color:#D73A49\">        return</span><span style=\"color:#24292E\">;</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">    }</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#D73A49\">function</span><span style=\"color:#6F42C1\"> addLeadsToSalesforce</span><span style=\"color:#24292E\">(</span><span style=\"color:#E36209\">Lead</span><span style=\"color:#24292E\">[] </span><span style=\"color:#E36209\">leads</span><span style=\"color:#24292E\">) {</span></span>\n<span class=\"line\"><span style=\"color:#D73A49\">    from</span><span style=\"color:#24292E\"> Lead lead </span><span style=\"color:#D73A49\">in</span><span style=\"color:#24292E\"> leads</span></span>\n<span class=\"line\"><span style=\"color:#D73A49\">    do</span><span style=\"color:#24292E\"> {</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">        sf</span><span style=\"color:#D73A49\">:</span><span style=\"color:#24292E\">CreationResponse</span><span style=\"color:#D73A49\">|error</span><span style=\"color:#24292E\"> createResponse </span><span style=\"color:#D73A49\">=</span><span style=\"color:#24292E\"> salesforce</span><span style=\"color:#D73A49\">-></span><span style=\"color:#6F42C1\">create</span><span style=\"color:#24292E\">(</span><span style=\"color:#032F62\">\"EmailLead__c\"</span><span style=\"color:#24292E\">, </span><span style=\"color:#E36209\">lead</span><span style=\"color:#24292E\">);</span></span>\n<span class=\"line\"><span style=\"color:#D73A49\">        if</span><span style=\"color:#24292E\"> createResponse </span><span style=\"color:#D73A49\">is</span><span style=\"color:#D73A49\"> error</span><span style=\"color:#24292E\"> {</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">            log</span><span style=\"color:#D73A49\">:</span><span style=\"color:#6F42C1\">printError</span><span style=\"color:#24292E\">(</span><span style=\"color:#032F62\">\"An error occured while creating a Lead object on salesforce.\"</span><span style=\"color:#24292E\">, </span></span>\n<span class=\"line\"><span style=\"color:#E36209\">                createResponse</span><span style=\"color:#24292E\">, createResponse.</span><span style=\"color:#6F42C1\">stackTrace</span><span style=\"color:#24292E\">(), </span><span style=\"color:#E36209\">lead</span><span style=\"color:#D73A49\"> =</span><span style=\"color:#24292E\"> lead);</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">        } </span><span style=\"color:#D73A49\">else</span><span style=\"color:#24292E\"> {</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">            log</span><span style=\"color:#D73A49\">:</span><span style=\"color:#6F42C1\">printInfo</span><span style=\"color:#24292E\">(</span><span style=\"color:#032F62\">\"Lead successfully created.\"</span><span style=\"color:#24292E\">, </span><span style=\"color:#E36209\">lead</span><span style=\"color:#D73A49\"> =</span><span style=\"color:#24292E\"> lead);</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">        }</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">    };</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">}</span></span></code></pre>"},"content":"\nimport ballerina/lang.runtime;\nimport ballerina/log;\nimport ballerina/mime;\nimport ballerinax/googleapis.gmail;\nimport ballerinax/openai.chat;\nimport ballerinax/salesforce as sf;\n\ntype Email record {|\n    string 'from;\n    string subject;\n    string body;\n|};\n\ntype Name record {|\n    string firstName__c;\n    string lastName__c;\n|};\n\ntype Lead record {|\n    *Name;\n    string email__c;\n    string phoneNumber__c;\n    string company__c;\n    string designation__c;\n|};\n\nconfigurable string gmailAccessToken = ?;\nconfigurable string openAIKey = ?;\nconfigurable string salesforceBaseUrl = ?;\nconfigurable string salesforceAccessToken = ?;\n\nconst LABEL = \"Lead\";\n\nfinal gmail:Client gmail = check new ({auth: {token: gmailAccessToken}});\nfinal chat:Client openAiChat = check new ({auth: {token: openAIKey}});\nfinal sf:Client salesforce = check new ({baseUrl: salesforceBaseUrl, auth: {token: salesforceAccessToken}});\n\npublic function main() returns error? {\n    while true {\n        Email[] emails = check getEmails(LABEL);\n        Lead[] leads = from Email email in emails\n                       let Lead? lead = generateLead(email)\n                       where lead is Lead\n                       select lead;\n        addLeadsToSalesforce(leads);\n        runtime:sleep(600);\n    }\n}\n\nfunction getEmails(string label) returns Email[]|error {\n    string[] labelIdsToMatch = check getLabelIds(gmail, [label]);\n    if labelIdsToMatch.length() == 0 {\n        return error(\"Unable to find any labels to match.\");\n    }\n\n    gmail:MailThread[] matchingMailThreads = check getMatchingMailThreads(gmail, labelIdsToMatch);\n    removeLabels(gmail, matchingMailThreads, labelIdsToMatch);\n    gmail:Message[] matchingEmails = getMatchingEmails(gmail, matchingMailThreads);\n\n    return from gmail:Message message in matchingEmails\n           let Email|error email = parseEmail(message)\n           where email is Email\n           select email;\n}\n\nfunction getLabelIds(gmail:Client gmail, string[] labelsToMatch) returns string[]|error {\n    gmail:LabelList labelList = check gmail->listLabels(\"me\");\n    return from gmail:Label {name, id} in labelList.labels\n           where labelsToMatch.indexOf(name) != ()\n           select id;\n}\n\nfunction getMatchingMailThreads(gmail:Client gmail, string[] labelIdsToMatch) returns gmail:MailThread[]|error {\n    gmail:MsgSearchFilter searchFilter = {\n        includeSpamTrash: false,\n        labelIds: labelIdsToMatch\n    };\n\n    return from gmail:MailThread mailThread in check gmail->listThreads(filter = searchFilter)\n           select mailThread;\n}\n\nfunction removeLabels(gmail:Client gmail, gmail:MailThread[] mailThreads, string[] labelIds) {\n    foreach gmail:MailThread mailThread in mailThreads {\n        gmail:MailThread|error removeLabelResponse = gmail->modifyThread(mailThread.id, [], labelIds);\n        if removeLabelResponse is error {\n            log:printError(\"An error occured in removing the labels from the thread.\",\n                removeLabelResponse, removeLabelResponse.stackTrace(), threadId = mailThread.id, labelIds = labelIds);\n        }\n    }\n}\n\nfunction getMatchingEmails(gmail:Client gmail, gmail:MailThread[] mailThreads) returns gmail:Message[] {\n    gmail:Message[] messages = [];\n\n    foreach gmail:MailThread mailThread in mailThreads {\n        gmail:MailThread|error response = gmail->readThread(mailThread.id);\n        if response is error {\n            log:printError(\"An error occured while reading the email.\", \n                response, response.stackTrace(), threadId = mailThread.id);\n            continue;\n        }\n\n        if !(response.messages is gmail:Message[]) || (<gmail:Message[]>response.messages).length() < 1 {\n            log:printError(\"Unable to find any messages in the thread.\", threadId = mailThread.id);\n            continue;\n        }\n\n        messages.push((<gmail:Message[]>response.messages)[0]);\n    }\n\n    return messages;\n}\n\nfunction parseEmail(gmail:Message message) returns Email|error {\n    do {\n        gmail:MessageBodyPart bodyPart = check message.emailBodyInText.ensureType(gmail:MessageBodyPart);\n        string bodyPartText = check bodyPart.data.ensureType(string);\n        string body = check mime:base64Decode(bodyPartText).ensureType(string);\n\n        return {\n            'from: check message.headerFrom.ensureType(string),\n            subject: check message.headerSubject.ensureType(string),\n            body: body\n        };\n    } on fail error e {\n        log:printError(\"An error occured while parsing the email.\", e, e.stackTrace(), message = message);\n        return e;\n    }\n}\n\nfunction generateLead(Email email) returns Lead? {\n    chat:CreateChatCompletionRequest request = {\n        model: \"gpt-3.5-turbo\",\n        messages: [\n            {\n                role: \"user\",\n                content: string `\n            Extract the following details in JSON from the email.\n                {\n                    firstName__c: string, // Mandatory\n                    lastName__c: string, // Mandatory\n                    email__c: string // Mandatory\n                    phoneNumber__c: string, // With country code. Use N/A if unable to find\n                    company__c: string, // Mandatory\n                    designation__c: string // Not mandatory. Use N/A if unable to find\n                }\n\n            Here is the email:    \n            {\n                from: ${email.'from},\n                subject: ${email.subject},\n                body: ${email.body}\n            }\n        `\n            }\n        ]\n    };\n\n    do {\n        chat:CreateChatCompletionResponse response = check openAiChat->/chat/completions.post(request);\n        if response.choices.length() < 1 {\n            check error(\"Unable to find any choices in the response.\");\n        }\n        string content = check response.choices[0].message?.content.ensureType(string);\n        return check content.fromJsonStringWithType(Lead);\n    } on fail error e {\n        log:printError(\"An error occured while generating the lead.\", e, e.stackTrace(), email = email);\n        return;\n    }\n}\n\nfunction addLeadsToSalesforce(Lead[] leads) {\n    from Lead lead in leads\n    do {\n        sf:CreationResponse|error createResponse = salesforce->create(\"EmailLead__c\", lead);\n        if createResponse is error {\n            log:printError(\"An error occured while creating a Lead object on salesforce.\", \n                createResponse, createResponse.stackTrace(), lead = lead);\n        } else {\n            log:printInfo(\"Lead successfully created.\", lead = lead);\n        }\n    };\n}\n  \n"},"__N_SSG":true}