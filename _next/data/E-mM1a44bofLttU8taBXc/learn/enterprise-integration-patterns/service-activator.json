{"pageProps":{"tagline":"Make services available via both messaging and non-messaging techniques","desc":"Service activator provides a service that can be invoked via both messaging and non-messaging techniques.","category":"Messaging Endpoints","index":52,"helps":"Ballerina can expose public functions/classes that can be invoked by other Ballerina programs. This allows sharing common logic between services and applications. Such Ballerina packages can be published using Ballerina Central.","tags":["Service Activator","Request-Reply","Command Message"],"link":"https://www.enterpriseintegrationpatterns.com/patterns/messaging/MessagingAdapter.html","content":[{"headerCode":"<pre class=\"shiki github-light\" style=\"background-color: #fff\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color: #D73A49\">import</span><span style=\"color: #24292E\"> ballerina/http;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #D73A49\">type</span><span style=\"color: #24292E\"> </span><span style=\"color: #6F42C1\">Customer</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">record</span><span style=\"color: #24292E\"> {</span><span style=\"color: #D73A49\">|</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    </span><span style=\"color: #005CC5\">string</span><span style=\"color: #24292E\"> customerId;</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    </span><span style=\"color: #005CC5\">string</span><span style=\"color: #24292E\"> customerName;</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    </span><span style=\"color: #005CC5\">decimal</span><span style=\"color: #24292E\"> totalEligibleClaimAmount;</span></span>\n<span class=\"line\"><span style=\"color: #D73A49\">|</span><span style=\"color: #24292E\">};</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #D73A49\">type</span><span style=\"color: #24292E\"> </span><span style=\"color: #6F42C1\">ClaimRequest</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">record</span><span style=\"color: #24292E\"> {</span><span style=\"color: #D73A49\">|</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    </span><span style=\"color: #005CC5\">string</span><span style=\"color: #24292E\"> customerId;</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    </span><span style=\"color: #005CC5\">string</span><span style=\"color: #24292E\"> policyNumber;</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    </span><span style=\"color: #005CC5\">decimal</span><span style=\"color: #24292E\"> claimAmount;</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    </span><span style=\"color: #005CC5\">string</span><span style=\"color: #24292E\"> accidentType;</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    </span><span style=\"color: #005CC5\">string</span><span style=\"color: #24292E\"> claimLocation;</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    ClaimDate claimDate;</span></span>\n<span class=\"line\"><span style=\"color: #D73A49\">|</span><span style=\"color: #24292E\">};</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #D73A49\">type</span><span style=\"color: #24292E\"> </span><span style=\"color: #6F42C1\">ClaimDate</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">record</span><span style=\"color: #24292E\"> {</span><span style=\"color: #D73A49\">|</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    </span><span style=\"color: #005CC5\">string</span><span style=\"color: #24292E\"> year;</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    </span><span style=\"color: #005CC5\">string</span><span style=\"color: #24292E\"> month;</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    </span><span style=\"color: #005CC5\">string</span><span style=\"color: #24292E\"> day;</span></span>\n<span class=\"line\"><span style=\"color: #D73A49\">|</span><span style=\"color: #24292E\">};</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #D73A49\">type</span><span style=\"color: #24292E\"> </span><span style=\"color: #6F42C1\">Claim</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">record</span><span style=\"color: #24292E\"> {</span><span style=\"color: #D73A49\">|</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    </span><span style=\"color: #D73A49\">*</span><span style=\"color: #24292E\">ClaimRequest;</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    </span><span style=\"color: #032F62\">&quot;APPROVED&quot;</span><span style=\"color: #D73A49\">|</span><span style=\"color: #032F62\">&quot;REJECTED&quot;</span><span style=\"color: #D73A49\">|</span><span style=\"color: #032F62\">&quot;PENDING&quot;</span><span style=\"color: #24292E\"> status;</span></span>\n<span class=\"line\"><span style=\"color: #D73A49\">|</span><span style=\"color: #24292E\">};</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #D73A49\">type</span><span style=\"color: #24292E\"> </span><span style=\"color: #6F42C1\">ClaimHistory</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">record</span><span style=\"color: #24292E\"> {</span><span style=\"color: #D73A49\">|</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    </span><span style=\"color: #005CC5\">string</span><span style=\"color: #24292E\"> customerId;</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    Claim[] claims;</span></span>\n<span class=\"line\"><span style=\"color: #D73A49\">|</span><span style=\"color: #24292E\">};</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #D73A49\">final</span><span style=\"color: #24292E\"> http</span><span style=\"color: #D73A49\">:</span><span style=\"color: #24292E\">Client claimHistory </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">check</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">new</span><span style=\"color: #24292E\"> (</span><span style=\"color: #032F62\">&quot;http://api.claimhistory.firebase.com.balmock.io&quot;</span><span style=\"color: #24292E\">);</span></span>\n<span class=\"line\"><span style=\"color: #D73A49\">final</span><span style=\"color: #24292E\"> http</span><span style=\"color: #D73A49\">:</span><span style=\"color: #24292E\">Client customerDetails </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">check</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">new</span><span style=\"color: #24292E\"> (</span><span style=\"color: #032F62\">&quot;http://api.customerdetails.firebase.com.balmock.io&quot;</span><span style=\"color: #24292E\">);</span></span>\n<span class=\"line\"></span></code></pre>","mainCode":"<pre class=\"shiki github-light\" style=\"background-color: #fff\" tabindex=\"0\"><code><span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #D73A49\">service</span><span style=\"color: #24292E\"> </span><span style=\"color: #6F42C1\">/api/v1</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">on</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">new</span><span style=\"color: #24292E\"> http:Listener(</span><span style=\"color: #005CC5\">8080</span><span style=\"color: #24292E\">) {</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    </span><span style=\"color: #D73A49\">isolated</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">resource</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">function</span><span style=\"color: #24292E\"> </span><span style=\"color: #6F42C1\">post</span><span style=\"color: #24292E\"> </span><span style=\"color: #6F42C1\">claim</span><span style=\"color: #24292E\">(</span><span style=\"color: #E36209\">ClaimRequest</span><span style=\"color: #24292E\"> </span><span style=\"color: #E36209\">claimRequest</span><span style=\"color: #24292E\">) </span><span style=\"color: #D73A49\">returns</span><span style=\"color: #24292E\"> </span><span style=\"color: #005CC5\">decimal</span><span style=\"color: #D73A49\">|error</span><span style=\"color: #24292E\"> {</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        ClaimHistory claimHostory </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">check</span><span style=\"color: #24292E\"> claimHistory</span><span style=\"color: #D73A49\">-&gt;/</span><span style=\"color: #24292E\">claims</span><span style=\"color: #D73A49\">/</span><span style=\"color: #24292E\">[claimRequest.customerId]</span><span style=\"color: #D73A49\">/</span><span style=\"color: #24292E\">claims\\.</span><span style=\"color: #6F42C1\">json</span><span style=\"color: #24292E\">();</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        Customer customer </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">check</span><span style=\"color: #24292E\"> customerDetails</span><span style=\"color: #D73A49\">-&gt;/</span><span style=\"color: #24292E\">customers</span><span style=\"color: #D73A49\">/</span><span style=\"color: #24292E\">[claimRequest.customerId]</span><span style=\"color: #D73A49\">/</span><span style=\"color: #24292E\">details\\.</span><span style=\"color: #6F42C1\">json</span><span style=\"color: #24292E\">();</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        </span><span style=\"color: #D73A49\">return</span><span style=\"color: #24292E\"> </span><span style=\"color: #6F42C1\">calculateClaimAmount</span><span style=\"color: #24292E\">(</span><span style=\"color: #E36209\">claimRequest</span><span style=\"color: #24292E\">, </span><span style=\"color: #E36209\">claimHostory</span><span style=\"color: #24292E\">, customer.totalEligibleClaimAmount);</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    }</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #D73A49\">isolated</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">function</span><span style=\"color: #24292E\"> </span><span style=\"color: #6F42C1\">calculateClaimAmount</span><span style=\"color: #24292E\">(</span><span style=\"color: #E36209\">ClaimRequest</span><span style=\"color: #24292E\"> </span><span style=\"color: #E36209\">claimRequest</span><span style=\"color: #24292E\">, </span><span style=\"color: #E36209\">ClaimHistory</span><span style=\"color: #24292E\"> </span><span style=\"color: #E36209\">claimHistory</span><span style=\"color: #24292E\">, </span><span style=\"color: #005CC5\">decimal</span><span style=\"color: #24292E\"> </span><span style=\"color: #E36209\">totalElegibleAmount</span><span style=\"color: #24292E\">) </span><span style=\"color: #D73A49\">returns</span><span style=\"color: #24292E\"> </span><span style=\"color: #005CC5\">decimal</span><span style=\"color: #24292E\"> {</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    </span><span style=\"color: #005CC5\">decimal</span><span style=\"color: #24292E\"> totalClaimedAmount </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">from</span><span style=\"color: #24292E\"> </span><span style=\"color: #005CC5\">var</span><span style=\"color: #24292E\"> {claimAmount, claimDate, status} </span><span style=\"color: #D73A49\">in</span><span style=\"color: #24292E\"> claimHistory.claims</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        </span><span style=\"color: #D73A49\">where</span><span style=\"color: #24292E\"> claimDate.year </span><span style=\"color: #D73A49\">==</span><span style=\"color: #24292E\"> claimRequest.claimDate.year </span><span style=\"color: #D73A49\">&amp;&amp;</span><span style=\"color: #24292E\"> status </span><span style=\"color: #D73A49\">==</span><span style=\"color: #24292E\"> </span><span style=\"color: #032F62\">&quot;APPROVED&quot;</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        collect </span><span style=\"color: #6F42C1\">sum</span><span style=\"color: #24292E\">(</span><span style=\"color: #E36209\">claimAmount</span><span style=\"color: #24292E\">);</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    </span><span style=\"color: #005CC5\">decimal</span><span style=\"color: #24292E\"> remainingAmount </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> totalElegibleAmount </span><span style=\"color: #D73A49\">-</span><span style=\"color: #24292E\"> totalClaimedAmount;</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    </span><span style=\"color: #D73A49\">return</span><span style=\"color: #24292E\"> </span><span style=\"color: #005CC5\">decimal</span><span style=\"color: #D73A49\">:</span><span style=\"color: #6F42C1\">max</span><span style=\"color: #24292E\">(</span><span style=\"color: #E36209\">remainingAmount</span><span style=\"color: #24292E\">, claimRequest.claimAmount </span><span style=\"color: #D73A49\">*</span><span style=\"color: #24292E\"> </span><span style=\"color: #005CC5\">0.2</span><span style=\"color: #24292E\">);</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">}</span></span>\n<span class=\"line\"></span></code></pre>","raw":"import ballerina/http;\n\ntype Customer record {|\n    string customerId;\n    string customerName;\n    decimal totalEligibleClaimAmount;\n|};\n\ntype ClaimRequest record {|\n    string customerId;\n    string policyNumber;\n    decimal claimAmount;\n    string accidentType;\n    string claimLocation;\n    ClaimDate claimDate;\n|};\n\ntype ClaimDate record {|\n    string year;\n    string month;\n    string day;\n|};\n\ntype Claim record {|\n    *ClaimRequest;\n    \"APPROVED\"|\"REJECTED\"|\"PENDING\" status;\n|};\n\ntype ClaimHistory record {|\n    string customerId;\n    Claim[] claims;\n|};\n\nfinal http:Client claimHistory = check new (\"http://api.claimhistory.firebase.com.balmock.io\");\nfinal http:Client customerDetails = check new (\"http://api.customerdetails.firebase.com.balmock.io\");\n\nservice /api/v1 on new http:Listener(8080) {\n    isolated resource function post claim(ClaimRequest claimRequest) returns decimal|error {\n        ClaimHistory claimHostory = check claimHistory->/claims/[claimRequest.customerId]/claims\\.json();\n        Customer customer = check customerDetails->/customers/[claimRequest.customerId]/details\\.json();\n        return calculateClaimAmount(claimRequest, claimHostory, customer.totalEligibleClaimAmount);\n    }\n}\n\nisolated function calculateClaimAmount(ClaimRequest claimRequest, ClaimHistory claimHistory, decimal totalElegibleAmount) returns decimal {\n    decimal totalClaimedAmount = from var {claimAmount, claimDate, status} in claimHistory.claims\n        where claimDate.year == claimRequest.claimDate.year && status == \"APPROVED\"\n        collect sum(claimAmount);\n    decimal remainingAmount = totalElegibleAmount - totalClaimedAmount;\n    return decimal:max(remainingAmount, claimRequest.claimAmount * 0.2);\n}\n","name":"service-activator.bal"}],"name":" Service Activator"},"__N_SSG":true}