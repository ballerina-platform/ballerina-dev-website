{"pageProps":{"frontmatter":{"layout":"ballerina-cloud-left-nav-pages-swanlake","title":"Azure Functions","description":"Learn how to write and deploy Azure Functions using ballerina","keywords":"ballerina, programming language, serverless, cloud, azure, functions, cloud native","permalink":"/learn/run-ballerina-programs-in-the-cloud/function-as-a-service-with-ballerina/azure-functions/","active":"azure-functions","intro":"The Azure Functions extension provides the functionality to expose a Ballerina function as a serverless function in the Azure Functions platform.","redirect_from":["/learn/deployment/azure-functions","/swan-lake/learn/deployment/azure-functions/","/swan-lake/learn/deployment/azure-functions","/learn/deployment/azure-functions/","/learn/deployment/azure-functions","/learn/user-guide/deployment/azure-functions","/learn/user-guide/deployment/azure-functions/","/learn/running-ballerina-programs-in-the-cloud/function-as-a-service-with-ballerina/azure-functions","/learn/running-ballerina-programs-in-the-cloud/function-as-a-service-with-ballerina/azure-functions/","/learn/run-ballerina-programs-in-the-cloud/function-as-a-service-with-ballerina/azure-functions","/learn/guides/running-ballerina-programs-in-the-cloud/function-as-a-service-with-ballerina/azure-functions/","/learn/guides/running-ballerina-programs-in-the-cloud/function-as-a-service-with-ballerina/azure-functions"]},"content":"\n## Prerequisites\n* Install the latest Ballerina distribution.\n* Install the <a href=\"https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest\" target=\"_blank\">Azure CLI</a>.\n* Login to the Azure CLI by executing the `az login` command.\n* Create an <a href=\"https://docs.microsoft.com/en-us/azure/azure-functions/functions-create-function-app-portal\" target=\"_blank\">Azure Function app</a> with the given resource group with following requirements.\n\n>**Note:** Make sure to remember the function application name and storage account name as they will be required in the code samples.\n   - Runtime stack - `Java 11`\n   - Hosting operating system - `Windows` (By default, Linux is not supported in Azure for custom handlers at the moment.)\n\n## Triggers and bindings\n\nAn Azure Function consists of a trigger and optional bindings. A trigger defines how a function is invoked. A binding is an approach in which you can declaratively connect other resources to the function. There are *input* and *output* bindings. An input binding is a source of data into the function. An output binding allows outputting data from the function to an external resource. For more information, go to <a href=\"https://docs.microsoft.com/en-us/azure/azure-functions/functions-triggers-bindings\" target=\"_blank\">Azure Functions triggers and bindings concepts</a>.\n\nThe following Azure Functions triggers and bindings are currently supported in Ballerina:\n- HTTP <a href=\"https://docs.central.ballerina.io/ballerinax/azure_functions/latest/annotations#HTTPTrigger\" target=\"_blank\">trigger</a> and <a href=\"https://docs.central.ballerina.io/ballerinax/azure_functions/latest/annotations#HTTPOutput\" target=\"_blank\">ouput</a> binding\n- Queue <a href=\"https://docs.central.ballerina.io/ballerinax/azure_functions/latest/annotations#QueueTrigger\" target=\"_blank\">trigger</a> and <a href=\"https://docs.central.ballerina.io/ballerinax/azure_functions/latest/annotations#QueueOutput\" target=\"_blank\">ouput</a> binding\n- Blob <a href=\"https://docs.central.ballerina.io/ballerinax/azure_functions/latest/annotations#BlobTrigger\" target=\"_blank\">trigger</a>, <a href=\"https://docs.central.ballerina.io/ballerinax/azure_functions/latest/annotations#BlobInput\" target=\"_blank\">input</a> binding, and <a href=\"https://docs.central.ballerina.io/ballerinax/azure_functions/latest/annotations#BlobOutput\" target=\"_blank\">output</a> binding\n- Twilio SMS <a href=\"https://docs.central.ballerina.io/ballerinax/azure_functions/latest/annotations#TwilioSmsOutput\" target=\"_blank\">output</a> binding\n- CosmosDB <a href=\"https://docs.central.ballerina.io/ballerinax/azure_functions/latest/annotations#CosmosDBTrigger\" target=\"_blank\">trigger</a>, <a href=\"https://docs.central.ballerina.io/ballerinax/azure_functions/latest/annotations#CosmosDBInput\" target=\"_blank\">input</a> binding, and <a href=\"https://docs.central.ballerina.io/ballerinax/azure_functions/latest/annotations#CosmosDBOutput\" target=\"_blank\">output</a> binding\n- Timer <a href=\"https://docs.central.ballerina.io/ballerinax/azure_functions/latest/annotations#TimerTrigger\" target=\"_blank\">trigger</a>\n\n## Write the function\n\nThe following Ballerina code gives an example of using an HTTP trigger to invoke the function, and an HTTP output binding to respond to the caller with a message. \n\nCreate a Ballerina package.\n```\n$ bal new azure_functions_deployment\n```\nReplace the contents of the generated BAL file with the following content.\n\n```ballerina\nimport ballerinax/azure_functions as af;\n\n@af:Function\npublic function hello(@af:HTTPTrigger { authLevel: \"anonymous\" }\n                      string payload)\n                      returns @af:HTTPOutput string|error {\n    return \"Hello, \" + payload + \"!\";\n}\n```\nThe first parameter with the <a href=\"https://lib.ballerina.io/ballerinax/azure_functions/latest/classes/Context\" target=\"_blank\">context</a> object contains the information and operations related to the current function execution in Azure Functions such as the execution metadata and logging actions to be used by the function. This parameter is optional and can exist at any position in the function's parameter list.\n\nThe second parameter with the `HTTPTrigger` annotation signals that this function is going to have an HTTP trigger and that its details should be stored in the given `HTTPRequest` value. Then, you declare an HTTP output binding by annotating the `HTTPBinding` return type with the `HTTPOutput` annotation.\n\nThis HTTP output binding can also be defined as a parameter with the same annotation. In this manner, you can mix and match any combination of triggers and input/output bindings with or without the execution context object when defining an Azure Function. You can find an example in the [HTTP Trigger -> Queue Output](#http-trigger---queue-output) output example.\n\n### Build the function\n\nThe Azure Functions functionality is implemented as a compiler extension. Thus, artifact generation happens automatically when you build a Ballerina module. Let's see how this works by building the above code. \n\n```\n$ bal build\nCompiling source\n\twso2/azure_functions_deployment:0.1.0\n\nGenerating executables\n\t@azure.functions:Function: hello\n\n\tRun the following command to deploy Ballerina Azure Functions:\n\taz functionapp deployment source config-zip -g <resource_group> -n <function_app_name> --src <package_dir>/target/bin/azure-functions.zip\n```\n\n>**Note:** A custom <a href=\"https://docs.microsoft.com/en-us/azure/azure-functions/functions-host-json\" target=\"_blank\">`host.json`</a> file for the Azure Functions deployment can be provided optionally by placing a `host.json` file in the current working directory in which the Ballerina build is done. The required `host.json` properties are provided/overridden by the values derived from the source code by the compiler extension. \n\n\n### Deploy the function\n\nThe created resource group and the function app name should be provided to the placeholders shown in the above-generated usage instructions from the compiler. \n\nA sample execution to deploy the functions to Azure Functions is shown below. \n\n```\n$ az functionapp deployment source config-zip -g <function_app_name> -n <function_app_name> --src <package_dir>/target/bin/azure-functions.zip\nGetting scm site credentials for zip deployment\nStarting zip deployment. This operation can take a while to complete ...\nDeployment endpoint responded with status code 202\n{\n  \"active\": false,\n  \"author\": \"N/A\",\n  \"author_email\": \"N/A\",\n  \"complete\": true,\n  \"deployer\": \"ZipDeploy\",\n  \"end_time\": \"2020-07-15T07:32:35.5311903Z\",\n  \"id\": \"e56a20038b864c5c8432aa7d1c26bfbd\",\n  \"is_readonly\": true,\n  \"is_temp\": false,\n  \"last_success_end_time\": \"2020-07-15T07:32:35.5311903Z\",\n  \"log_url\": \"https://<function_app_name>.scm.azurewebsites.net/api/deployments/latest/log\",\n  \"message\": \"Created via a push deployment\",\n  \"progress\": \"\",\n  \"provisioningState\": null,\n  \"received_time\": \"2020-07-15T07:32:21.9780071Z\",\n  \"site_name\": \"<function_app_name>\",\n  \"start_time\": \"2020-07-15T07:32:23.2044517Z\",\n  \"status\": 4,\n  \"status_text\": \"\",\n  \"url\": \"https://<function_app_name>.scm.azurewebsites.net/api/deployments/latest\"\n}\n```\n\n### Invoke the function\n\nThe deployed Azure Function can be tested by invoking it using an HTTP client such as cURL:\n\n```\n$ curl -d \"Hello!\" https://<function_app_name>.azurewebsites.net/api/hello \nHello, Hello!%\n```\n\n## More samples\n\nThis section uses different types of triggers and bindings to build Azure functions to integrate with different Azure services using concepts explained in the above sections.\n\n### HTTP Trigger -> queue output\n\nThe following Ballerina code gives an example of using an HTTP trigger to invoke the function, a queue output binding to write an entry to a queue, and also an HTTP output binding to respond to the caller with a message. \n\nFirst, create a queue to hold the outputs of the function by accessing the storage account that was created alongside the function app in the prerequisites. Select **Queues** in the sidebar in the storage accounts. Click the **Add queue** button, and enter the same value as the value of the `queueName` property in the below `QueueOutput` annotation.\n\n```ballerina\nimport ballerinax/azure_functions as af;\n\n@af:Function\npublic function fromHttpToQueue(af:Context ctx, \n                                @af:HTTPTrigger { authLevel: \"anonymous\" } af:HTTPRequest req, \n                                @af:QueueOutput { queueName: \"queue1\" } af:StringOutputBinding msg) \n                                returns @af:HTTPOutput af:HTTPBinding {\n    msg.value = req.body;\n    return { statusCode: 200, payload: \"Request: \" + req.toString() };\n}\n```\n\nBuild the package by executing the `bal build` command on the package directory, and then, deploy it using the `az cli` command shown in the Ballerina build output as in the previous section.\n\nNow, the deployed Azure Function can be tested by invoking it using an HTTP client such as cURL. \n\n```\n$ curl -d \"Hello!\" https://<function_app_name>.azurewebsites.net/api/fromHttpToQueue \nRequest: url=https://<function_app_name>.azurewebsites.net/api/fromHttpToQueue method=POST query= headers=Accept=*/* Connection=Keep-Alive Content-Length=6 Content-Type=application/x-www-form-urlencoded Host=<function_app_name>.azurewebsites.net Max-Forwards=9 User-Agent=curl/7.64.0 X-WAWS-Unencoded-URL=/api/fromHttpToQueue CLIENT-IP=10.0.128.31:47794 X-ARR-LOG-ID=c905b483-af19-4cf2-9ce0-0741e5998a98 X-SITE-DEPLOYMENT-ID=<function_app_name> WAS-DEFAULT-HOSTNAME=<function_app_name>.azurewebsites.net X-Original-URL=/api/fromHttpToQueue X-Forwarded-For=45.30.94.9:47450 X-ARR-SSL=2048|256|C=US, S=Washington, L=Redmond, O=Microsoft Corporation, OU=Microsoft IT, CN=Microsoft IT TLS CA 5|CN=*.azurewebsites.net X-Forwarded-Proto=https X-AppService-Proto=https X-Forwarded-TlsVersion=1.2 DISGUISED-HOST=<function_app_name>.azurewebsites.net params= identities=[{\"AuthenticationType\":null,\"IsAuthenticated\":false,\"Actor\":null,\"BootstrapContext\":null,\"Claims\":[],\"Label\":null,\"Name\":null,\"NameClaimType\":\"http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name\",\"RoleClaimType\":\"http://schemas.microsoft.com/ws/2008/06/identity/claims/role\"}] body=Hello!\n```\n\nRefresh the queue page in the portal and view the added entry.\n\n### Cosmos DB trigger -> queue output\n\nThe following Ballerina code gives an example of using a Cosmos DB trigger to invoke the function and a queue output binding to write an entry to a queue.\n\nBefore writing and deploying the code, create a Cosmos DB and a queue to make use of those services later.\n1. You can reuse the queue you created in the above <a href=\"/learn/run-in-the-cloud/function-as-a-service/azure-functions/#http-trigger---queue-output\" target=\"_blank\">`HTTP trigger` -> `Queue output`</a> sample.\n2. Create an <a href=\"https://portal.azure.com/#create/Microsoft.DocumentDB\" target=\"_blank\">Azure Cosmos DB account</a> and select Cosmos DB Core.\n3. Once the database is created, go to the **Data Explorer**, and select **Create Container**.\n4. Enter `db1` as Database ID and `c1` as the collection ID, and click **Ok**.\n\n**Note:** If you want to change these values, make sure to change them in the code as well.\n5. Go to the **Keys** tab of the Cosmos DB page.\n6. Copy the value of the `PRIMARY CONNECTION STRING`.\n7. Click the **Configuration** tab on the Function app page.\n8. Select **New Application Setting**, and paste the data you copied above as the value. For the key, use the value of the `connectionStringSetting` key and save.\n\nExample application setting is as follows.\n```\nName - `CosmosDBConnection`\nValue - `AccountEndpoint=https://db-cosmos.documents.azure.com:443/;AccountKey=12345asda;`\n```\n\nNow, as all the infrastructure required are up and running and configured, start building and deploying the Azure function.\n\n```ballerina\nimport ballerina/log;\nimport ballerinax/azure_functions as af;\n\n@af:Function\npublic function cosmosDBToQueue2(@af:CosmosDBTrigger { \n        connectionStringSetting: \"CosmosDBConnection\", databaseName: \"db1\", \n        collectionName: \"c1\" } json req,\n        @af:QueueOutput { queueName: \"queue2\" } af:StringOutputBinding outMsg) returns error?{\n    json[] entryList = <json[]> req;\n    string name = check entryList[0].name;\n    log:printInfo(name);\n    outMsg.value = name;\n}\n```\n\nBuild the package by executing the `bal build` command on the package directory, and then deploy it using the `az cli` command shown in the Ballerina build output as in the previous section.\n\nOnce the function is deployed, You need to add an item to the collection.\n1. Go to the created collection in the **Data Explorer**.\n2. Click **New Item** to add a new item to the collection.\n3. Go to the queue page and observe the added new entry.\n\n**Info:** Additionally, for debugging purposes, view the logs under the **Logs stream** in the function app.\n\n>**Note:** For a full sample with all the supported Azure Functions triggers and bindings in Ballerina, see the [Azure Functions deployment example](/learn/by-example/azure-functions-deployment).\n\n<style> #tree-expand-all , #tree-collapse-all, .cTocElements {display:none;} .cGitButtonContainer {padding-left: 40px;} </style>\n","id":"azure-functions","sub":"run-in-the-cloud","third":"function-as-a-service","slug":"run-in-the-cloud/function-as-a-service/azure-functions"},"__N_SSG":true}