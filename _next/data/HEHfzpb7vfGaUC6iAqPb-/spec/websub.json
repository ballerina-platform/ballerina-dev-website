{"pageProps":{"frontmatter":{},"content":"# Specification: Ballerina WebSub Library\n\n_Owners_: @shafreenAnfar @chamil321 @ayeshLK    \n_Reviewers_: @chamil321    \n_Created_: 2022/01/31  \n_Updated_: 2022/05/23  \n_Edition_: Swan Lake  \n\n## Introduction \n\nThis is the specification for the WebSub standard library of [Ballerina language](https://ballerina.io/), which provides WebSub compliant `subscriber` related functionalities.\n\nThe WebSub library specification has evolved and may continue to evolve in the future. The released versions of the specification can be found under the relevant Github tag. \n\nIf you have any feedback or suggestions about the library, start a discussion via a [GitHub issue](https://github.com/ballerina-platform/ballerina-standard-library/issues) or in the [Slack channel](https://ballerina.io/community/). Based on the outcome of the discussion, the specification and implementation can be updated. Community feedback is always welcome. Any accepted proposal which affects the specification is stored under `/docs/proposals`. Proposals under discussion can be found with the label `type/proposal` in Github.\n\nThe conforming implementation of the specification is released and included in the distribution. Any deviation from the specification is considered a bug.\n\n## Content\n1. [Overview](#1-overview)\n2. [Subscriber](#2-subscriber)\n    * 2.1. [Listener](#21-listener)\n      * 2.1.1. [Configuration](#211-configuration)\n      * 2.1.2. [Initialization](#212-initialization)\n      * 2.1.3. [Methods](#213-methods)\n    * 2.2 [Subscriber Service](#22-subscriber-service)\n      * 2.2.1. [Methods](#221-methods)\n        * 2.2.1.1. [onSubscriptionValidationDenied](#2211-onsubscriptionvalidationdenied)\n        * 2.2.1.2. [onSubscriptionVerification](#2212-onsubscriptionverification)\n        * 2.2.1.3. [onUnsubscriptionVerification](#2213-onunsubscriptionverification)\n        * 2.2.1.4. [onEventNotification](#2214-oneventnotification)\n      * 2.2.2. [Annotation](#222-annotation)\n      * 2.2.3. [Callback URL Generation](#223-callback-url-generation)\n        * 2.2.3.1 [Service Path Generation](#2231-service-path-generation)\n      * 2.2.4. [Unsubscribing from the `hub`](#224-unsubscribing-from-the-hub)\n\n## 1. Overview\n\n[WebSub](https://www.w3.org/TR/websub/) is a real-time content delivery protocol over HTTP(S) and it is a specification\nwhich evolved from [PubSubHubbub](https://github.com/pubsubhubbub/PubSubHubbub).\n\nWebSub specification describes three main roles:\n- Publisher: Advertises a `topic` and `hub` URL on one or more resource URLs.\n- Subscriber: Discovers the `hub` and `topic` URL given a resource URL, subscribes to updates at the `hub`, and accepts\n  content distribution requests from the `hub`.\n- Hub: Handles subscription requests and distributes the content to subscribers when the corresponding topic URL has\n  been updated.\n\n`WebSub` is a library which is derived from the WebSub specification which could be used by developers to implement\nWebSub compliant `subscriber` services.  \n\n## 2. Subscriber\n\nWebSub `subscriber` will subscribe to a `hub` to receive content updates for a `topic`.  \n\nIt has the following capabilities:\n* Discover the `hub` and the `topic` given a resource URL\n* Subscribe to content updates for a `topic` in a `hub`\n* Accept content distribution requests from the `hub`\n\nThe `subscriber` is designed in the form of `listener` and `Subscriber Service`.\n- `websub:Listener`: A listener end-point to which `websub:SubscriberService` could be attached.\n- `websub:SubscriberService`: An API service, which receives events.\n\n### 2.1. Listener\n\nThe `websub:Listener` opens the given port and attaches the provided `websub:SubscriberService` object to the given\nservice-path. `websub:Listener` can be initialized either by providing a port with listener configurations or by\nproviding an `http:Listener`.\n\n#### 2.1.1. Configuration\n\nWhen initializing a `websub:Listener`, following configurations could be provided.\n```ballerina\n# Provides a set of configurations for configure the underlying HTTP listener of the WebSub listener.\n# \n# + gracefulShutdownPeriod - The time period in seconds to wait for unsubscription verification\npublic type ListenerConfiguration record {|\n    *http:ListenerConfiguration;\n    decimal gracefulShutdownPeriod = 20;\n|};\n```\n\nFor more details on the available configurations please refer [`http:ListenerConfiguration`](https://lib.ballerina.io/ballerina/http/latest/records/ListenerConfiguration).\n\n#### 2.1.2. Initialization\n\nThe `websub:Listener` could be initialized by providing either a port with `websub:ListenerConfiguration` or by\nproviding an `http:Listener`.\n```ballerina\n# Initiliazes `websub:Listener` instance.\n# ```\n# listener websub:Listener websubListenerEp = check new (9090);\n# ```\n#\n# + listenTo - Port number or a `http:Listener` instance\n# + config - Custom `websub:ListenerConfiguration` to be provided to underlying HTTP Listener\n# + return - The `websub:Listener` or an `websub:Error` if the initialization failed\npublic isolated function init(int|http:Listener listenTo, *ListenerConfiguration config) returns websub:Error? \n```\n\n#### 2.1.3. Methods\n\nFollowing APIs should be available in the `websub:Listener` to dynamically attach `websub:SubscriberService` objects to \nit.\n```ballerina\n# Attaches the provided `websub:SubscriberService` to the `websub:Listener`.\n# ```\n# check websubListenerEp.attach('service, \"/subscriber\");\n# ```\n# \n# + service - The `websub:SubscriberService` object to attach\n# + name - The path of the Service to be hosted\n# + return - An `websub:Error`, if an error occurred during the service attaching process or else `()`\npublic isolated function attach(websub:SubscriberService 'service, string[]|string? name = ()) returns websub:Error?\n```\n\nFollowing APIs should be available in the `websub:Listener` to dynamically attach `websub:SubscriberService` objects \nalong with `websub:SubscriberServiceConfiguration`. This is useful when the `subscriber` is implemented using a service class.\n```ballerina\n# Attaches the provided Service to the `websub:Listener` with custom `websub:SubscriberServiceConfiguration`.\n# ```\n# check websubListenerEp.attachWithConfig('service, {\n#    target: \"http://0.0.0.0:9191/common/discovery\",\n#    leaseSeconds: 36000\n# }, \"/subscriber\");\n# ```\n# \n# + service - The `websub:SubscriberService` object to attach\n# + configuration - Custom `websub:SubscriberServiceConfiguration` which should be incorporated into the provided Service \n# + name - The path of the Service to be hosted\n# + return - An `websub:Error`, if an error occurred during the service attaching process or else `()`\npublic isolated function attachWithConfig(websub:SubscriberService 'service, websub:SubscriberServiceConfiguration configuration, string[]|string? name = ()) returns websub:Error?\n```\n\nFollowing APIs should be available in the `websub:Listener` to dynamically detach `websub:SubscriberService` objects \nfrom it.\n```ballerina\n# Detaches the provided `websub:SubscriberService` from the `websub:Listener`.\n# ```\n# check websubListenerEp.detach('service);\n# ```\n# \n# + service - The `websub:SubscriberService` object to be detached\n# + return - An `websub:Error`, if an error occurred during the service detaching process or else `()`\npublic isolated function detach(websub:SubscriberService 'service) returns websub:Error?\n```\n\nFollowing APIs should be available to dynamically start the `websub:Listener`.\n```ballerina\n# Starts the registered service programmatically..\n# ```\n# check websubListenerEp.'start();\n# ```\n# \n# + return - An `websub:Error`, if an error occurred during the listener starting process or else `()`\npublic isolated function 'start() returns websub:Error?\n```\n\nFollowing APIs should be available to dynamically stop the `websub:Listener`.\n```ballerina\n# Stops the service listener gracefully. Already-accepted requests will be served before connection closure.\n# ```\n# check websubListenerEp.gracefulStop();\n# ```\n# \n# + return - An `websub:Error`, if an error occurred during the listener stopping process or else `()`\npublic isolated function gracefulStop() returns websub:Error?\n\n# Stops the service listener immediately.\n# ```\n# check websubListenerEp.immediateStop();\n# ```\n# \n# + return - An `websub:Error`, if an error occurred during the listener stopping process or else `()`\npublic isolated function immediateStop() returns websub:Error?\n```\n\n### 2.2. Subscriber Service\n\n`websub:SubscriberService` is responsible for handling the received events. Underlying `http:Service` will receive the \noriginal request, and then it will trigger the WebSub dispatcher which will invoke the respective remote method with the \nevent details.\n\nFollowing is the type-definition for `websub:SubscriberService`.\n```ballerina\npublic type SubscriberService distinct service object {\n    // Sample GET request hub.mode=denied&hub.reason=unauthorized\n    // Sample 200 OK response\n    remote function onSubscriptionValidationDenied(websub:SubscriptionDeniedError msg)\n        returns websub:Acknowledgement|error?;\n\n    // Sample GET request hub.mode=subscribe&hub.topic=test&hub.challenge=1234\n    // Sample 200 OK response with text payload containing received `hub.challenge` parameter or 404 NOT FOUND\n    remote function onSubscriptionVerification(websub:SubscriptionVerification msg)\n        returns websub:SubscriptionVerificationSuccess|websub:SubscriptionVerificationError|error;\n\n    // Sample GET request hub.mode=unsubscribe&hub.topic=test&hub.challenge=1234\n    // Sample 200 OK response with text payload containing received `hub.challenge` parameter or 404 NOT FOUND\n    remote function onUnsubscriptionVerification(websub:UnsubscriptionVerification msg)\n        returns websub:UnsubscriptionVerificationSuccess|websub:UnsubscriptionVerificationError|error;\n\n    // Sample POST request with string/json/xml payload\n    // Sample 202 ACCEPTED response or 410 GONE\n    remote function onEventNotification(websub:ContentDistributionMessage event)\n        returns websub:Acknowledgement|websub:SubscriptionDeletedError|error?;\n};\n```\n\n#### 2.2.1. Methods\n\n##### 2.2.1.1. onSubscriptionValidationDenied\n\nThis remote method is invoked when the `hub` sends a request to notify that the subscription request is denied.\n```ballerina\n# Notifies that the subscription request is denied by the `hub`.\n# \n# + msg - Details related to the subscription denial\n# + return - `error` if there is any error when processing the reuqest or else `websub:Acknowledgement` or `()`\nremote function onSubscriptionValidationDenied(websub:SubscriptionDeniedError msg) returns websub:Acknowledgement|error?;\n```\n\n##### 2.2.1.2. onSubscriptionVerification\n\nThis remote method is invoked when the `hub` sends a subscription verification request to the `subscriber`.\n```ballerina\n# Verifies the subscription attempt.\n# \n# + msg - Details related to the subscription verificaiton\n# + return - `websub:SubscriptionVerificationSuccess` if the subscription is verified successfully, \n#           `websub:SubscriptionVerificationError` if the subscription verification is unsuccessful or else `error` if \n#           there is an exception while executing the method\nremote function onSubscriptionVerification(websub:SubscriptionVerification msg) \n    returns websub:SubscriptionVerificationSuccess|websub:SubscriptionVerificationError|error;\n```\n\n##### 2.2.1.3. onUnsubscriptionVerification\n\nThis remote method is invoked when the `hub` sends a unsubscription verification request to the `subscriber`.\n```ballerina\n# Verifies the unsubscription attempt.\n# \n# + msg - Details related to the unsubscription verificaiton\n# + return - `websub:UnsubscriptionVerificationSuccess` if the unsubscription is verified successfully, \n#           `websub:UnsubscriptionVerificationError` if the unsubscription verification is unsuccessful or else `error` if \n#           there is an exception while executing the method\nremote function onUnsubscriptionVerification(websub:UnsubscriptionVerification msg) \n    returns websub:UnsubscriptionVerificationSuccess|websub:UnsubscriptionVerificationError|error;\n```\n\n##### 2.2.1.4. onEventNotification\n\nThis remote method is invoked when the `hub` sends a content-distribution request to the `subscriber`.\n```ballerina\n# Notifies the content distribution.\n# \n# + msg - Received content distribution message\n# + return - `websub:Acknowledgement` if the content received successfully, `websub:SubscriptionDeletedError` if the \n#           subscriber does not need any content updates in the future, `error` if  there is an exception while \n#           executing the method or else `()`\nremote function onEventNotification(websub:ContentDistributionMessage event) \n    returns websub:Acknowledgement|websub:SubscriptionDeletedError|error?;\n```\n\n#### 2.2.2. Annotation \n\nApart from the listener level configurations a `subscriber` will require few additional configurations. Hence, there \nshould be `websub:SubscriberServiceConfig` a service-level-annotation for `websub:SubscriberService` which contains\n`websub:SubscriberServiceConfiguration` record.\n```ballerina\n# Configuration for a WebSubSubscriber service.\n#\n# + target - The `string` resource URL for which discovery will be initiated to identify the hub and topic,\n#            or a tuple `[hub, topic]` representing a discovered hub and a topic\n# + leaseSeconds - The period for which the subscription is expected to be active\n# + callback - The callback URL for subscriber-service\n# + secret - The secret to be used for authenticated content distribution\n# + appendServicePath - This flag notifies whether or not to append service-path to callback-url\n# + unsubscribeOnShutdown - This flag notifies whether or not to initiate unsubscription when the service is shutting down\n# + httpConfig - The configuration for the hub client used to interact with the discovered/specified hub\n# + discoveryConfig - HTTP client configurations for resource discovery\n# + servicePath - The generated service-path if the service-path is not provided. This is auto-generated at the compile-time\npublic type SubscriberServiceConfiguration record {|\n    string|[string, string] target?;\n    int leaseSeconds?;\n    string callback?;\n    string secret?;\n    boolean appendServicePath = false;\n    boolean unsubscribeOnShutdown = false;\n    http:ClientConfiguration httpConfig?;\n    record {|\n        string|string[] accept?;\n        string|string[] acceptLanguage?;\n        http:ClientConfiguration httpConfig?;\n    |} discoveryConfig?;\n    readonly byte[] servicePath = [];\n|};\n```\n\n#### 2.2.3. Callback URL Generation \n\nAs per the [WebSub specification](https://www.w3.org/TR/websub/#subscriber-sends-subscription-request) subscriber \ncallback URL could be used as an identity of a `subscriber` at the `hub` level, and it should be unguessable and unique \nfor a subscription.\n\nSince the developer should have the control over the callback URL to be used when subscribing to a `hub`, `websub:SubscriberServiceConfig` annotation contains an optional configuration(`callback`) to be used to provide a callback URL. If the `callback` is not configured, `websub:SubscriberService` should be able to construct the callback URL using the provided `websub:ListenerConfiguration` and service path.  \n\n##### 2.2.3.1. Service Path Generation\n\nIn ballerina service declaration, service path is an optional configuration. Hence, developers could declare \n`websub:SubscriberService` by omitting the service path. Since, service path is required for constructing the callback \nURL, `websub:SubscriberService` should be able to generate a unique, unguessable URL segment to be used as its service \npath.\n\nService path generation should be implemented with following guidelines:  \n- Service path should be generated only if;\n  - Service path and callback URL is not provided for the `websub:SubscriberService`.\n  - callback URL is provided, `appendServicePath` configuration is enabled and service path is not provided.\n- WebSub compiler plugin will generate unique service path for the `websub:SubscriberService` and populate `servicePath` field in `websub:SubscriberServiceConfig` annotation.\n- If there is an error while generating the service path, then it should result in a compile-time error since this feature is required to generate a callback URL and without it subscriber service could not be used.\n- If the callback URL is provided without the service path then the `websub:SubscriberService` will be attached to the default service path which is `/`.\n\n#### 2.2.4. Unsubscribing from the `hub`\n\nAs per the WebSub Specification a `subscriber` should be able to subscribe to a particular `topic` in a specific `hub`. \nAs the counterpart subscriber should be able to unsubscribe from a previously subscribed `topic` in a specific `hub`. \nEven though the specification does not clearly define when this unsubscription should happen, it is obvious that this \nshould happen whenever `subscriber` is terminated.  \n\nThe key functionalities expected from the unsubscription flow as follows:  \n- Developer should manually enable this feature by configuring `unsubscribeOnShutdown` in `websub:SubscriberServiceConfig` annotation.\n- Developer should be able to configure unsubscription verification time-out using `gracefulShutdownPeriod` configuration in `websub:ListenerConfiguration`.\n- Unsubscription flow should be initiated whenever the graceful stop is invoked in `websub:Listener`.\n- If multiple `websub:SubscriberService` instances are attached to one `websub:Listener`, all the subscriber instances which have enabled `unsubscribeOnShutdown` should initiate unsubscription on listener shutdown.  \n- Unsubscription flow should be initiated only if `graceful stop` is invoked, and will not be executed for `immediate stop` .  \n"},"__N_SSG":true}