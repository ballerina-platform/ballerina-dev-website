{"pageProps":{"tagline":"Process a composite message","desc":"Composed Message Processor splits the message up, routes the sub-messages to the appropriate destinations and re-aggregates the responses back into a single message.","category":"Message Routing","index":31,"helps":"Ballerina has `foreach`, `while` and query expressions to iterate over data. During iteration, Ballerina can send and receive messages. Ballerina can extract, manipulate and store data in messages using variables.","tags":["Composed Message Processor","Aggregator","Content Based Router"],"link":"https://www.enterpriseintegrationpatterns.com/patterns/messaging/DistributionAggregate.html","content":[{"headerCode":"<pre class=\"shiki github-light\" style=\"background-color:#fff;color:#24292e\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color:#D73A49\">import</span><span style=\"color:#24292E\"> ballerina/http;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#D73A49\">type</span><span style=\"color:#6F42C1\"> SalesByStateRequest</span><span style=\"color:#D73A49\"> record</span><span style=\"color:#24292E\"> {</span><span style=\"color:#D73A49\">|</span></span>\n<span class=\"line\"><span style=\"color:#005CC5\">    string</span><span style=\"color:#24292E\">[] states;</span></span>\n<span class=\"line\"><span style=\"color:#D73A49\">|</span><span style=\"color:#24292E\">};</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#D73A49\">type</span><span style=\"color:#6F42C1\"> SalesByState</span><span style=\"color:#D73A49\"> record</span><span style=\"color:#24292E\"> {</span><span style=\"color:#D73A49\">|</span></span>\n<span class=\"line\"><span style=\"color:#005CC5\">    decimal</span><span style=\"color:#24292E\"> revenue;</span></span>\n<span class=\"line\"><span style=\"color:#005CC5\">    decimal</span><span style=\"color:#24292E\"> operatingExpenses;</span></span>\n<span class=\"line\"><span style=\"color:#005CC5\">    int</span><span style=\"color:#24292E\"> production;</span></span>\n<span class=\"line\"><span style=\"color:#005CC5\">    int</span><span style=\"color:#24292E\"> totalEmployees;</span></span>\n<span class=\"line\"><span style=\"color:#D73A49\">|</span><span style=\"color:#24292E\">};</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#D73A49\">type</span><span style=\"color:#6F42C1\"> AggregratedSales</span><span style=\"color:#D73A49\"> record</span><span style=\"color:#24292E\"> {</span><span style=\"color:#D73A49\">|</span></span>\n<span class=\"line\"><span style=\"color:#D73A49\">    map&#x3C;</span><span style=\"color:#005CC5\">decimal</span><span style=\"color:#D73A49\">></span><span style=\"color:#24292E\"> revenueByState </span><span style=\"color:#D73A49\">=</span><span style=\"color:#24292E\"> {};</span></span>\n<span class=\"line\"><span style=\"color:#005CC5\">    decimal</span><span style=\"color:#24292E\"> totalRevenue </span><span style=\"color:#D73A49\">=</span><span style=\"color:#005CC5\"> 0.0</span><span style=\"color:#24292E\">;</span></span>\n<span class=\"line\"><span style=\"color:#005CC5\">    decimal</span><span style=\"color:#24292E\"> maxRevenue </span><span style=\"color:#D73A49\">=</span><span style=\"color:#005CC5\"> 0.0</span><span style=\"color:#24292E\">;</span></span>\n<span class=\"line\"><span style=\"color:#005CC5\">    string</span><span style=\"color:#24292E\"> maxRevenueState </span><span style=\"color:#D73A49\">=</span><span style=\"color:#032F62\"> \"\"</span><span style=\"color:#24292E\">;</span></span>\n<span class=\"line\"><span style=\"color:#D73A49\">    map&#x3C;</span><span style=\"color:#005CC5\">decimal</span><span style=\"color:#D73A49\">></span><span style=\"color:#24292E\"> operatingExpensesByState </span><span style=\"color:#D73A49\">=</span><span style=\"color:#24292E\"> {};</span></span>\n<span class=\"line\"><span style=\"color:#005CC5\">    decimal</span><span style=\"color:#24292E\"> totalOperatingExpenses </span><span style=\"color:#D73A49\">=</span><span style=\"color:#005CC5\"> 0.0</span><span style=\"color:#24292E\">;</span></span>\n<span class=\"line\"><span style=\"color:#005CC5\">    int</span><span style=\"color:#24292E\"> totalProduction </span><span style=\"color:#D73A49\">=</span><span style=\"color:#005CC5\"> 0</span><span style=\"color:#24292E\">;</span></span>\n<span class=\"line\"><span style=\"color:#D73A49\">    map&#x3C;</span><span style=\"color:#005CC5\">int</span><span style=\"color:#D73A49\">></span><span style=\"color:#24292E\"> productivityByState </span><span style=\"color:#D73A49\">=</span><span style=\"color:#24292E\"> {};</span></span>\n<span class=\"line\"><span style=\"color:#D73A49\">|</span><span style=\"color:#24292E\">};</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#D73A49\">final</span><span style=\"color:#D73A49\"> map&#x3C;</span><span style=\"color:#24292E\">http</span><span style=\"color:#D73A49\">:</span><span style=\"color:#24292E\">Client</span><span style=\"color:#D73A49\">></span><span style=\"color:#24292E\"> stateRoutes </span><span style=\"color:#D73A49\">=</span><span style=\"color:#24292E\"> {</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">    Texas</span><span style=\"color:#D73A49\">:</span><span style=\"color:#D73A49\"> check</span><span style=\"color:#6F42C1\"> new </span><span style=\"color:#24292E\">(</span><span style=\"color:#032F62\">\"http://api.texas.office.com.balmock.io\"</span><span style=\"color:#24292E\">),</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">    Ohio</span><span style=\"color:#D73A49\">:</span><span style=\"color:#D73A49\"> check</span><span style=\"color:#6F42C1\"> new </span><span style=\"color:#24292E\">(</span><span style=\"color:#032F62\">\"http://api.ohio.office.com.balmock.io\"</span><span style=\"color:#24292E\">),</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">    Florida</span><span style=\"color:#D73A49\">:</span><span style=\"color:#D73A49\"> check</span><span style=\"color:#6F42C1\"> new </span><span style=\"color:#24292E\">(</span><span style=\"color:#032F62\">\"http://api.florida.office.com.balmock.io\"</span><span style=\"color:#24292E\">)</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">};</span></span>\n<span class=\"line\"></span></code></pre>","mainCode":"<pre class=\"shiki github-light\" style=\"background-color:#fff;color:#24292e\" tabindex=\"0\"><code><span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#D73A49\">service</span><span style=\"color:#6F42C1\"> /api/v1</span><span style=\"color:#D73A49\"> on</span><span style=\"color:#D73A49\"> new</span><span style=\"color:#24292E\"> http:Listener(</span><span style=\"color:#005CC5\">8080</span><span style=\"color:#24292E\">) {</span></span>\n<span class=\"line\"><span style=\"color:#D73A49\">    resource</span><span style=\"color:#D73A49\"> function</span><span style=\"color:#6F42C1\"> post</span><span style=\"color:#6F42C1\"> dashboard</span><span style=\"color:#24292E\">(</span><span style=\"color:#E36209\">SalesByStateRequest</span><span style=\"color:#E36209\"> salesRequest</span><span style=\"color:#24292E\">) </span><span style=\"color:#D73A49\">returns</span><span style=\"color:#24292E\"> AggregratedSales</span><span style=\"color:#D73A49\">|error</span><span style=\"color:#24292E\"> {</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">        AggregratedSales summary </span><span style=\"color:#D73A49\">=</span><span style=\"color:#24292E\"> {};</span></span>\n<span class=\"line\"><span style=\"color:#D73A49\">        foreach </span><span style=\"color:#005CC5\">string</span><span style=\"color:#24292E\"> state </span><span style=\"color:#D73A49\">in</span><span style=\"color:#24292E\"> salesRequest.states {</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">            http</span><span style=\"color:#D73A49\">:</span><span style=\"color:#24292E\">Client? stateClient </span><span style=\"color:#D73A49\">=</span><span style=\"color:#24292E\"> stateRoutes[state];</span></span>\n<span class=\"line\"><span style=\"color:#D73A49\">            if</span><span style=\"color:#24292E\"> stateClient </span><span style=\"color:#D73A49\">==</span><span style=\"color:#24292E\"> () {</span></span>\n<span class=\"line\"><span style=\"color:#D73A49\">                return</span><span style=\"color:#D73A49\"> error</span><span style=\"color:#24292E\">(</span><span style=\"color:#032F62\">\"Invalid state provided\"</span><span style=\"color:#24292E\">);</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">            }</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">            SalesByState salesByState </span><span style=\"color:#D73A49\">=</span><span style=\"color:#D73A49\"> check</span><span style=\"color:#24292E\"> stateClient</span><span style=\"color:#D73A49\">->/</span><span style=\"color:#6F42C1\">sales</span><span style=\"color:#24292E\">();</span></span>\n<span class=\"line\"><span style=\"color:#6F42C1\">            aggregateSales</span><span style=\"color:#24292E\">(</span><span style=\"color:#E36209\">summary</span><span style=\"color:#24292E\">, </span><span style=\"color:#E36209\">state</span><span style=\"color:#24292E\">, </span><span style=\"color:#E36209\">salesByState</span><span style=\"color:#24292E\">);</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">        }</span></span>\n<span class=\"line\"><span style=\"color:#D73A49\">        return</span><span style=\"color:#24292E\"> summary;</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">    }</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#D73A49\">function</span><span style=\"color:#6F42C1\"> aggregateSales</span><span style=\"color:#24292E\">(</span><span style=\"color:#E36209\">AggregratedSales</span><span style=\"color:#E36209\"> summary</span><span style=\"color:#24292E\">, </span><span style=\"color:#005CC5\">string</span><span style=\"color:#E36209\"> state</span><span style=\"color:#24292E\">, </span><span style=\"color:#E36209\">SalesByState</span><span style=\"color:#E36209\"> salesByState</span><span style=\"color:#24292E\">) {</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">    summary.revenueByState[state] </span><span style=\"color:#D73A49\">=</span><span style=\"color:#24292E\"> salesByState.revenue;</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">    summary.totalRevenue </span><span style=\"color:#D73A49\">+=</span><span style=\"color:#24292E\"> salesByState.revenue;</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">    summary.operatingExpensesByState[state] </span><span style=\"color:#D73A49\">=</span><span style=\"color:#24292E\"> salesByState.operatingExpenses;</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">    summary.totalOperatingExpenses </span><span style=\"color:#D73A49\">+=</span><span style=\"color:#24292E\"> salesByState.operatingExpenses;</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">    summary.totalProduction </span><span style=\"color:#D73A49\">+=</span><span style=\"color:#24292E\"> salesByState.production;</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">    summary.maxRevenueState </span><span style=\"color:#D73A49\">=</span><span style=\"color:#24292E\"> summary.maxRevenue </span><span style=\"color:#D73A49\">&#x3C;</span><span style=\"color:#24292E\"> salesByState.revenue </span><span style=\"color:#D73A49\">?</span><span style=\"color:#24292E\"> state </span><span style=\"color:#D73A49\">:</span><span style=\"color:#24292E\"> summary.maxRevenueState;</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">    summary.maxRevenue </span><span style=\"color:#D73A49\">=</span><span style=\"color:#24292E\"> summary.maxRevenue </span><span style=\"color:#D73A49\">&#x3C;</span><span style=\"color:#24292E\"> salesByState.revenue </span><span style=\"color:#D73A49\">?</span><span style=\"color:#24292E\"> salesByState.revenue </span><span style=\"color:#D73A49\">:</span><span style=\"color:#24292E\"> summary.maxRevenue;</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">    summary.productivityByState[state] </span><span style=\"color:#D73A49\">=</span><span style=\"color:#24292E\"> salesByState.production </span><span style=\"color:#D73A49\">/</span><span style=\"color:#24292E\"> salesByState.totalEmployees;</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">}</span></span>\n<span class=\"line\"></span></code></pre>","raw":"import ballerina/http;\n\ntype SalesByStateRequest record {|\n    string[] states;\n|};\n\ntype SalesByState record {|\n    decimal revenue;\n    decimal operatingExpenses;\n    int production;\n    int totalEmployees;\n|};\n\ntype AggregratedSales record {|\n    map<decimal> revenueByState = {};\n    decimal totalRevenue = 0.0;\n    decimal maxRevenue = 0.0;\n    string maxRevenueState = \"\";\n    map<decimal> operatingExpensesByState = {};\n    decimal totalOperatingExpenses = 0.0;\n    int totalProduction = 0;\n    map<int> productivityByState = {};\n|};\n\nfinal map<http:Client> stateRoutes = {\n    Texas: check new (\"http://api.texas.office.com.balmock.io\"),\n    Ohio: check new (\"http://api.ohio.office.com.balmock.io\"),\n    Florida: check new (\"http://api.florida.office.com.balmock.io\")\n};\n\nservice /api/v1 on new http:Listener(8080) {\n    resource function post dashboard(SalesByStateRequest salesRequest) returns AggregratedSales|error {\n        AggregratedSales summary = {};\n        foreach string state in salesRequest.states {\n            http:Client? stateClient = stateRoutes[state];\n            if stateClient == () {\n                return error(\"Invalid state provided\");\n            }\n            SalesByState salesByState = check stateClient->/sales();\n            aggregateSales(summary, state, salesByState);\n        }\n        return summary;\n    }\n}\n\nfunction aggregateSales(AggregratedSales summary, string state, SalesByState salesByState) {\n    summary.revenueByState[state] = salesByState.revenue;\n    summary.totalRevenue += salesByState.revenue;\n    summary.operatingExpensesByState[state] = salesByState.operatingExpenses;\n    summary.totalOperatingExpenses += salesByState.operatingExpenses;\n    summary.totalProduction += salesByState.production;\n    summary.maxRevenueState = summary.maxRevenue < salesByState.revenue ? state : summary.maxRevenueState;\n    summary.maxRevenue = summary.maxRevenue < salesByState.revenue ? salesByState.revenue : summary.maxRevenue;\n    summary.productivityByState[state] = salesByState.production / salesByState.totalEmployees;\n}\n","name":"composed-message-processor.bal"}],"name":" Composed Message Processor"},"__N_SSG":true}