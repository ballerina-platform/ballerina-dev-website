{"pageProps":{"tagline":"Wrap application data inside an envelope that is compliant with the messaging infrastructure","desc":"Envelope Wrapper wraps application data inside an envelope that is compliant with the messaging infrastructure.","category":"Message Transformation","index":36,"helps":"Ballerina provides a rich set of libraries to interact with various messaging protocols. Ballerina allows you to extract information from messages and create new messages, manipulating data in both the body and the header.","tags":["Envelope Wrapper","Content Enricher","Message Channel","Message"],"link":"https://www.enterpriseintegrationpatterns.com/patterns/messaging/EnvelopeWrapper.html","content":[{"headerCode":"<pre class=\"shiki github-light\" style=\"background-color: #fff\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color: #D73A49\">import</span><span style=\"color: #24292E\"> ballerina/http;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #D73A49\">type</span><span style=\"color: #24292E\"> </span><span style=\"color: #6F42C1\">RefundRequest</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">record</span><span style=\"color: #24292E\"> {</span><span style=\"color: #D73A49\">|</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    </span><span style=\"color: #005CC5\">string</span><span style=\"color: #24292E\"> request_id;</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    </span><span style=\"color: #005CC5\">string</span><span style=\"color: #24292E\"> email;</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    </span><span style=\"color: #005CC5\">string</span><span style=\"color: #24292E\"> client_id;</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    </span><span style=\"color: #005CC5\">string</span><span style=\"color: #24292E\"> capture_id;</span></span>\n<span class=\"line\"><span style=\"color: #D73A49\">|</span><span style=\"color: #24292E\">};</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #D73A49\">type</span><span style=\"color: #24292E\"> </span><span style=\"color: #6F42C1\">PaypalRespose</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">record</span><span style=\"color: #24292E\"> {</span><span style=\"color: #D73A49\">|</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    </span><span style=\"color: #005CC5\">string</span><span style=\"color: #24292E\"> status;</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    </span><span style=\"color: #005CC5\">string</span><span style=\"color: #24292E\"> message;</span></span>\n<span class=\"line\"><span style=\"color: #D73A49\">|</span><span style=\"color: #24292E\">};</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #D73A49\">final</span><span style=\"color: #24292E\"> http</span><span style=\"color: #D73A49\">:</span><span style=\"color: #24292E\">Client paypalClient </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">check</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">new</span><span style=\"color: #24292E\"> (</span><span style=\"color: #032F62\">&quot;http://api-m.sandbox.paypal.com.balmock.io&quot;</span><span style=\"color: #24292E\">);</span></span>\n<span class=\"line\"><span style=\"color: #D73A49\">final</span><span style=\"color: #24292E\"> </span><span style=\"color: #005CC5\">string</span><span style=\"color: #24292E\"> encodedHeader </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> {alg</span><span style=\"color: #D73A49\">:</span><span style=\"color: #24292E\"> </span><span style=\"color: #032F62\">&quot;none&quot;</span><span style=\"color: #24292E\">}.</span><span style=\"color: #6F42C1\">toString</span><span style=\"color: #24292E\">().</span><span style=\"color: #6F42C1\">toBytes</span><span style=\"color: #24292E\">().</span><span style=\"color: #6F42C1\">toBase64</span><span style=\"color: #24292E\">();</span></span>\n<span class=\"line\"></span></code></pre>","mainCode":"<pre class=\"shiki github-light\" style=\"background-color: #fff\" tabindex=\"0\"><code><span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #D73A49\">service</span><span style=\"color: #24292E\"> </span><span style=\"color: #6F42C1\">/paypal</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">on</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">new</span><span style=\"color: #24292E\"> http:Listener(</span><span style=\"color: #005CC5\">8080</span><span style=\"color: #24292E\">) {</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    </span><span style=\"color: #D73A49\">resource</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">function</span><span style=\"color: #24292E\"> </span><span style=\"color: #6F42C1\">post</span><span style=\"color: #24292E\"> </span><span style=\"color: #6F42C1\">refund</span><span style=\"color: #24292E\">(</span><span style=\"color: #E36209\">RefundRequest</span><span style=\"color: #24292E\"> </span><span style=\"color: #E36209\">refundReq</span><span style=\"color: #24292E\">) </span><span style=\"color: #D73A49\">returns</span><span style=\"color: #24292E\"> PaypalRespose</span><span style=\"color: #D73A49\">|error</span><span style=\"color: #24292E\"> {</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        </span><span style=\"color: #6A737D\">// Generate PayPal-Auth-Assertion.</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        </span><span style=\"color: #005CC5\">string</span><span style=\"color: #24292E\"> authAssertionValue </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> </span><span style=\"color: #6F42C1\">getAuthAssertionValue</span><span style=\"color: #24292E\">(refundReq.client_id, refundReq.email);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #24292E\">        http</span><span style=\"color: #D73A49\">:</span><span style=\"color: #24292E\">Request request </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">new</span><span style=\"color: #24292E\">;</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        request.</span><span style=\"color: #6F42C1\">addHeader</span><span style=\"color: #24292E\">(</span><span style=\"color: #032F62\">&quot;PayPal-Request-Id&quot;</span><span style=\"color: #24292E\">, refundReq.request_id);</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        request.</span><span style=\"color: #6F42C1\">addHeader</span><span style=\"color: #24292E\">(</span><span style=\"color: #032F62\">&quot;PayPal-Auth-Assertion&quot;</span><span style=\"color: #24292E\">, </span><span style=\"color: #E36209\">authAssertionValue</span><span style=\"color: #24292E\">);</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        </span><span style=\"color: #D73A49\">return</span><span style=\"color: #24292E\"> paypalClient</span><span style=\"color: #D73A49\">-&gt;/</span><span style=\"color: #24292E\">v2</span><span style=\"color: #D73A49\">/</span><span style=\"color: #24292E\">payments</span><span style=\"color: #D73A49\">/</span><span style=\"color: #24292E\">captures</span><span style=\"color: #D73A49\">/</span><span style=\"color: #24292E\">[refundReq.capture_id]</span><span style=\"color: #D73A49\">/</span><span style=\"color: #24292E\">refund.</span><span style=\"color: #6F42C1\">post</span><span style=\"color: #24292E\">(</span><span style=\"color: #E36209\">request</span><span style=\"color: #24292E\">);</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    }</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #D73A49\">isolated</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">function</span><span style=\"color: #24292E\"> </span><span style=\"color: #6F42C1\">getAuthAssertionValue</span><span style=\"color: #24292E\">(</span><span style=\"color: #005CC5\">string</span><span style=\"color: #24292E\"> </span><span style=\"color: #E36209\">client_id</span><span style=\"color: #24292E\">, </span><span style=\"color: #005CC5\">string</span><span style=\"color: #24292E\"> </span><span style=\"color: #E36209\">email</span><span style=\"color: #24292E\">) </span><span style=\"color: #D73A49\">returns</span><span style=\"color: #24292E\"> </span><span style=\"color: #005CC5\">string</span><span style=\"color: #24292E\"> {</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    </span><span style=\"color: #D73A49\">map&lt;</span><span style=\"color: #005CC5\">string</span><span style=\"color: #D73A49\">&gt;</span><span style=\"color: #24292E\"> payload </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> {</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        iss</span><span style=\"color: #D73A49\">:</span><span style=\"color: #24292E\"> client_id,</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        payer_id</span><span style=\"color: #D73A49\">:</span><span style=\"color: #24292E\"> email</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    };</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    </span><span style=\"color: #005CC5\">string</span><span style=\"color: #24292E\"> encodedPayload </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> payload.</span><span style=\"color: #6F42C1\">toString</span><span style=\"color: #24292E\">().</span><span style=\"color: #6F42C1\">toBytes</span><span style=\"color: #24292E\">().</span><span style=\"color: #6F42C1\">toBase64</span><span style=\"color: #24292E\">();</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    </span><span style=\"color: #D73A49\">return</span><span style=\"color: #24292E\"> </span><span style=\"color: #005CC5\">string</span><span style=\"color: #24292E\"> </span><span style=\"color: #032F62\">`${</span><span style=\"color: #24292E\">encodedHeader</span><span style=\"color: #032F62\">}.${</span><span style=\"color: #24292E\">encodedPayload</span><span style=\"color: #032F62\">}.`</span><span style=\"color: #24292E\">;</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">}</span></span>\n<span class=\"line\"></span></code></pre>","raw":"import ballerina/http;\n\ntype RefundRequest record {|\n    string request_id;\n    string email;\n    string client_id;\n    string capture_id;\n|};\n\ntype PaypalRespose record {|\n    string status;\n    string message;\n|};\n\nfinal http:Client paypalClient = check new (\"http://api-m.sandbox.paypal.com.balmock.io\");\nfinal string encodedHeader = {alg: \"none\"}.toString().toBytes().toBase64();\n\nservice /paypal on new http:Listener(8080) {\n    resource function post refund(RefundRequest refundReq) returns PaypalRespose|error {\n        // Generate PayPal-Auth-Assertion.\n        string authAssertionValue = getAuthAssertionValue(refundReq.client_id, refundReq.email);\n\n        http:Request request = new;\n        request.addHeader(\"PayPal-Request-Id\", refundReq.request_id);\n        request.addHeader(\"PayPal-Auth-Assertion\", authAssertionValue);\n        return paypalClient->/v2/payments/captures/[refundReq.capture_id]/refund.post(request);\n    }\n}\n\nisolated function getAuthAssertionValue(string client_id, string email) returns string {\n    map<string> payload = {\n        iss: client_id,\n        payer_id: email\n    };\n    string encodedPayload = payload.toString().toBytes().toBase64();\n    return string `${encodedHeader}.${encodedPayload}.`;\n}\n","name":"envelope-wrapper.bal"}],"name":" Envelope Wrapper"},"__N_SSG":true}