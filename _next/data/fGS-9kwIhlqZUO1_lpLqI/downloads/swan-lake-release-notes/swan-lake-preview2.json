{"pageProps":{"frontmatter":{"layout":"ballerina-left-nav-release-notes","title":"Swan Lake Preview 2","permalink":"/downloads/swan-lake-release-notes/swan-lake-preview2/","active":"swan-lake-preview2","redirect_from":["/downloads/swan-lake-release-notes/swan-lake-preview2"]},"content":"### Overview of Ballerina Swan Lake Preview 2\nThis release is the second preview version of Ballerina Swan Lake. This release includes a new set of language features along with improvements and bug fixes to the compiler, runtime, standard libraries, and developer tooling.\n\nYou can use the update tool to update to Ballerina Swan Lake Preview 2 as follows.\n\n**For existing users:**\n\nIf you are already using jBallerina, you can directly update your distribution to the Swan Lake channel using the [Ballerina update tool](/learn/cli-documentation/update-tool/). To do this, first, execute the command below to get the update tool updated to its latest version. \n                        \n> `ballerina update`\n\n Next, execute the command below to update to Swan Lake Preview 2.\n\n > `ballerina dist pull slp2`                  \n\nHowever, if you are using a jBallerina version below 1.1.0, install via the [installers](https://ballerina.io/downloads/).\n\n**For new users:**\n\nIf you have not installed jBallerina, then download the [installers](https://ballerina.io/downloads/) to install.\n \n### Highlights\n- Support for resilient parsing\n- Improved support for immutability\n- Improved support to convert compatible values to and from JSON \n- Improved log API to support changing module log levels at runtime\n- Improved mocking API in the test framework\n- Improved Docker images using thin JAR\n\n### What's new in Ballerina Swan Lake Preview 2\n\n#### Language\nThe language implementation is based on the [Ballerina Language Specifications Draft 2020-06-18](https://ballerina.io/spec/lang/draft/v2020-06-18/).   \n \n##### Resilient parsing support\nResilient parsing support has been added to the compiler. It is now capable of performing semantic validation for source code even when there are syntax errors.\n\n##### Improvements related to immutability\n\n###### `readonly` fields in the mapping constructor expression\n\nA specific field (key-value pair or variable name) in a mapping constructor expression can now be marked as `readonly`. Such a field expects an immutable value and the field cannot be updated once the mapping value is constructed.\n\n```ballerina\ntype Employee record {|\n   Details details;\n   string department;\n   float salary;\n|};\n \ntype Details record {|\n   string name;\n   int id;\n|};\n \npublic function main() {\n   string department = \"legal\";\n \n   Employee employee = {\n       readonly details: {\n           name: \"Amy\",\n           id: 112244\n       },\n       readonly department,\n       salary: 100.0\n   };\n}\n```\n\nAttempting to update a field that was specified as a `readonly` field will result in an error.\n\n```ballerina\nemployee.department = \"finance\"; // panics\n```\n\nIf a constructor expression is used as a value with a `readonly` field, the constructed value will be an immutable value. The following evaluates to true.\n\n```ballerina\nemployee.details.isReadOnly()\n```\n\n###### `readonly` as the contextually expected type for mapping and list constructor expressions\n\nThe `readonly` type can now be used as the contextually-expected type for mapping and list constructor expressions. This results in the creation of a record or an array value, which is immutable.\n\n```ballerina\nimport ballerina/io;\n\ntype Details record {|\n   string name;\n   string author;\n|};\n \npublic function main() {\n   Details & readonly greatExpectations = {\n       name: \"Great Expectations\",\n       author: \"Charles Dickens\"\n   };\n \n   readonly item = {\n       details: greatExpectations,\n       categories: [\"Charles Dickens\", \"novel\"]\n   };\n \n   // Prints true.   \n   io:println(item is readonly & record {|\n                                     Details details;\n                                     [string, string] categories;     \n                                 |});  \n}\n``` \n\n###### `<readonly>` casts to construct immutable values\n\nA value can now be constructed with its read-only bit set (i.e., as an immutable value) by using a cast to `<readonly>` with the constructor expression. By definition, all the values used within the constructor expression should be immutable.\n\n```ballerina\ntype Details record {|\n   string name;\n   string author;\n|};\n \npublic function main() {\n   Details details = <readonly> {\n       name: \"Great Expectations\",\n       author: \"Charles Dickens\"\n   };\n}\n```\n\nSince `details` is created as an immutable value, the following check evaluates to `true`.\n\n```ballerina\ndetails.isReadOnly()\n```\n##### Passing arguments for required/defaultable parameters via the rest argument\n\nPreviously, the rest argument in a function/method call expression could only provide arguments for the rest parameter. A rest argument can now be used to provide arguments for required and/or defaultable parameters too.\n\n```ballerina\npublic function main() {\n   // Arguments for `name`, `department`, and `id` parameters.\n   [string, string, int] details = [\"Amy\", \"legal\", 212124];\n   Employee e1 = createEmployee(...details);\n \n   // Arguments for `department`, `id`, and `access` parameters.\n   [string, int, string, string] detailsAndAccess = [\"HR\", 112233, \"L2\", \"L3\"];\n   Employee e2 = createEmployee(\"Jo\", ...detailsAndAccess);\n}\n \nfunction createEmployee(string name, string department, int id = 1000,\n                       string... access) returns Employee => {\n   name, id, department, access\n};\n \ntype Employee record {|\n   string name;\n   string department;\n   int id;\n   string[] access;\n|};\n```\n\n##### Improvements related to JSON compatibility\n\nThree new methods have been introduced to the `ballerina/lang.value` module to facilitate converting to and from JSON. Additionally, the `toJsonString` method can now be called on `anydata` values.\n\n###### The `toJson` method\n`toJson` converts a value of type `anydata` to `json`. This does a deep copy of the value and converts values that do not belong to `json` into values that do. \n\n```ballerina\npublic function main() {\n   string[] arrString = [\"hello\", \"world\"];\n   json|error arrStringJson = arrString.toJson();\n}\n```\n\n###### The `toJsonString` method\n\n`toJsonString` converts a value of type `anydata` to a string that represents the value in the JSON format. It first converts the value to a JSON using `toJson` and then converts it to a `string`.\n\n```ballerina\npublic function main() {\n   map<string> address = {\n       line1: \"Line1\",\n       line2: \"Line2\"\n   };\n   string adrString = address.toJsonString();\n}\n```\n\n###### The `fromJsonWithType` method\n\n`fromJsonWithType` converts a value of type `json` to a user-specified type. The implementation is similar to `cloneWithType` except that it also does the inverse of the conversions done by `toJson`.\n\n```ballerina\ntype Student record {\n   int id;\n   string name;\n};\n \npublic function main() {\n   json studentJson = {\"id\": 3, \"name\": \"Pubudu\"};\n   Student|error student = studentJson.fromJsonWithType(Student);\n}\n```\n\n###### The `fromJsonStringWithType` method\n\n`fromJsonStringWithType` converts a string in JSON format to a user-specified type. This method can be described as a combination of `fromJsonString` followed by `fromJsonWithType`.\n\n```ballerina\ntype StringMap map<string>;\n \npublic function main() {\n   string str = \"{\\\"first_name\\\":\\\"Fname\\\", \\\"last_name\\\":\\\"Lname\\\"}\";\n   map<string>|error m = str.fromJsonStringWithType(StringMap);\n}\n```\n\n#### Standard library\n\n##### HTTP\n\nThe redirect client has been improved to support temporary and permanent redirects with the original requestâ€™s HTTP method. A new `allowAuthHeaders` field was introduced in the redirect configuration to get user consent before repeating sensitive data on subsequent requests.\n\n##### Log\n\nThe new `log:setModuleLogLevel` function allows users to set the module log level through the Log API.\n\n##### Config\n\nThe `config:getAsArray` and `config:getAsMap` functions now return immutable values. This way, the user can simply cast the returned value to the desired list type or mapping type without having to use `cloneWithType()`.\n\n##### Security\n\n- JWT signature validation with JWK has been improved by introducing a cache. This cache preloads the JWKs, and thereby, reduces the runtime latency added due to the HTTP call to the JWK endpoint when validating the signature.\n- An `auth:InvocationContext` record, which can be used as a data holder has been introduced. It can hold auth-related information such as authentication scheme, auth token, and authenticated user's ID, claims, and scopes preserved for a single request-response flow.\n\n##### WebSocket\n\nThe WebSocket client now supports cookies. A new field `cookies` has been introduced in the `http:WebSocketClientConfiguration` and `http:WebSocketFailoverClientConfiguration` records to specify the cookies.\n\n##### Runtime API\n\n- The `runtime:timeout` function has been removed. The `runtime:sleep` function can be used as the alternative.\n\nE.g., consider the following example, which uses the `runtime:timeout` function.\n\n```ballerina\nfuture<()> f1 = runtime:timeout(50);\n```\n\nThis can now be done as follows:\n\n```ballerina\nfuture<()> f1 = start runtime:sleep(50);\n```\n\n- The `runtime:getProperty` function has been removed. Java interoperability can be used as the alternative to access Java system properties.\n- The auth-related configurations have been moved out from the `runtime:InvocationContext` to the newly-introduced `auth:InvocationContext`.\n\n##### Module organization\n\nThe following standard libraries were moved to Ballerina Central. Previously, these modules were packed in the Ballerina distribution. With this change, these libraries can now be released independently.\n- ballerina/encoding\n- ballerina/jwt\n- ballerina/websub\n- ballerinax/rabbitmq\n\n#### Developer tools\n\n##### Test framework\n\n###### Improved mocking API\n\n**Object mocking**\n\nThe syntax for initializing a mock object was improved to remove the cast.\n\nPrevious syntax: \n\n```ballerina\nhttp:Client mockHttpClient = <http:Client>test:mock(http:Client);\n```\n\nNew syntax: \n\n```ballerina\nhttp:Client mockHttpClient = test:mock(http:Client);\n```\n\n**Function mocking**\n\nThe mocking API now supports scoping and stubbing of mock functions that are declared for functions in imported modules.\nWith the above support, the `@MockFn {}` and `@Mock {}` annotations have been unified and now all function mocks can be declared with the `@Mock {}` annotation.\n\nWith the improved mocking API, a function can be mocked as follows:\n\n```ballerina\nimport ballerina/math;\nimport ballerina/test;\n\n@test:Mock {\n    moduleName : \"ballerina/math\",\n    functionName : \"absInt\"\n}\ntest:MockFunction mock_absInt = new();\n\n@test:Config {}\npublic function testFunction() {\n    test:when(mock_absInt).thenReturn(100);\n    test:assertEquals(math:absInt(-5), 100);\n}\n```\n\n##### Deployment\n\nBy default, Docker images are now created using the thin JAR. Using the thin JAR improves the push and pull times significantly. Since layers are reused, disk space required to store thin JAR based images is less. \n\nThis can be changed to use the uber JAR by setting the `uberJar` field in the Docker or Kubernetes annotation to `true`. \n\nKubernetes annotations:\n```ballerina\n@kubernetes:Deployment {\n   uberJar: true\n}\n```\n\nDocker annotations:\n```ballerina\n@docker:Config {\n   uberJar: true\n}\n```\n","id":"swan-lake-preview2"},"__N_SSG":true}