{"pageProps":{"samples":{"code":"<pre class=\"shiki github-light\" style=\"background-color: #fff\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color: #D73A49\">import</span><span style=\"color: #24292E\"> ballerinax/edifact.d03a.retail.mREQOTE;</span></span>\n<span class=\"line\"><span style=\"color: #D73A49\">import</span><span style=\"color: #24292E\"> ballerina/file;</span></span>\n<span class=\"line\"><span style=\"color: #D73A49\">import</span><span style=\"color: #24292E\"> ballerina/ftp;</span></span>\n<span class=\"line\"><span style=\"color: #D73A49\">import</span><span style=\"color: #24292E\"> ballerina/io;</span></span>\n<span class=\"line\"><span style=\"color: #D73A49\">import</span><span style=\"color: #24292E\"> ballerinax/salesforce </span><span style=\"color: #D73A49\">as</span><span style=\"color: #24292E\"> sf;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #D73A49\">configurable</span><span style=\"color: #24292E\"> ftp</span><span style=\"color: #D73A49\">:</span><span style=\"color: #24292E\">ClientConfiguration ftpConfig </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">?</span><span style=\"color: #24292E\">;</span></span>\n<span class=\"line\"><span style=\"color: #D73A49\">configurable</span><span style=\"color: #24292E\"> </span><span style=\"color: #005CC5\">string</span><span style=\"color: #24292E\"> ftpNewQuotesPath </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">?</span><span style=\"color: #24292E\">;</span></span>\n<span class=\"line\"><span style=\"color: #D73A49\">configurable</span><span style=\"color: #24292E\"> </span><span style=\"color: #005CC5\">string</span><span style=\"color: #24292E\"> ftpProcessedQuotesPath </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">?</span><span style=\"color: #24292E\">;</span></span>\n<span class=\"line\"><span style=\"color: #D73A49\">configurable</span><span style=\"color: #24292E\"> sf</span><span style=\"color: #D73A49\">:</span><span style=\"color: #24292E\">ConnectionConfig salesforceConfig </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">?</span><span style=\"color: #24292E\">;</span></span>\n<span class=\"line\"><span style=\"color: #D73A49\">configurable</span><span style=\"color: #24292E\"> </span><span style=\"color: #005CC5\">string</span><span style=\"color: #24292E\"> salesforcePriceBookId </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">?</span><span style=\"color: #24292E\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #D73A49\">public</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">function</span><span style=\"color: #24292E\"> </span><span style=\"color: #6F42C1\">main</span><span style=\"color: #24292E\">() </span><span style=\"color: #D73A49\">returns</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">error?</span><span style=\"color: #24292E\"> {</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    sf</span><span style=\"color: #D73A49\">:</span><span style=\"color: #24292E\">Client sfClient </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">check</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">new</span><span style=\"color: #24292E\"> (</span><span style=\"color: #E36209\">salesforceConfig</span><span style=\"color: #24292E\">);</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    ftp</span><span style=\"color: #D73A49\">:</span><span style=\"color: #24292E\">Client ftpClient </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">check</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">new</span><span style=\"color: #24292E\"> ftp</span><span style=\"color: #D73A49\">:</span><span style=\"color: #6F42C1\">Client</span><span style=\"color: #24292E\">(</span><span style=\"color: #E36209\">ftpConfig</span><span style=\"color: #24292E\">);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #24292E\">    </span><span style=\"color: #6A737D\">// Get new quotes from the FTP new quotes directory, and iterate through them.</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    ftp</span><span style=\"color: #D73A49\">:</span><span style=\"color: #24292E\">FileInfo[] quoteList </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">check</span><span style=\"color: #24292E\"> ftpClient</span><span style=\"color: #D73A49\">-&gt;</span><span style=\"color: #6F42C1\">list</span><span style=\"color: #24292E\">(</span><span style=\"color: #E36209\">ftpNewQuotesPath</span><span style=\"color: #24292E\">);</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    </span><span style=\"color: #D73A49\">foreach </span><span style=\"color: #24292E\">ftp</span><span style=\"color: #D73A49\">:</span><span style=\"color: #24292E\">FileInfo quoteFile </span><span style=\"color: #D73A49\">in</span><span style=\"color: #24292E\"> quoteList {</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        </span><span style=\"color: #D73A49\">if</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">!</span><span style=\"color: #24292E\">quoteFile.name.</span><span style=\"color: #6F42C1\">endsWith</span><span style=\"color: #24292E\">(</span><span style=\"color: #032F62\">&quot;.edi&quot;</span><span style=\"color: #24292E\">) {</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">            </span><span style=\"color: #D73A49\">continue</span><span style=\"color: #24292E\">;</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        }</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #24292E\">        </span><span style=\"color: #6A737D\">// Fetch the EDI file containing the quote from the FTP server.</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        </span><span style=\"color: #D73A49\">stream&lt;</span><span style=\"color: #005CC5\">byte</span><span style=\"color: #24292E\">[] </span><span style=\"color: #D73A49\">&amp;</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">readonly</span><span style=\"color: #24292E\">, io</span><span style=\"color: #D73A49\">:</span><span style=\"color: #24292E\">Error?</span><span style=\"color: #D73A49\">&gt;</span><span style=\"color: #24292E\"> fileStream </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">check</span><span style=\"color: #24292E\"> ftpClient</span><span style=\"color: #D73A49\">-&gt;</span><span style=\"color: #6F42C1\">get</span><span style=\"color: #24292E\">(quoteFile.path);</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        </span><span style=\"color: #005CC5\">string</span><span style=\"color: #24292E\"> quoteText </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">check</span><span style=\"color: #24292E\"> </span><span style=\"color: #6F42C1\">streamToString</span><span style=\"color: #24292E\">(</span><span style=\"color: #E36209\">fileStream</span><span style=\"color: #24292E\">);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #24292E\">        </span><span style=\"color: #6A737D\">// Parse the EDI file and transform in to Ballerina record containing only the required data.</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        mREQOTE</span><span style=\"color: #D73A49\">:</span><span style=\"color: #24292E\">EDI_REQOTE_Request_for_quote_message quote </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">check</span><span style=\"color: #24292E\"> mREQOTE</span><span style=\"color: #D73A49\">:</span><span style=\"color: #6F42C1\">fromEdiString</span><span style=\"color: #24292E\">(</span><span style=\"color: #E36209\">quoteText</span><span style=\"color: #24292E\">);</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        QuoteRequest quoteRequest </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">check</span><span style=\"color: #24292E\"> </span><span style=\"color: #6F42C1\">transformQuoteRequest</span><span style=\"color: #24292E\">(</span><span style=\"color: #E36209\">quote</span><span style=\"color: #24292E\">);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #24292E\">        </span><span style=\"color: #6A737D\">// Get the corresponding account Id and oppurtunity Id from Salesforce.</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        </span><span style=\"color: #6A737D\">// Create a new opportunity if an opportunity with the given name does not exist. </span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        </span><span style=\"color: #D73A49\">stream&lt;</span><span style=\"color: #24292E\">AccountId, </span><span style=\"color: #D73A49\">error?&gt;</span><span style=\"color: #24292E\"> accQuery </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">check</span><span style=\"color: #24292E\"> sfClient</span><span style=\"color: #D73A49\">-&gt;</span><span style=\"color: #6F42C1\">query</span><span style=\"color: #24292E\">(</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">            </span><span style=\"color: #005CC5\">string</span><span style=\"color: #24292E\"> </span><span style=\"color: #032F62\">`SELECT Id FROM Account WHERE Name = &#39;${</span><span style=\"color: #24292E\">quoteRequest</span><span style=\"color: #032F62\">.</span><span style=\"color: #24292E\">accountName</span><span style=\"color: #032F62\">}&#39;`</span><span style=\"color: #24292E\">);</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        </span><span style=\"color: #D73A49\">record</span><span style=\"color: #24292E\"> {</span><span style=\"color: #D73A49\">|</span><span style=\"color: #24292E\">AccountId value;</span><span style=\"color: #D73A49\">|</span><span style=\"color: #24292E\">}</span><span style=\"color: #D73A49\">?</span><span style=\"color: #24292E\"> account </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">check</span><span style=\"color: #24292E\"> accQuery.</span><span style=\"color: #6F42C1\">next</span><span style=\"color: #24292E\">();</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        </span><span style=\"color: #D73A49\">if</span><span style=\"color: #24292E\"> account </span><span style=\"color: #D73A49\">is</span><span style=\"color: #24292E\"> () {</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">            </span><span style=\"color: #D73A49\">return</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">error</span><span style=\"color: #24292E\">(</span><span style=\"color: #032F62\">&quot;Account not found. Account name: &quot;</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">+</span><span style=\"color: #24292E\"> quoteRequest.accountName);</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        }</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        Opportunity opp </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> {</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">            Name</span><span style=\"color: #D73A49\">:</span><span style=\"color: #24292E\"> quoteRequest.oppName,</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">            AccountId</span><span style=\"color: #D73A49\">:</span><span style=\"color: #24292E\"> account.value.Id,</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">            Pricebook2Id</span><span style=\"color: #D73A49\">:</span><span style=\"color: #24292E\"> salesforcePriceBookId</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        };</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        </span><span style=\"color: #005CC5\">string</span><span style=\"color: #24292E\"> oppId </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> </span><span style=\"color: #032F62\">&quot;&quot;</span><span style=\"color: #24292E\">;</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        </span><span style=\"color: #D73A49\">stream&lt;</span><span style=\"color: #24292E\">OpportunityId, </span><span style=\"color: #D73A49\">error?&gt;</span><span style=\"color: #24292E\"> oppQuery </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">check</span><span style=\"color: #24292E\"> sfClient</span><span style=\"color: #D73A49\">-&gt;</span><span style=\"color: #6F42C1\">query</span><span style=\"color: #24292E\">(</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">            </span><span style=\"color: #005CC5\">string</span><span style=\"color: #24292E\"> </span><span style=\"color: #032F62\">`SELECT Id FROM Opportunity WHERE Name = &#39;${</span><span style=\"color: #24292E\">quoteRequest</span><span style=\"color: #032F62\">.</span><span style=\"color: #24292E\">oppName</span><span style=\"color: #032F62\">}&#39;`</span><span style=\"color: #24292E\">);</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        </span><span style=\"color: #D73A49\">record</span><span style=\"color: #24292E\"> {</span><span style=\"color: #D73A49\">|</span><span style=\"color: #24292E\">OpportunityId value;</span><span style=\"color: #D73A49\">|</span><span style=\"color: #24292E\">}</span><span style=\"color: #D73A49\">?</span><span style=\"color: #24292E\"> existingOpp </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">check</span><span style=\"color: #24292E\"> oppQuery.</span><span style=\"color: #6F42C1\">next</span><span style=\"color: #24292E\">();</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        </span><span style=\"color: #D73A49\">if</span><span style=\"color: #24292E\"> existingOpp </span><span style=\"color: #D73A49\">is</span><span style=\"color: #24292E\"> () {</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">            sf</span><span style=\"color: #D73A49\">:</span><span style=\"color: #24292E\">CreationResponse oppResult </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">check</span><span style=\"color: #24292E\"> sfClient</span><span style=\"color: #D73A49\">-&gt;</span><span style=\"color: #6F42C1\">create</span><span style=\"color: #24292E\">(</span><span style=\"color: #032F62\">&quot;Opportunity&quot;</span><span style=\"color: #24292E\">, </span><span style=\"color: #E36209\">opp</span><span style=\"color: #24292E\">);</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">            oppId </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> oppResult.id;</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        } </span><span style=\"color: #D73A49\">else</span><span style=\"color: #24292E\"> {</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">            oppId </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> existingOpp.value.Id;</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        }</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #24292E\">        </span><span style=\"color: #6A737D\">// Create opportunity line items for each item in the quote.</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        </span><span style=\"color: #D73A49\">foreach </span><span style=\"color: #24292E\">ItemData item </span><span style=\"color: #D73A49\">in</span><span style=\"color: #24292E\"> quoteRequest.itemData {</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">            </span><span style=\"color: #D73A49\">stream&lt;</span><span style=\"color: #24292E\">PriceBookEntry, </span><span style=\"color: #D73A49\">error?&gt;</span><span style=\"color: #24292E\"> query </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">check</span><span style=\"color: #24292E\"> sfClient</span><span style=\"color: #D73A49\">-&gt;</span><span style=\"color: #6F42C1\">query</span><span style=\"color: #24292E\">(</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">                </span><span style=\"color: #005CC5\">string</span><span style=\"color: #24292E\"> </span><span style=\"color: #032F62\">`SELECT UnitPrice FROM PricebookEntry WHERE Pricebook2Id = &#39;01s6C000000UN4PQAW&#39; AND Product2Id = &#39;${</span><span style=\"color: #24292E\">item</span><span style=\"color: #032F62\">.</span><span style=\"color: #24292E\">itemId</span><span style=\"color: #032F62\">}&#39;`</span><span style=\"color: #24292E\">);</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">            </span><span style=\"color: #D73A49\">record</span><span style=\"color: #24292E\"> {</span><span style=\"color: #D73A49\">|</span><span style=\"color: #24292E\">PriceBookEntry value;</span><span style=\"color: #D73A49\">|</span><span style=\"color: #24292E\">}</span><span style=\"color: #D73A49\">?</span><span style=\"color: #24292E\"> unionResult </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">check</span><span style=\"color: #24292E\"> query.</span><span style=\"color: #6F42C1\">next</span><span style=\"color: #24292E\">();</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">            </span><span style=\"color: #D73A49\">if</span><span style=\"color: #24292E\"> unionResult </span><span style=\"color: #D73A49\">is</span><span style=\"color: #24292E\"> () {</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">                </span><span style=\"color: #D73A49\">return</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">error</span><span style=\"color: #24292E\">(</span><span style=\"color: #005CC5\">string</span><span style=\"color: #24292E\"> </span><span style=\"color: #032F62\">`Pricebook entry not found. Opportunity name: ${</span><span style=\"color: #24292E\">quoteRequest</span><span style=\"color: #032F62\">.</span><span style=\"color: #24292E\">oppName</span><span style=\"color: #032F62\">}, Item ID: ${</span><span style=\"color: #24292E\">item</span><span style=\"color: #032F62\">.</span><span style=\"color: #24292E\">itemId</span><span style=\"color: #032F62\">}`</span><span style=\"color: #24292E\">);</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">            }</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">            OpportunityProduct oppProduct </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> {</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">                OpportunityId</span><span style=\"color: #D73A49\">:</span><span style=\"color: #24292E\"> oppId,</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">                Product2Id</span><span style=\"color: #D73A49\">:</span><span style=\"color: #24292E\"> item.itemId,</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">                Quantity</span><span style=\"color: #D73A49\">:</span><span style=\"color: #24292E\"> item.quantity,</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">                UnitPrice</span><span style=\"color: #D73A49\">:</span><span style=\"color: #24292E\"> unionResult.value.UnitPrice</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">            };</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">            _ </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">check</span><span style=\"color: #24292E\"> sfClient</span><span style=\"color: #D73A49\">-&gt;</span><span style=\"color: #6F42C1\">create</span><span style=\"color: #24292E\">(</span><span style=\"color: #032F62\">&quot;OpportunityLineItem&quot;</span><span style=\"color: #24292E\">, </span><span style=\"color: #E36209\">oppProduct</span><span style=\"color: #24292E\">);</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        }</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #24292E\">        </span><span style=\"color: #6A737D\">// Move the processed quote to the processed quotes FTP directory.</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        </span><span style=\"color: #D73A49\">check</span><span style=\"color: #24292E\"> ftpClient</span><span style=\"color: #D73A49\">-&gt;</span><span style=\"color: #6F42C1\">put</span><span style=\"color: #24292E\">(</span><span style=\"color: #D73A49\">check</span><span style=\"color: #24292E\"> </span><span style=\"color: #E36209\">file</span><span style=\"color: #D73A49\">:</span><span style=\"color: #6F42C1\">joinPath</span><span style=\"color: #24292E\">(</span><span style=\"color: #E36209\">ftpProcessedQuotesPath</span><span style=\"color: #24292E\">, quoteFile.name), quoteText.</span><span style=\"color: #6F42C1\">toBytes</span><span style=\"color: #24292E\">());</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        </span><span style=\"color: #D73A49\">check</span><span style=\"color: #24292E\"> ftpClient</span><span style=\"color: #D73A49\">-&gt;</span><span style=\"color: #6F42C1\">delete</span><span style=\"color: #24292E\">(quoteFile.path);</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    }</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #D73A49\">function</span><span style=\"color: #24292E\"> </span><span style=\"color: #6F42C1\">transformQuoteRequest</span><span style=\"color: #24292E\">(</span><span style=\"color: #E36209\">mREQOTE</span><span style=\"color: #D73A49\">:</span><span style=\"color: #24292E\">EDI_REQOTE_Request_for_quote_message quote) </span><span style=\"color: #D73A49\">returns</span><span style=\"color: #24292E\"> QuoteRequest</span><span style=\"color: #D73A49\">|error</span><span style=\"color: #24292E\"> {</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    QuoteRequest quoteRequest </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> {accountName</span><span style=\"color: #D73A49\">:</span><span style=\"color: #24292E\"> </span><span style=\"color: #032F62\">&quot;&quot;</span><span style=\"color: #24292E\">, oppName</span><span style=\"color: #D73A49\">:</span><span style=\"color: #24292E\"> </span><span style=\"color: #032F62\">&quot;&quot;</span><span style=\"color: #24292E\">};</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    mREQOTE</span><span style=\"color: #D73A49\">:</span><span style=\"color: #24292E\">Segment_group_1_GType[] segmentGroup1 </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> quote.Segment_group_1;</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    </span><span style=\"color: #D73A49\">foreach </span><span style=\"color: #24292E\">mREQOTE</span><span style=\"color: #D73A49\">:</span><span style=\"color: #24292E\">Segment_group_1_GType ref </span><span style=\"color: #D73A49\">in</span><span style=\"color: #24292E\"> segmentGroup1 {</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        </span><span style=\"color: #D73A49\">if</span><span style=\"color: #24292E\"> ref.REFERENCE.REFERENCE.Reference_code_qualifier </span><span style=\"color: #D73A49\">==</span><span style=\"color: #24292E\"> </span><span style=\"color: #032F62\">&quot;AES&quot;</span><span style=\"color: #24292E\"> {</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">            </span><span style=\"color: #005CC5\">string</span><span style=\"color: #24292E\">? oppId </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> ref.REFERENCE.REFERENCE.Reference_identifier;</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">            </span><span style=\"color: #D73A49\">if</span><span style=\"color: #24292E\"> oppId </span><span style=\"color: #D73A49\">is</span><span style=\"color: #24292E\"> () {</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">                </span><span style=\"color: #D73A49\">return</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">error</span><span style=\"color: #24292E\">(</span><span style=\"color: #032F62\">&quot;Opportunity ID is not given&quot;</span><span style=\"color: #24292E\">);</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">            }</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">            quoteRequest.oppName </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> oppId;</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        }</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    }</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    mREQOTE</span><span style=\"color: #D73A49\">:</span><span style=\"color: #24292E\">Segment_group_11_GType[] segmentGroup11 </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> quote.Segment_group_11;</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    </span><span style=\"color: #D73A49\">foreach </span><span style=\"color: #24292E\">mREQOTE</span><span style=\"color: #D73A49\">:</span><span style=\"color: #24292E\">Segment_group_11_GType party </span><span style=\"color: #D73A49\">in</span><span style=\"color: #24292E\"> segmentGroup11 {</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        </span><span style=\"color: #D73A49\">if</span><span style=\"color: #24292E\"> party.NAME_AND_ADDRESS.Party_function_code_qualifier </span><span style=\"color: #D73A49\">==</span><span style=\"color: #24292E\"> </span><span style=\"color: #032F62\">&quot;BY&quot;</span><span style=\"color: #24292E\"> {</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">            </span><span style=\"color: #005CC5\">string</span><span style=\"color: #24292E\">? prospectId </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> party.NAME_AND_ADDRESS?.PARTY_IDENTIFICATION_DETAILS?.Party_identifier;</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">            </span><span style=\"color: #D73A49\">if</span><span style=\"color: #24292E\"> prospectId </span><span style=\"color: #D73A49\">is</span><span style=\"color: #24292E\"> () {</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">                </span><span style=\"color: #D73A49\">return</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">error</span><span style=\"color: #24292E\">(</span><span style=\"color: #032F62\">&quot;Prospect identifier not available in quote.&quot;</span><span style=\"color: #24292E\">);</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">            }</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">            quoteRequest.accountName </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> prospectId;</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        }</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    }</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    mREQOTE</span><span style=\"color: #D73A49\">:</span><span style=\"color: #24292E\">Segment_group_27_GType[] items </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> quote.Segment_group_27;</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    </span><span style=\"color: #D73A49\">foreach </span><span style=\"color: #24292E\">mREQOTE</span><span style=\"color: #D73A49\">:</span><span style=\"color: #24292E\">Segment_group_27_GType item </span><span style=\"color: #D73A49\">in</span><span style=\"color: #24292E\"> items {</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        </span><span style=\"color: #005CC5\">string</span><span style=\"color: #24292E\">? itemId </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> item.LINE_ITEM.Line_item_identifier;</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        </span><span style=\"color: #D73A49\">if</span><span style=\"color: #24292E\"> itemId </span><span style=\"color: #D73A49\">is</span><span style=\"color: #24292E\"> () {</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">            </span><span style=\"color: #D73A49\">return</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">error</span><span style=\"color: #24292E\">(</span><span style=\"color: #032F62\">&quot;Item ID is not given&quot;</span><span style=\"color: #24292E\">);</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        }</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        ItemData itemData </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> {itemId};</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        mREQOTE</span><span style=\"color: #D73A49\">:</span><span style=\"color: #24292E\">QUANTITY_Type[] quantities </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> item.QUANTITY;</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        </span><span style=\"color: #D73A49\">foreach </span><span style=\"color: #24292E\">mREQOTE</span><span style=\"color: #D73A49\">:</span><span style=\"color: #24292E\">QUANTITY_Type quantity </span><span style=\"color: #D73A49\">in</span><span style=\"color: #24292E\"> quantities {</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">            </span><span style=\"color: #D73A49\">if</span><span style=\"color: #24292E\"> quantity.QUANTITY_DETAILS.Quantity_type_code_qualifier </span><span style=\"color: #D73A49\">==</span><span style=\"color: #24292E\"> </span><span style=\"color: #032F62\">&quot;21&quot;</span><span style=\"color: #24292E\"> {</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">                </span><span style=\"color: #005CC5\">int</span><span style=\"color: #D73A49\">|error</span><span style=\"color: #24292E\"> amount </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> </span><span style=\"color: #005CC5\">int</span><span style=\"color: #D73A49\">:</span><span style=\"color: #6F42C1\">fromString</span><span style=\"color: #24292E\">(quantity.QUANTITY_DETAILS.Quantity);</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">                </span><span style=\"color: #D73A49\">if</span><span style=\"color: #24292E\"> amount </span><span style=\"color: #D73A49\">is</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">error</span><span style=\"color: #24292E\"> {</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">                    </span><span style=\"color: #D73A49\">return</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">error</span><span style=\"color: #24292E\">(</span><span style=\"color: #032F62\">&quot;Quantity must be a valid number.&quot;</span><span style=\"color: #24292E\">);</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">                }</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">                itemData.quantity </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> amount;</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">                </span><span style=\"color: #D73A49\">break</span><span style=\"color: #24292E\">;</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">            }</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        }</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        quoteRequest.itemData.</span><span style=\"color: #6F42C1\">push</span><span style=\"color: #24292E\">(</span><span style=\"color: #E36209\">itemData</span><span style=\"color: #24292E\">);</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    }</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    </span><span style=\"color: #D73A49\">return</span><span style=\"color: #24292E\"> quoteRequest;</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #D73A49\">function</span><span style=\"color: #24292E\"> </span><span style=\"color: #6F42C1\">streamToString</span><span style=\"color: #24292E\">(</span><span style=\"color: #D73A49\">stream&lt;</span><span style=\"color: #005CC5\">byte</span><span style=\"color: #24292E\">[] </span><span style=\"color: #D73A49\">&amp;</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">readonly</span><span style=\"color: #24292E\">, </span><span style=\"color: #E36209\">io</span><span style=\"color: #D73A49\">:</span><span style=\"color: #24292E\">Error?</span><span style=\"color: #D73A49\">&gt;</span><span style=\"color: #24292E\"> </span><span style=\"color: #E36209\">inStream</span><span style=\"color: #24292E\">) </span><span style=\"color: #D73A49\">returns</span><span style=\"color: #24292E\"> </span><span style=\"color: #005CC5\">string</span><span style=\"color: #D73A49\">|error</span><span style=\"color: #24292E\"> {</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    </span><span style=\"color: #005CC5\">byte</span><span style=\"color: #24292E\">[] content </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> [];</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    </span><span style=\"color: #D73A49\">check</span><span style=\"color: #24292E\"> inStream.</span><span style=\"color: #6F42C1\">forEach</span><span style=\"color: #24292E\">(</span><span style=\"color: #D73A49\">function</span><span style=\"color: #24292E\"> (</span><span style=\"color: #005CC5\">byte</span><span style=\"color: #24292E\">[] </span><span style=\"color: #D73A49\">&amp;</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">readonly</span><span style=\"color: #24292E\"> </span><span style=\"color: #E36209\">chunk</span><span style=\"color: #24292E\">) {</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        content.</span><span style=\"color: #6F42C1\">push</span><span style=\"color: #24292E\">(...</span><span style=\"color: #E36209\">chunk</span><span style=\"color: #24292E\">);</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    });</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    </span><span style=\"color: #D73A49\">return</span><span style=\"color: #24292E\"> </span><span style=\"color: #005CC5\">string</span><span style=\"color: #D73A49\">:</span><span style=\"color: #6F42C1\">fromBytes</span><span style=\"color: #24292E\">(</span><span style=\"color: #E36209\">content</span><span style=\"color: #24292E\">);</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">}</span></span></code></pre>"},"content":"\nimport ballerinax/edifact.d03a.retail.mREQOTE;\nimport ballerina/file;\nimport ballerina/ftp;\nimport ballerina/io;\nimport ballerinax/salesforce as sf;\n\nconfigurable ftp:ClientConfiguration ftpConfig = ?;\nconfigurable string ftpNewQuotesPath = ?;\nconfigurable string ftpProcessedQuotesPath = ?;\nconfigurable sf:ConnectionConfig salesforceConfig = ?;\nconfigurable string salesforcePriceBookId = ?;\n\npublic function main() returns error? {\n    sf:Client sfClient = check new (salesforceConfig);\n    ftp:Client ftpClient = check new ftp:Client(ftpConfig);\n\n    // Get new quotes from the FTP new quotes directory, and iterate through them.\n    ftp:FileInfo[] quoteList = check ftpClient->list(ftpNewQuotesPath);\n    foreach ftp:FileInfo quoteFile in quoteList {\n        if !quoteFile.name.endsWith(\".edi\") {\n            continue;\n        }\n\n        // Fetch the EDI file containing the quote from the FTP server.\n        stream<byte[] & readonly, io:Error?> fileStream = check ftpClient->get(quoteFile.path);\n        string quoteText = check streamToString(fileStream);\n\n        // Parse the EDI file and transform in to Ballerina record containing only the required data.\n        mREQOTE:EDI_REQOTE_Request_for_quote_message quote = check mREQOTE:fromEdiString(quoteText);\n        QuoteRequest quoteRequest = check transformQuoteRequest(quote);\n\n        // Get the corresponding account Id and oppurtunity Id from Salesforce.\n        // Create a new opportunity if an opportunity with the given name does not exist. \n        stream<AccountId, error?> accQuery = check sfClient->query(\n            string `SELECT Id FROM Account WHERE Name = '${quoteRequest.accountName}'`);\n        record {|AccountId value;|}? account = check accQuery.next();\n        if account is () {\n            return error(\"Account not found. Account name: \" + quoteRequest.accountName);\n        }\n        Opportunity opp = {\n            Name: quoteRequest.oppName,\n            AccountId: account.value.Id,\n            Pricebook2Id: salesforcePriceBookId\n        };\n        string oppId = \"\";\n        stream<OpportunityId, error?> oppQuery = check sfClient->query(\n            string `SELECT Id FROM Opportunity WHERE Name = '${quoteRequest.oppName}'`);\n        record {|OpportunityId value;|}? existingOpp = check oppQuery.next();\n        if existingOpp is () {\n            sf:CreationResponse oppResult = check sfClient->create(\"Opportunity\", opp);\n            oppId = oppResult.id;\n        } else {\n            oppId = existingOpp.value.Id;\n        }\n\n        // Create opportunity line items for each item in the quote.\n        foreach ItemData item in quoteRequest.itemData {\n            stream<PriceBookEntry, error?> query = check sfClient->query(\n                string `SELECT UnitPrice FROM PricebookEntry WHERE Pricebook2Id = '01s6C000000UN4PQAW' AND Product2Id = '${item.itemId}'`);\n            record {|PriceBookEntry value;|}? unionResult = check query.next();\n            if unionResult is () {\n                return error(string `Pricebook entry not found. Opportunity name: ${quoteRequest.oppName}, Item ID: ${item.itemId}`);\n            }\n            OpportunityProduct oppProduct = {\n                OpportunityId: oppId,\n                Product2Id: item.itemId,\n                Quantity: item.quantity,\n                UnitPrice: unionResult.value.UnitPrice\n            };\n            _ = check sfClient->create(\"OpportunityLineItem\", oppProduct);\n        }\n\n        // Move the processed quote to the processed quotes FTP directory.\n        check ftpClient->put(check file:joinPath(ftpProcessedQuotesPath, quoteFile.name), quoteText.toBytes());\n        check ftpClient->delete(quoteFile.path);\n    }\n}\n\nfunction transformQuoteRequest(mREQOTE:EDI_REQOTE_Request_for_quote_message quote) returns QuoteRequest|error {\n    QuoteRequest quoteRequest = {accountName: \"\", oppName: \"\"};\n    mREQOTE:Segment_group_1_GType[] segmentGroup1 = quote.Segment_group_1;\n    foreach mREQOTE:Segment_group_1_GType ref in segmentGroup1 {\n        if ref.REFERENCE.REFERENCE.Reference_code_qualifier == \"AES\" {\n            string? oppId = ref.REFERENCE.REFERENCE.Reference_identifier;\n            if oppId is () {\n                return error(\"Opportunity ID is not given\");\n            }\n            quoteRequest.oppName = oppId;\n        }\n    }\n    mREQOTE:Segment_group_11_GType[] segmentGroup11 = quote.Segment_group_11;\n    foreach mREQOTE:Segment_group_11_GType party in segmentGroup11 {\n        if party.NAME_AND_ADDRESS.Party_function_code_qualifier == \"BY\" {\n            string? prospectId = party.NAME_AND_ADDRESS?.PARTY_IDENTIFICATION_DETAILS?.Party_identifier;\n            if prospectId is () {\n                return error(\"Prospect identifier not available in quote.\");\n            }\n            quoteRequest.accountName = prospectId;\n        }\n    }\n    mREQOTE:Segment_group_27_GType[] items = quote.Segment_group_27;\n    foreach mREQOTE:Segment_group_27_GType item in items {\n        string? itemId = item.LINE_ITEM.Line_item_identifier;\n        if itemId is () {\n            return error(\"Item ID is not given\");\n        }\n        ItemData itemData = {itemId};\n        mREQOTE:QUANTITY_Type[] quantities = item.QUANTITY;\n        foreach mREQOTE:QUANTITY_Type quantity in quantities {\n            if quantity.QUANTITY_DETAILS.Quantity_type_code_qualifier == \"21\" {\n                int|error amount = int:fromString(quantity.QUANTITY_DETAILS.Quantity);\n                if amount is error {\n                    return error(\"Quantity must be a valid number.\");\n                }\n                itemData.quantity = amount;\n                break;\n            }\n        }\n        quoteRequest.itemData.push(itemData);\n    }\n    return quoteRequest;\n}\n\nfunction streamToString(stream<byte[] & readonly, io:Error?> inStream) returns string|error {\n    byte[] content = [];\n    check inStream.forEach(function (byte[] & readonly chunk) {\n        content.push(...chunk);\n    });\n    return string:fromBytes(content);\n}\n"},"__N_SSG":true}