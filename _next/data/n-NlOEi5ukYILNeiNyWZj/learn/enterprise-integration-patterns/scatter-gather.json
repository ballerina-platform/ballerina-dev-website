{"pageProps":{"name":"Scatter-Gather","tagline":"Send messages to multiple recipients and re-aggregate the responses","desc":"Scatter-gather broadcasts a message to multiple recipients and re-aggregates the responses back into a single message.","category":"Message Routing","index":32,"helps":"Ballerina has a lightweight [concurrency](/learn/by-example/named-workers/) model with built-in syntax support. This helps to send messages parallelly and to wait on aggregation. Query expressions are convenient for transforming, ordering, and filtering the aggregated data.","tags":["Scatter-Gather","Aggregator","Message Channel","Message Endpoint","Message Router","Message"],"link":"https://www.enterpriseintegrationpatterns.com/patterns/messaging/BroadcastAggregate.html","content":[{"headerCode":"<pre class=\"shiki github-light\" style=\"background-color:#fff;color:#24292e\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color:#D73A49\">import</span><span style=\"color:#24292E\"> ballerina/http;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#D73A49\">type</span><span style=\"color:#6F42C1\"> CarRental</span><span style=\"color:#D73A49\"> record</span><span style=\"color:#24292E\"> {</span><span style=\"color:#D73A49\">|</span></span>\n<span class=\"line\"><span style=\"color:#005CC5\">    string</span><span style=\"color:#24292E\"> carType;</span></span>\n<span class=\"line\"><span style=\"color:#005CC5\">    string</span><span style=\"color:#24292E\"> price;</span></span>\n<span class=\"line\"><span style=\"color:#005CC5\">    string</span><span style=\"color:#24292E\"> resultLink;</span></span>\n<span class=\"line\"><span style=\"color:#005CC5\">    string</span><span style=\"color:#24292E\"> vendor;</span></span>\n<span class=\"line\"><span style=\"color:#D73A49\">|</span><span style=\"color:#24292E\">};</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#D73A49\">type</span><span style=\"color:#6F42C1\"> AvisResponse</span><span style=\"color:#D73A49\"> record</span><span style=\"color:#24292E\"> {</span></span>\n<span class=\"line\"><span style=\"color:#D73A49\">    record</span><span style=\"color:#24292E\"> {</span></span>\n<span class=\"line\"><span style=\"color:#D73A49\">        *</span><span style=\"color:#24292E\">CarRental;</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">    }[] result;</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">};</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#D73A49\">final</span><span style=\"color:#24292E\"> http</span><span style=\"color:#D73A49\">:</span><span style=\"color:#24292E\">Client hotwireEP </span><span style=\"color:#D73A49\">=</span><span style=\"color:#D73A49\"> check</span><span style=\"color:#D73A49\"> new</span><span style=\"color:#24292E\"> (</span><span style=\"color:#032F62\">\"http://api.hotwire.com.balmock.io\"</span><span style=\"color:#24292E\">);</span></span>\n<span class=\"line\"><span style=\"color:#D73A49\">final</span><span style=\"color:#24292E\"> http</span><span style=\"color:#D73A49\">:</span><span style=\"color:#24292E\">Client avisEP </span><span style=\"color:#D73A49\">=</span><span style=\"color:#D73A49\"> check</span><span style=\"color:#D73A49\"> new</span><span style=\"color:#24292E\"> (</span><span style=\"color:#032F62\">\"http://api.avis.com.balmock.io\"</span><span style=\"color:#24292E\">);</span></span>\n<span class=\"line\"></span></code></pre>","mainCode":"<pre class=\"shiki github-light\" style=\"background-color:#fff;color:#24292e\" tabindex=\"0\"><code><span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#D73A49\">service</span><span style=\"color:#6F42C1\"> /api/v1</span><span style=\"color:#D73A49\"> on</span><span style=\"color:#D73A49\"> new</span><span style=\"color:#24292E\"> http:Listener(</span><span style=\"color:#005CC5\">8080</span><span style=\"color:#24292E\">) {</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#D73A49\">    resource</span><span style=\"color:#D73A49\"> function</span><span style=\"color:#6F42C1\"> get</span><span style=\"color:#6F42C1\"> vehicles</span><span style=\"color:#24292E\">(</span><span style=\"color:#005CC5\">string</span><span style=\"color:#E36209\"> dropOffDateTime</span><span style=\"color:#24292E\">, </span><span style=\"color:#005CC5\">string</span><span style=\"color:#E36209\"> dropOffLocation</span><span style=\"color:#24292E\">, </span><span style=\"color:#005CC5\">string</span><span style=\"color:#E36209\"> pickupDateTime</span><span style=\"color:#24292E\">,</span></span>\n<span class=\"line\"><span style=\"color:#005CC5\">            string</span><span style=\"color:#E36209\"> pickupLocation</span><span style=\"color:#24292E\">) </span><span style=\"color:#D73A49\">returns</span><span style=\"color:#D73A49\"> map&#x3C;</span><span style=\"color:#24292E\">CarRental[]</span><span style=\"color:#D73A49\">>|error</span><span style=\"color:#24292E\"> {</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#D73A49\">        worker</span><span style=\"color:#24292E\"> hotwire </span><span style=\"color:#D73A49\">returns</span><span style=\"color:#24292E\"> CarRental[]</span><span style=\"color:#D73A49\">|error</span><span style=\"color:#24292E\"> {</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">            http</span><span style=\"color:#D73A49\">:</span><span style=\"color:#24292E\">Response hotwireResponse </span><span style=\"color:#D73A49\">=</span><span style=\"color:#D73A49\"> check</span><span style=\"color:#24292E\"> hotwireEP</span><span style=\"color:#D73A49\">->/</span><span style=\"color:#24292E\">v1</span><span style=\"color:#D73A49\">/</span><span style=\"color:#24292E\">search</span><span style=\"color:#D73A49\">/</span><span style=\"color:#24292E\">car.</span><span style=\"color:#6F42C1\">get</span><span style=\"color:#24292E\">(</span><span style=\"color:#E36209\">pickup</span><span style=\"color:#D73A49\"> =</span><span style=\"color:#24292E\"> pickupLocation,</span></span>\n<span class=\"line\"><span style=\"color:#E36209\">                dest</span><span style=\"color:#D73A49\"> =</span><span style=\"color:#24292E\"> dropOffLocation, </span><span style=\"color:#E36209\">startDate</span><span style=\"color:#D73A49\"> =</span><span style=\"color:#24292E\"> pickupDateTime, </span><span style=\"color:#E36209\">endDate</span><span style=\"color:#D73A49\"> =</span><span style=\"color:#24292E\"> dropOffDateTime</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">            );</span></span>\n<span class=\"line\"><span style=\"color:#D73A49\">            return</span><span style=\"color:#6F42C1\"> transformHotwireResponse</span><span style=\"color:#24292E\">(</span><span style=\"color:#D73A49\">check</span><span style=\"color:#24292E\"> hotwireResponse.</span><span style=\"color:#6F42C1\">getXmlPayload</span><span style=\"color:#24292E\">());</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">        }</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#D73A49\">        worker</span><span style=\"color:#24292E\"> avis </span><span style=\"color:#D73A49\">returns</span><span style=\"color:#24292E\"> CarRental[]</span><span style=\"color:#D73A49\">|error</span><span style=\"color:#24292E\"> {</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">            AvisResponse avisResponse </span><span style=\"color:#D73A49\">=</span><span style=\"color:#D73A49\"> check</span><span style=\"color:#24292E\"> avisEP</span><span style=\"color:#D73A49\">->/</span><span style=\"color:#24292E\">cars</span><span style=\"color:#D73A49\">/</span><span style=\"color:#24292E\">catalog</span><span style=\"color:#D73A49\">/</span><span style=\"color:#24292E\">v1</span><span style=\"color:#D73A49\">/</span><span style=\"color:#24292E\">vehicles</span><span style=\"color:#D73A49\">/</span><span style=\"color:#24292E\">rates.</span><span style=\"color:#6F42C1\">get</span><span style=\"color:#24292E\">(</span><span style=\"color:#E36209\">brand</span><span style=\"color:#D73A49\"> =</span><span style=\"color:#032F62\"> \"Avis\"</span><span style=\"color:#24292E\">,</span></span>\n<span class=\"line\"><span style=\"color:#E36209\">                country_code</span><span style=\"color:#D73A49\"> =</span><span style=\"color:#032F62\"> \"US\"</span><span style=\"color:#24292E\">, </span><span style=\"color:#E36209\">dropOff_date</span><span style=\"color:#D73A49\"> =</span><span style=\"color:#24292E\"> dropOffDateTime, </span><span style=\"color:#E36209\">dropoff_location</span><span style=\"color:#D73A49\"> =</span><span style=\"color:#24292E\"> dropOffLocation,</span></span>\n<span class=\"line\"><span style=\"color:#E36209\">                pickup_date</span><span style=\"color:#D73A49\"> =</span><span style=\"color:#24292E\"> pickupDateTime, </span><span style=\"color:#E36209\">pickup_location</span><span style=\"color:#D73A49\"> =</span><span style=\"color:#24292E\"> pickupLocation</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">            );</span></span>\n<span class=\"line\"><span style=\"color:#D73A49\">            return</span><span style=\"color:#6F42C1\"> transformAvisResponse</span><span style=\"color:#24292E\">(</span><span style=\"color:#E36209\">avisResponse</span><span style=\"color:#24292E\">);</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">        }</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#005CC5\">        var</span><span style=\"color:#24292E\"> responses </span><span style=\"color:#D73A49\">=</span><span style=\"color:#D73A49\"> wait</span><span style=\"color:#24292E\"> {hotwire, avis};</span></span>\n<span class=\"line\"><span style=\"color:#D73A49\">        return</span><span style=\"color:#D73A49\"> map</span><span style=\"color:#D73A49\"> from</span><span style=\"color:#005CC5\"> var</span><span style=\"color:#24292E\"> [vendor, carRental] </span><span style=\"color:#D73A49\">in</span><span style=\"color:#24292E\"> responses.entries()</span></span>\n<span class=\"line\"><span style=\"color:#D73A49\">            where</span><span style=\"color:#24292E\"> carRental </span><span style=\"color:#D73A49\">!is</span><span style=\"color:#D73A49\"> error</span></span>\n<span class=\"line\"><span style=\"color:#D73A49\">            select</span><span style=\"color:#24292E\"> [vendor, carRental];</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">    }</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#D73A49\">function</span><span style=\"color:#6F42C1\"> transformHotwireResponse</span><span style=\"color:#24292E\">(</span><span style=\"color:#005CC5\">xml</span><span style=\"color:#E36209\"> response</span><span style=\"color:#24292E\">) </span><span style=\"color:#D73A49\">returns</span><span style=\"color:#24292E\"> CarRental[] {</span></span>\n<span class=\"line\"><span style=\"color:#D73A49\">    return</span><span style=\"color:#D73A49\"> from</span><span style=\"color:#005CC5\"> xml</span><span style=\"color:#24292E\"> item </span><span style=\"color:#D73A49\">in</span><span style=\"color:#24292E\"> response/</span><span style=\"color:#D73A49\">&#x3C;</span><span style=\"color:#24292E\">Response</span><span style=\"color:#D73A49\">></span><span style=\"color:#24292E\">/</span><span style=\"color:#D73A49\">&#x3C;</span><span style=\"color:#24292E\">Car</span><span style=\"color:#D73A49\">></span></span>\n<span class=\"line\"><span style=\"color:#D73A49\">        select</span><span style=\"color:#24292E\"> {</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">            carType</span><span style=\"color:#D73A49\">:</span><span style=\"color:#24292E\"> (</span><span style=\"color:#E36209\">item</span><span style=\"color:#D73A49\">/&#x3C;</span><span style=\"color:#E36209\">CarType</span><span style=\"color:#D73A49\">></span><span style=\"color:#24292E\">).</span><span style=\"color:#6F42C1\">data</span><span style=\"color:#24292E\">(),</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">            price</span><span style=\"color:#D73A49\">:</span><span style=\"color:#24292E\"> (</span><span style=\"color:#E36209\">item</span><span style=\"color:#D73A49\">/&#x3C;</span><span style=\"color:#E36209\">Price</span><span style=\"color:#D73A49\">></span><span style=\"color:#24292E\">).</span><span style=\"color:#6F42C1\">data</span><span style=\"color:#24292E\">(),</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">            resultLink</span><span style=\"color:#D73A49\">:</span><span style=\"color:#24292E\"> (</span><span style=\"color:#E36209\">item</span><span style=\"color:#D73A49\">/&#x3C;</span><span style=\"color:#E36209\">ResultLink</span><span style=\"color:#D73A49\">></span><span style=\"color:#24292E\">).</span><span style=\"color:#6F42C1\">data</span><span style=\"color:#24292E\">(),</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">            vendor</span><span style=\"color:#D73A49\">:</span><span style=\"color:#032F62\"> \"Hotwire\"</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">        };</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#D73A49\">function</span><span style=\"color:#6F42C1\"> transformAvisResponse</span><span style=\"color:#24292E\">(</span><span style=\"color:#E36209\">AvisResponse</span><span style=\"color:#E36209\"> response</span><span style=\"color:#24292E\">) </span><span style=\"color:#D73A49\">returns</span><span style=\"color:#24292E\"> CarRental[] {</span></span>\n<span class=\"line\"><span style=\"color:#D73A49\">    return</span><span style=\"color:#D73A49\"> from</span><span style=\"color:#005CC5\"> var</span><span style=\"color:#24292E\"> {carType, price, resultLink, vendor} </span><span style=\"color:#D73A49\">in</span><span style=\"color:#24292E\"> response.result</span></span>\n<span class=\"line\"><span style=\"color:#D73A49\">        select</span><span style=\"color:#24292E\"> {carType, price, resultLink, vendor};</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">}</span></span>\n<span class=\"line\"></span></code></pre>","raw":"import ballerina/http;\n\ntype CarRental record {|\n    string carType;\n    string price;\n    string resultLink;\n    string vendor;\n|};\n\ntype AvisResponse record {\n    record {\n        *CarRental;\n    }[] result;\n};\n\nfinal http:Client hotwireEP = check new (\"http://api.hotwire.com.balmock.io\");\nfinal http:Client avisEP = check new (\"http://api.avis.com.balmock.io\");\n\nservice /api/v1 on new http:Listener(8080) {\n\n    resource function get vehicles(string dropOffDateTime, string dropOffLocation, string pickupDateTime,\n            string pickupLocation) returns map<CarRental[]>|error {\n\n        worker hotwire returns CarRental[]|error {\n            http:Response hotwireResponse = check hotwireEP->/v1/search/car.get(pickup = pickupLocation,\n                dest = dropOffLocation, startDate = pickupDateTime, endDate = dropOffDateTime\n            );\n            return transformHotwireResponse(check hotwireResponse.getXmlPayload());\n        }\n\n        worker avis returns CarRental[]|error {\n            AvisResponse avisResponse = check avisEP->/cars/catalog/v1/vehicles/rates.get(brand = \"Avis\",\n                country_code = \"US\", dropOff_date = dropOffDateTime, dropoff_location = dropOffLocation,\n                pickup_date = pickupDateTime, pickup_location = pickupLocation\n            );\n            return transformAvisResponse(avisResponse);\n        }\n\n        var responses = wait {hotwire, avis};\n        return map from var [vendor, carRental] in responses.entries()\n            where carRental !is error\n            select [vendor, carRental];\n    }\n}\n\nfunction transformHotwireResponse(xml response) returns CarRental[] {\n    return from xml item in response/<Response>/<Car>\n        select {\n            carType: (item/<CarType>).data(),\n            price: (item/<Price>).data(),\n            resultLink: (item/<ResultLink>).data(),\n            vendor: \"Hotwire\"\n        };\n}\n\nfunction transformAvisResponse(AvisResponse response) returns CarRental[] {\n    return from var {carType, price, resultLink, vendor} in response.result\n        select {carType, price, resultLink, vendor};\n}\n","name":"scatter-gather.bal"}]},"__N_SSG":true}