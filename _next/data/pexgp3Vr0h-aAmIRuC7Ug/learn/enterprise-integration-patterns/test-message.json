{"pageProps":{"tagline":"Assure the health of messaging components","desc":"Assure the health of messaging components by sending test messages. Note: Instead of the original pattern, we have selected a modern version where infrastructure polls for the health of the components.","helps":"Ballerina provides built-in support for creating, propagating(`check` keyword), and handling errors. Error handling logic can be performed after testing if a given value is an error using the `is` keyword.","category":"System Management","index":59,"tags":["Test Message","Message Filter","Message"],"link":"https://www.enterpriseintegrationpatterns.com/patterns/messaging/TestMessage.html","content":[{"headerCode":"<pre class=\"shiki github-light\" style=\"background-color:#fff;color:#24292e\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color:#D73A49\">import</span><span style=\"color:#24292E\"> ballerina/http;</span></span>\n<span class=\"line\"><span style=\"color:#D73A49\">import</span><span style=\"color:#24292E\"> ballerina/sql;</span></span>\n<span class=\"line\"><span style=\"color:#D73A49\">import</span><span style=\"color:#24292E\"> ballerinax/mysql;</span></span>\n<span class=\"line\"><span style=\"color:#D73A49\">import</span><span style=\"color:#24292E\"> ballerinax/mysql.driver </span><span style=\"color:#D73A49\">as</span><span style=\"color:#24292E\"> _;</span></span>\n<span class=\"line\"></span></code></pre>","mainCode":"<pre class=\"shiki github-light\" style=\"background-color:#fff;color:#24292e\" tabindex=\"0\"><code><span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#D73A49\">service</span><span style=\"color:#6F42C1\"> /customer</span><span style=\"color:#D73A49\"> on</span><span style=\"color:#D73A49\"> new</span><span style=\"color:#24292E\"> http:Listener(</span><span style=\"color:#005CC5\">8080</span><span style=\"color:#24292E\">) {</span></span>\n<span class=\"line\"><span style=\"color:#D73A49\">    private</span><span style=\"color:#24292E\"> mysql</span><span style=\"color:#D73A49\">:</span><span style=\"color:#24292E\">Client? db </span><span style=\"color:#D73A49\">=</span><span style=\"color:#D73A49\"> null</span><span style=\"color:#24292E\">;</span></span>\n<span class=\"line\"><span style=\"color:#005CC5\">    boolean</span><span style=\"color:#24292E\"> dbConnected </span><span style=\"color:#D73A49\">=</span><span style=\"color:#D73A49\"> false</span><span style=\"color:#24292E\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#D73A49\">    function</span><span style=\"color:#6F42C1\"> init</span><span style=\"color:#24292E\">() {</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">        mysql</span><span style=\"color:#D73A49\">:</span><span style=\"color:#24292E\">Client</span><span style=\"color:#D73A49\">|error</span><span style=\"color:#24292E\"> dbClient </span><span style=\"color:#D73A49\">=</span><span style=\"color:#D73A49\"> new</span><span style=\"color:#24292E\"> (</span><span style=\"color:#032F62\">\"localhost\"</span><span style=\"color:#24292E\">, </span><span style=\"color:#032F62\">\"admin\"</span><span style=\"color:#24292E\">, </span><span style=\"color:#032F62\">\"adminpass\"</span><span style=\"color:#24292E\">, </span><span style=\"color:#032F62\">\"CUSTOMER\"</span><span style=\"color:#24292E\">, </span><span style=\"color:#005CC5\">3000</span><span style=\"color:#24292E\">);</span></span>\n<span class=\"line\"><span style=\"color:#D73A49\">        if</span><span style=\"color:#24292E\"> dbClient </span><span style=\"color:#D73A49\">is</span><span style=\"color:#24292E\"> mysql</span><span style=\"color:#D73A49\">:</span><span style=\"color:#24292E\">Client {</span></span>\n<span class=\"line\"><span style=\"color:#005CC5\">            self</span><span style=\"color:#24292E\">.db </span><span style=\"color:#D73A49\">=</span><span style=\"color:#24292E\"> dbClient;</span></span>\n<span class=\"line\"><span style=\"color:#005CC5\">            self</span><span style=\"color:#24292E\">.dbConnected </span><span style=\"color:#D73A49\">=</span><span style=\"color:#D73A49\"> true</span><span style=\"color:#24292E\">;</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">        }</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">    }</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#D73A49\">    resource</span><span style=\"color:#D73A49\"> function</span><span style=\"color:#6F42C1\"> get</span><span style=\"color:#6F42C1\"> phoneNumber</span><span style=\"color:#24292E\">(</span><span style=\"color:#005CC5\">string</span><span style=\"color:#E36209\"> id</span><span style=\"color:#24292E\">) </span><span style=\"color:#D73A49\">returns</span><span style=\"color:#005CC5\"> string</span><span style=\"color:#D73A49\">|</span><span style=\"color:#24292E\">http</span><span style=\"color:#D73A49\">:</span><span style=\"color:#24292E\">InternalServerError</span><span style=\"color:#D73A49\">|</span><span style=\"color:#24292E\">http:NotFound</span><span style=\"color:#D73A49\">|error</span><span style=\"color:#24292E\"> {</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">        mysql</span><span style=\"color:#D73A49\">:</span><span style=\"color:#24292E\">Client? db </span><span style=\"color:#D73A49\">=</span><span style=\"color:#005CC5\"> self</span><span style=\"color:#24292E\">.db;</span></span>\n<span class=\"line\"><span style=\"color:#D73A49\">        if</span><span style=\"color:#24292E\"> db </span><span style=\"color:#D73A49\">!is</span><span style=\"color:#24292E\"> mysql</span><span style=\"color:#D73A49\">:</span><span style=\"color:#24292E\">Client {</span></span>\n<span class=\"line\"><span style=\"color:#D73A49\">            return</span><span style=\"color:#24292E\"> http</span><span style=\"color:#D73A49\">:</span><span style=\"color:#24292E\">INTERNAL_SERVER_ERROR;</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">        }</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#005CC5\">        string</span><span style=\"color:#D73A49\">|error</span><span style=\"color:#24292E\"> result </span><span style=\"color:#D73A49\">=</span><span style=\"color:#24292E\"> db</span><span style=\"color:#D73A49\">-></span><span style=\"color:#6F42C1\">queryRow</span><span style=\"color:#24292E\">(</span><span style=\"color:#032F62\">`SELECT number FROM customers WHERE id = ${</span><span style=\"color:#24292E\">id</span><span style=\"color:#032F62\">}`</span><span style=\"color:#24292E\">);</span></span>\n<span class=\"line\"><span style=\"color:#D73A49\">        if</span><span style=\"color:#24292E\"> result </span><span style=\"color:#D73A49\">is</span><span style=\"color:#24292E\"> sql</span><span style=\"color:#D73A49\">:</span><span style=\"color:#24292E\">NoRowsError {</span></span>\n<span class=\"line\"><span style=\"color:#D73A49\">            return</span><span style=\"color:#24292E\"> http</span><span style=\"color:#D73A49\">:</span><span style=\"color:#24292E\">NOT_FOUND;</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">        }</span></span>\n<span class=\"line\"><span style=\"color:#D73A49\">        return</span><span style=\"color:#24292E\"> result;</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">    }</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#D73A49\">    resource</span><span style=\"color:#D73A49\"> function</span><span style=\"color:#6F42C1\"> get</span><span style=\"color:#6F42C1\"> heartbeat</span><span style=\"color:#24292E\">() </span><span style=\"color:#D73A49\">returns</span><span style=\"color:#24292E\"> http</span><span style=\"color:#D73A49\">:</span><span style=\"color:#24292E\">Ok</span><span style=\"color:#D73A49\">|</span><span style=\"color:#24292E\">http:InternalServerError {</span></span>\n<span class=\"line\"><span style=\"color:#D73A49\">        return</span><span style=\"color:#005CC5\"> self</span><span style=\"color:#24292E\">.dbConnected </span><span style=\"color:#D73A49\">?</span><span style=\"color:#24292E\"> http</span><span style=\"color:#D73A49\">:</span><span style=\"color:#24292E\">OK : http:INTERNAL_SERVER_ERROR;</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">    }</span></span>\n<span class=\"line\"><span style=\"color:#24292E\">}</span></span>\n<span class=\"line\"></span></code></pre>","raw":"import ballerina/http;\nimport ballerina/sql;\nimport ballerinax/mysql;\nimport ballerinax/mysql.driver as _;\n\nservice /customer on new http:Listener(8080) {\n    private mysql:Client? db = null;\n    boolean dbConnected = false;\n\n    function init() {\n        mysql:Client|error dbClient = new (\"localhost\", \"admin\", \"adminpass\", \"CUSTOMER\", 3000);\n        if dbClient is mysql:Client {\n            self.db = dbClient;\n            self.dbConnected = true;\n        }\n    }\n\n    resource function get phoneNumber(string id) returns string|http:InternalServerError|http:NotFound|error {\n        mysql:Client? db = self.db;\n        if db !is mysql:Client {\n            return http:INTERNAL_SERVER_ERROR;\n        }\n\n        string|error result = db->queryRow(`SELECT number FROM customers WHERE id = ${id}`);\n        if result is sql:NoRowsError {\n            return http:NOT_FOUND;\n        }\n        return result;\n    }\n\n    resource function get heartbeat() returns http:Ok|http:InternalServerError {\n        return self.dbConnected ? http:OK : http:INTERNAL_SERVER_ERROR;\n    }\n}\n","name":"test-message.bal"}],"name":" Test Message"},"__N_SSG":true}