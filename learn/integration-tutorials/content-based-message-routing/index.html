<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="description" content="A programming language for the cloud that makes it easier to use, combine, and create network services."/><meta name="keywords" content="ballerinalang, integration, microservices, programming language, cloud native, ballerina language"/><title>Content-based message routing</title><meta property="og:type" content="article"/><meta property="og:title" content="Ballerina - Content-based message routing"/><meta property="og:description" content="A programming language for the cloud that makes it easier to use, combine, and create network services."/><meta property="og:title" content="Ballerina"/><meta property="twitter:description" content="A programming language for the cloud that makes it easier to use, combine, and create network services."/><meta property="twitter:text:description" content="A programming language for the cloud that makes it easier to use, combine, and create network services."/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><meta property="og:image" content="https://ballerina.io/images/ballerina-generic-social-media-image-2023.png"/><meta property="og:title" content="Ballerina"/><meta property="og:image" content="https://ballerina.io/images/ballerina-generic-social-media-image-2023.png"/><meta name="twitter:site" content="@ballerinalang"/><meta name="twitter:creator" content="@ballerinalang"/><meta name="twitter:title" content="Ballerina"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:image" content="https://ballerina.io/images/ballerina-generic-social-media-image-2023.png"/><meta property="twitter:image" content="https://ballerina.io/images/ballerina-generic-social-media-image-2023.png"/><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.setAttributeNode(d.createAttribute('data-ot-ignore'));j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-PSL2TX4');</script><script type="text/javascript" crossorigin="true" src="https://cdn.jsdelivr.net/npm/@docsearch/js@alpha"></script><script src="https://cookie-cdn.cookiepro.com/scripttemplates/otSDKStub.js" type="text/javascript" charSet="UTF-8" data-domain-script="630ad396-5fd5-4745-92ae-2765dc8841ee" defer=""></script><meta name="next-head-count" content="23"/><meta charSet="utf-8"/><meta name="author" content="WSO2 LLC"/><meta HTTP-EQUIV="X-Frame-Options" CONTENT="SAMEORIGIN"/><meta HTTP-EQUIV="Content-Security-Policy" CONTENT="frame-ancestors &#x27;none&#x27;;"/><link rel="shortcut icon" href="/images/favicon.ico"/><link rel="stylesheet" href="/css/roboto.css"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css"/><link rel="stylesheet" href="/css/ballerina-search-button.css"/><link rel="stylesheet" href="/css/ballerina-search-modal.css"/><link rel="stylesheet" href="/css/ballerina-search-variables.css"/><link rel="stylesheet" href="/css/ballerina-search-style.css"/><link rel="preload" href="/_next/static/css/4912777e2cfb47d2.css" as="style"/><link rel="stylesheet" href="/_next/static/css/4912777e2cfb47d2.css" data-n-g=""/><link rel="preload" href="/_next/static/css/ed928f4e0113510f.css" as="style"/><link rel="stylesheet" href="/_next/static/css/ed928f4e0113510f.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-676a25c773882039.js" defer=""></script><script src="/_next/static/chunks/framework-a070cbfff3c750c5.js" defer=""></script><script src="/_next/static/chunks/main-a66eb456a358e5ca.js" defer=""></script><script src="/_next/static/chunks/pages/_app-49e87402e1a02b9d.js" defer=""></script><script src="/_next/static/chunks/9733-caeb053dcf01b5fd.js" defer=""></script><script src="/_next/static/chunks/8999-b1f394634e8708da.js" defer=""></script><script src="/_next/static/chunks/5530-9e94516ef785d153.js" defer=""></script><script src="/_next/static/chunks/2092-643ce819261b95c6.js" defer=""></script><script src="/_next/static/chunks/4564-079435fb4878d182.js" defer=""></script><script src="/_next/static/chunks/5795-c59bab88fcc5a40c.js" defer=""></script><script src="/_next/static/chunks/pages/learn/integration/integration-tutorials/%5Bslug%5D-98bdeb669cbe7491.js" defer=""></script><script src="/_next/static/YxMFR4Z1L0Ga7PZ_Z5EQ9/_buildManifest.js" defer=""></script><script src="/_next/static/YxMFR4Z1L0Ga7PZ_Z5EQ9/_ssgManifest.js" defer=""></script><script src="/_next/static/YxMFR4Z1L0Ga7PZ_Z5EQ9/_middlewareManifest.js" defer=""></script></head><body><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-PSL2TX4" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript><div id="__next" data-reactroot=""><div class="main-wrapper other vstack gap-0"><div class="wrap-page-content container"><div class="row"><div class="mdContent col-sm-10 col-12"><div class="row"><div style="margin-bottom:20px;" class="patternContent col-12"><div class="backToLanding" href="/learn/integration-tutorials/"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="#3ad1ca" class="bi bi-box-arrow-left ms-0" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M6 12.5a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-9a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v2a.5.5 0 0 1-1 0v-2A1.5 1.5 0 0 1 6.5 2h8A1.5 1.5 0 0 1 16 3.5v9a1.5 1.5 0 0 1-1.5 1.5h-8A1.5 1.5 0 0 1 5 12.5v-2a.5.5 0 0 1 1 0v2z"></path><path fill-rule="evenodd" d="M.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L1.707 7.5H10.5a.5.5 0 0 1 0 1H1.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"></path></svg><p class="m-0 p-0">Back to integration tutorials</p></div></div></div><div class="topRow innerRow row"><div class="col-11"><h1>Content-based message routing</h1></div><div class="gitIcon col-1"><a href="https://github.com/ballerina-platform/ballerina-dev-website/blob/master/swan-lake/integration-tutorials/content-based-message-routing.md" target="_blank" rel="noreferrer" title="Edit in GitHub"></a></div></div><div style="margin-top:40px;margin-bottom:0;align-items:center" class="pageContentRow innerRow row"><div class="col-md-8 col-12"><p>This tutorial helps you understand how content-based routing can be done in Ballerina.</p></div><div class="col-md-3 col-12"><img/></div></div><div class="pageContentRow innerRow row"><div class="col-12"><h2 id="overview" data-section="overview" class="section"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="currentColor" class="bi bi-link-45deg mdButton pe-2" viewBox="0 0 16 16"><path d="M4.715 6.542 3.343 7.914a3 3 0 1 0 4.243 4.243l1.828-1.829A3 3 0 0 0 8.586 5.5L8 6.086a1.002 1.002 0 0 0-.154.199 2 2 0 0 1 .861 3.337L6.88 11.45a2 2 0 1 1-2.83-2.83l.793-.792a4.018 4.018 0 0 1-.128-1.287z"></path><path d="M6.586 4.672A3 3 0 0 0 7.414 9.5l.775-.776a2 2 0 0 1-.896-3.346L9.12 3.55a2 2 0 1 1 2.83 2.83l-.793.792c.112.42.155.855.128 1.287l1.372-1.372a3 3 0 1 0-4.243-4.243L6.586 4.672z"></path></svg>Overview</h2>
<p>In this tutorial, you will develop a service via which you can reserve appointments at several hospitals. The requests are routed to the relevant hospital based on the content of the request payload.</p>
<p>To implement this use case, you will develop a REST service with a single resource using Visual Studio Code with the Ballerina Swan Lake extension. The resource will receive the user request, select the hospital endpoint based on the hospital ID, send a request to the relevant hospital service to make a reservation, and respond with the reservation details.</p>
<p>The flow is as follows:</p>
<ol>
<li>Receive a request with a JSON payload similar to the following.</li>
</ol>
<pre><pre class="default"><code>{
    &quot;patient&quot;: {
        &quot;name&quot;: &quot;John Doe&quot;,
        &quot;dob&quot;: &quot;1940-03-19&quot;,
        &quot;ssn&quot;: &quot;234-23-525&quot;,
        &quot;address&quot;: &quot;California&quot;,
        &quot;phone&quot;: &quot;8770586755&quot;,
        &quot;email&quot;: &quot;johndoe@gmail.com&quot;,
        &quot;card_no&quot;: &quot;7844481124110331&quot;
    },
    &quot;doctor&quot;: &quot;thomas collins&quot;,
    &quot;hospital&quot;: &quot;grand oak community hospital&quot;,
    &quot;hospital_id&quot;: &quot;grandoak&quot;,
    &quot;appointment_date&quot;: &quot;2017-04-02&quot;
}
</code></pre></pre>
<ol start="2">
<li>Extract the <code>hospital_id</code> field and select the corresponding hospital service endpoint.</li>
</ol>
<ul>
<li>grandoak -&gt; <code>http://localhost:9090/grandoak/categories</code></li>
<li>clemency -&gt; <code>http://localhost:9090/clemency/categories</code></li>
<li>pinevalley -&gt; <code>http://localhost:9090/pinevalley/categories</code></li>
</ul>
<ol start="3">
<li>Send a request to the selected hospital endpoint and retrieve the response which will be similar to the following.</li>
</ol>
<pre><pre class="default"><code>{
    &quot;appointmentNumber&quot;: 8,
    &quot;doctor&quot;: {
        &quot;name&quot;: &quot;thomas collins&quot;,
        &quot;hospital&quot;: &quot;grand oak community hospital&quot;,
        &quot;category&quot;: &quot;surgery&quot;,
        &quot;availability&quot;: &quot;9.00 a.m - 11.00 a.m&quot;,
        &quot;fee&quot;: 7000.0
    },
    &quot;patient&quot;: {
        &quot;name&quot;: &quot;John Doe&quot;,
        &quot;dob&quot;: &quot;1940-03-19&quot;,
        &quot;ssn&quot;: &quot;234-23-525&quot;,
        &quot;address&quot;: &quot;California&quot;,
        &quot;phone&quot;: &quot;8770586755&quot;,
        &quot;email&quot;: &quot;johndoe@gmail.com&quot;
    },
    &quot;fee&quot;: 7000.0,
    &quot;hospital&quot;: &quot;grand oak community hospital&quot;,
    &quot;confirmed&quot;: false,
    &quot;appointmentDate&quot;: &quot;2017-04-02&quot;
}
</code></pre></pre>
<h3 id="concepts-covered" data-section="concepts-covered" class="section"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="currentColor" class="bi bi-link-45deg mdButton pe-2" viewBox="0 0 16 16"><path d="M4.715 6.542 3.343 7.914a3 3 0 1 0 4.243 4.243l1.828-1.829A3 3 0 0 0 8.586 5.5L8 6.086a1.002 1.002 0 0 0-.154.199 2 2 0 0 1 .861 3.337L6.88 11.45a2 2 0 1 1-2.83-2.83l.793-.792a4.018 4.018 0 0 1-.128-1.287z"></path><path d="M6.586 4.672A3 3 0 0 0 7.414 9.5l.775-.776a2 2 0 0 1-.896-3.346L9.12 3.55a2 2 0 1 1 2.83 2.83l-.793.792c.112.42.155.855.128 1.287l1.372-1.372a3 3 0 1 0-4.243-4.243L6.586 4.672z"></path></svg>Concepts covered</h3>
<ul>
<li>REST API</li>
<li>HTTP Client</li>
</ul>
<h2 id="develop-the-application" data-section="develop-the-application" class="section"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="currentColor" class="bi bi-link-45deg mdButton pe-2" viewBox="0 0 16 16"><path d="M4.715 6.542 3.343 7.914a3 3 0 1 0 4.243 4.243l1.828-1.829A3 3 0 0 0 8.586 5.5L8 6.086a1.002 1.002 0 0 0-.154.199 2 2 0 0 1 .861 3.337L6.88 11.45a2 2 0 1 1-2.83-2.83l.793-.792a4.018 4.018 0 0 1-.128-1.287z"></path><path d="M6.586 4.672A3 3 0 0 0 7.414 9.5l.775-.776a2 2 0 0 1-.896-3.346L9.12 3.55a2 2 0 1 1 2.83 2.83l-.793.792c.112.42.155.855.128 1.287l1.372-1.372a3 3 0 1 0-4.243-4.243L6.586 4.672z"></path></svg>Develop the application</h2>
<h3 id="step-1-set-up-the-workspace" data-section="step-1-set-up-the-workspace" class="section"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="currentColor" class="bi bi-link-45deg mdButton pe-2" viewBox="0 0 16 16"><path d="M4.715 6.542 3.343 7.914a3 3 0 1 0 4.243 4.243l1.828-1.829A3 3 0 0 0 8.586 5.5L8 6.086a1.002 1.002 0 0 0-.154.199 2 2 0 0 1 .861 3.337L6.88 11.45a2 2 0 1 1-2.83-2.83l.793-.792a4.018 4.018 0 0 1-.128-1.287z"></path><path d="M6.586 4.672A3 3 0 0 0 7.414 9.5l.775-.776a2 2 0 0 1-.896-3.346L9.12 3.55a2 2 0 1 1 2.83 2.83l-.793.792c.112.42.155.855.128 1.287l1.372-1.372a3 3 0 1 0-4.243-4.243L6.586 4.672z"></path></svg>Step 1: Set up the workspace</h3>
<p>Install <a href="https://ballerina.io/downloads/">Ballerina Swan Lake</a> and the <a href="https://marketplace.visualstudio.com/items?itemName=wso2.ballerina">Ballerina Swan Lake VS Code extension</a> on VS Code.</p>
<h3 id="step-2-develop-the-service" data-section="step-2-develop-the-service" class="section"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="currentColor" class="bi bi-link-45deg mdButton pe-2" viewBox="0 0 16 16"><path d="M4.715 6.542 3.343 7.914a3 3 0 1 0 4.243 4.243l1.828-1.829A3 3 0 0 0 8.586 5.5L8 6.086a1.002 1.002 0 0 0-.154.199 2 2 0 0 1 .861 3.337L6.88 11.45a2 2 0 1 1-2.83-2.83l.793-.792a4.018 4.018 0 0 1-.128-1.287z"></path><path d="M6.586 4.672A3 3 0 0 0 7.414 9.5l.775-.776a2 2 0 0 1-.896-3.346L9.12 3.55a2 2 0 1 1 2.83 2.83l-.793.792c.112.42.155.855.128 1.287l1.372-1.372a3 3 0 1 0-4.243-4.243L6.586 4.672z"></path></svg>Step 2: Develop the service</h3>
<p>Follow the instructions given in this section to develop the service.</p>
<ol>
<li>Create a new Ballerina project using the <code>bal</code> command and open it in VS Code.</li>
</ol>
<pre><pre class="default"><code>$ bal new content-based-message-routing
</code></pre></pre>
<ol start="2">
<li>Introduce the source code in files with the <code>.bal</code> extension. (e.g., the <code>main.bal</code> file)</li>
</ol>
<p>Import the</p>
<ul>
<li><code>ballerina/http</code> module to develop the REST API and define the clients that can be used to send requests to the backend services</li>
<li><code>ballerina/log</code> module to log debug, error, or info level information for each client request</li>
</ul>
<pre><pre class="default"><code>import ballerina/http;
import ballerina/log;
</code></pre></pre>
<ol start="3">
<li>Define a <a href="https://ballerina.io/learn/by-example/#configurability">configurable variable</a> for the port on which the listener should listen.</li>
</ol>
<pre><pre class="default"><code>configurable int port = 8290;
</code></pre></pre>
<ol start="4">
<li>Define three <a href="https://ballerina.io/learn/by-example/#http-client"><code>http:Client</code></a> clients to send requests to the backend services.</li>
</ol>
<pre><pre class="default"><code>final http:Client grandOakEP = check initializeHttpClient(&quot;http://localhost:9090/grandoak/categories&quot;);
final http:Client clemencyEP = check initializeHttpClient(&quot;http://localhost:9090/clemency/categories&quot;);
final http:Client pineValleyEP = check initializeHttpClient(&quot;http://localhost:9090/pinevalley/categories&quot;);

function initializeHttpClient(string url) returns http:Client|error =&gt; new (url);

</code></pre></pre>
<blockquote>
<p><strong>Note:</strong> The argument passed to the <code>new</code> expression is the URL of the backend service.</p>
<p>Here, a separate function is used to initialize the clients to aid with testing. Alternatively, the <code>new</code> expression can be used directly to initialize the clients.</p>
<pre><pre class="default"><code>final http:Client grandoakEP = new (&quot;http://localhost:9090/grandoak/categories&quot;);
final http:Client clemencyEP = new (&quot;http://localhost:9090/clemency/categories&quot;);
final http:Client pinevalleyEP = new (&quot;http://localhost:9090/pinevalley/categories&quot;);
</code></pre></pre>
</blockquote>
<ol start="5">
<li>Introduce an <a href="https://ballerina.io/learn/by-example/enumerations/">enum</a> to define the hospital IDs.</li>
</ol>
<pre><pre class="default"><code>enum HospitalId {
    GRAND_OAK = &quot;grandoak&quot;,
    CLEMENCY = &quot;clemency&quot;,
    PINE_VALLEY = &quot;pinevalley&quot;
};
</code></pre></pre>
<ol start="6">
<li>Define records corresponding to the request payload and response payload.</li>
</ol>
<pre><pre class="default"><code>type Patient record {|
    string name;
    string dob;
    string ssn;
    string address;
    string phone;
    string email;
|};

type ReservationRequest record {|
    Patient patient;
    string doctor;
    string hospital_id;
    HospitalId hospital;
    string appointment_date;
|};

type Doctor record {|
    string name;
    string hospital;
    string category;
    string availability;
    float fee;
|};

type ReservationResponse record {|
    int appointmentNumber;
    Doctor doctor;
    Patient patient;
    float fee;
    string hospital;
    boolean confirmed;
    string appointmentDate;
|};
</code></pre></pre>
<ol start="7">
<li>Define the <a href="https://ballerina.io/learn/by-example/#rest-service">HTTP service (REST API)</a> that has the resource that accepts user requests, makes calls to the relevant hospital backend service to retrieve relevant details, and responds to the client.</li>
</ol>
<pre><pre class="default"><code>service /healthcare on new http:Listener(port) {
    resource function post categories/[string category]/reserve(ReservationRequest payload) 
            returns ReservationResponse|http:NotFound|http:BadRequest|http:InternalServerError {
        
    }
</code></pre></pre>
<ul>
<li>
<p>Use <code>/healthcare</code> as the service path (or the context) of the service which is attached to the listener listening on port <code>port</code>.</p>
</li>
<li>
<p>The HTTP resource allows the <code>POST</code> operation on resource path <code>/categories/{category}/reserve</code>, where <code>category</code> is a path parameter.</p>
</li>
<li>
<p>Use <code>ReservationRequest</code> as a parameter indicating that the resource expects a JSON object corresponding to <code>ReservationRequest</code> as the payload.</p>
</li>
<li>
<p>Use <code>ReservationResponse|http:NotFound|http:BadRequest|http:InternalServerError</code> as the return type to indicate that the response will have a JSON payload corresponding to <code>ReservationResponse</code> on success or the response will be a &quot;NotFound&quot;, &quot;BadRequest&quot; or &quot;InternalServerError&quot; response on error.</p>
</li>
</ul>
<ol start="8">
<li>Implement the logic.</li>
</ol>
<pre><pre class="default"><code>service /healthcare on new http:Listener(port) {
    resource function post categories/[string category]/reserve(ReservationRequest payload)
            returns ReservationResponse|http:NotFound|http:BadRequest|http:InternalServerError {
        ReservationRequest {hospital_id, patient, ...reservationRequest} = payload;

        log:printDebug(&quot;Routing reservation request&quot;,
                        hospital_id = hospital_id,
                        patient = patient.name,
                        doctor = reservationRequest.doctor);

        http:Client hospitalEP;
        match hospital_id {
            GRAND_OAK =&gt; {
                hospitalEP = grandOakEP;
            }
            CLEMENCY =&gt; {
                hospitalEP = clemencyEP;
            }
            _ =&gt; {
                hospitalEP = pineValleyEP;
            }
        }

        ReservationResponse|http:ClientError resp = hospitalEP-&gt;/[category]/reserve.post({
            patient,
            ...reservationRequest
        });

        if resp is ReservationResponse {
            log:printDebug(&quot;Reservation request successful&quot;,
                            name = patient.name,
                            appointmentNumber = resp.appointmentNumber);
            return resp;
        }

        log:printError(&quot;Reservation request failed&quot;, resp);
        if resp is http:ClientRequestError {
            return &lt;http:NotFound&gt; {body: &quot;Unknown hospital, doctor or category&quot;};
        }

        return &lt;http:InternalServerError&gt; {body: resp.message()};
    }
}
</code></pre></pre>
<ul>
<li>
<p>Define the <code>hospitalEP</code> variable. Later, the relevant client is assigned to this variable based on the <code>hospital_id</code> value.</p>
<pre><pre class="default"><code>http:Client hospitalEP;
</code></pre></pre>
</li>
<li>
<p>Use a <a href="https://ballerina.io/learn/by-example/rest-binding-pattern-in-mapping-binding-pattern/">typed binding pattern with a mapping binding pattern to destructure</a> the payload and assign required components of the value to separate variables.</p>
<pre><pre class="default"><code>ReservationRequest {hospital_id, patient, doctor, ...reservationRequest} = payload;
</code></pre></pre>
<p>Here,</p>
<ul>
<li>The <code>hospital_id</code> value is assigned to the <code>hospital_id</code> variable.</li>
<li>The <code>patient</code> value is assigned to the <code>patient</code> variable of type <code>Patient</code> (fields are exactly those expected by the <code>Patient</code> record).</li>
<li>The remaining components of the payload are collected in a mapping value and assigned to the <code>reservationRequest</code> variable.</li>
</ul>
</li>
<li>
<p>The <code>log</code> functions are used to <a href="https://ballerina.io/learn/by-example/#log">log</a> information at <code>INFO</code>, <code>DEBUG</code>, and <code>ERROR</code> log levels.</p>
</li>
<li>
<p>Use a <a href="https://ballerina.io/learn/by-example/match-statement">match statement</a> to assign the relevant client to the <code>hospitalEP</code> variable based on the <code>hospital_id</code> value.</p>
<pre><pre class="default"><code>    match hospital_id {
        GRAND_OAK =&gt; {
            hospitalEP = grandOakEP;
        }
        CLEMENCY =&gt; {
            hospitalEP = clemencyEP;
        }
        _ =&gt; {
            hospitalEP = pineValleyEP;
        }
    }
</code></pre></pre>
</li>
<li>
<p>Make a <code>POST</code> request to the backend hospital service to make the reservation. The <code>category</code> value is used as a path parameter.</p>
<pre><pre class="default"><code>ReservationResponse|http:ClientError resp = hospitalEP-&gt;/[category]/reserve.post({
    patient,
    doctor,
    ...reservationRequest
});
</code></pre></pre>
<p>The expected payload in the request to make the reservation consists of four fields, namely <code>patient</code>, <code>doctor</code>, <code>hospital</code>, and <code>appointment_date</code>. The <code>reservationRequest</code> variable is used as a rest argument since it contains <code>hospital</code>, and <code>appointment_date</code>. The payload is specified directly as an argument to the remote method call.</p>
<pre><pre class="default"><code>{patient, doctor, ...reservationRequest}
</code></pre></pre>
</li>
<li>
<p>Use the <code>is</code> check to check whether the response is a <code>ReservationResponse</code> and return it as is (i.e., reservation successful).</p>
<pre><pre class="default"><code>if resp is ReservationResponse {
    log:printDebug(&quot;Reservation request successful&quot;,
                    name = patient.name,
                    appointmentNumber = resp.appointmentNumber);
    return resp;
}
</code></pre></pre>
</li>
<li>
<p>If the response is not a <code>ReservationResponse</code>, log the failure at <code>ERROR</code> level.  Return a &quot;NotFound&quot; response if the response is a <code>http:ClientRequestError</code>, or an &quot;InternalServerError&quot; response if the response is a <code>http:ServerError</code>.</p>
<pre><pre class="default"><code>log:printError(&quot;Reservation request failed&quot;, resp);
if resp is http:ClientRequestError {
    return &lt;http:NotFound&gt; {body: &quot;Unknown hospital, doctor or category&quot;};
}

return &lt;http:InternalServerError&gt; {body: resp.message()};
</code></pre></pre>
</li>
</ul>
<p>You have successfully developed the required service.</p>
<h4 id="complete-source-code" data-section="complete-source-code" class="section"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="currentColor" class="bi bi-link-45deg mdButton pe-2" viewBox="0 0 16 16"><path d="M4.715 6.542 3.343 7.914a3 3 0 1 0 4.243 4.243l1.828-1.829A3 3 0 0 0 8.586 5.5L8 6.086a1.002 1.002 0 0 0-.154.199 2 2 0 0 1 .861 3.337L6.88 11.45a2 2 0 1 1-2.83-2.83l.793-.792a4.018 4.018 0 0 1-.128-1.287z"></path><path d="M6.586 4.672A3 3 0 0 0 7.414 9.5l.775-.776a2 2 0 0 1-.896-3.346L9.12 3.55a2 2 0 1 1 2.83 2.83l-.793.792c.112.42.155.855.128 1.287l1.372-1.372a3 3 0 1 0-4.243-4.243L6.586 4.672z"></path></svg>Complete source code</h4>
<pre><pre class="default"><code>import ballerina/http;
import ballerina/log;

configurable int port = 8290;

final http:Client grandOakEP = check initializeHttpClient(&quot;http://localhost:9090/grandoak/categories&quot;);
final http:Client clemencyEP = check initializeHttpClient(&quot;http://localhost:9090/clemency/categories&quot;);
final http:Client pineValleyEP = check initializeHttpClient(&quot;http://localhost:9090/pinevalley/categories&quot;);

function initializeHttpClient(string url) returns http:Client|error =&gt; new (url);

enum HospitalId {
    GRAND_OAK = &quot;grandoak&quot;,
    CLEMENCY = &quot;clemency&quot;,
    PINE_VALLEY = &quot;pinevalley&quot;
};

type Patient record {|
    string name;
    string dob;
    string ssn;
    string address;
    string phone;
    string email;
|};

type ReservationRequest record {|
    Patient patient;
    string doctor;
    HospitalId hospital_id;
    string hospital;
    string appointment_date;
|};

type Doctor record {|
    string name;
    string hospital;
    string category;
    string availability;
    float fee;
|};

type ReservationResponse record {|
    int appointmentNumber;
    Doctor doctor;
    Patient patient;
    float fee;
    string hospital;
    boolean confirmed;
    string appointmentDate;
|};

service /healthcare on new http:Listener(port) {
    resource function post categories/[string category]/reserve(ReservationRequest payload)
            returns ReservationResponse|http:NotFound|http:BadRequest|http:InternalServerError {
        ReservationRequest {hospital_id, patient, ...reservationRequest} = payload;

        log:printDebug(&quot;Routing reservation request&quot;,
                        hospital_id = hospital_id,
                        patient = patient.name,
                        doctor = reservationRequest.doctor);

        http:Client hospitalEP;
        match hospital_id {
            GRAND_OAK =&gt; {
                hospitalEP = grandOakEP;
            }
            CLEMENCY =&gt; {
                hospitalEP = clemencyEP;
            }
            _ =&gt; {
                hospitalEP = pineValleyEP;
            }
        }

        ReservationResponse|http:ClientError resp = hospitalEP-&gt;/[category]/reserve.post({
            patient,
            ...reservationRequest
        });

        if resp is ReservationResponse {
            log:printDebug(&quot;Reservation request successful&quot;,
                            name = patient.name,
                            appointmentNumber = resp.appointmentNumber);
            return resp;
        }

        log:printError(&quot;Reservation request failed&quot;, resp);
        if resp is http:ClientRequestError {
            return &lt;http:NotFound&gt; {body: &quot;Unknown hospital, doctor or category&quot;};
        }

        return &lt;http:InternalServerError&gt; {body: resp.message()};
    }
}
</code></pre></pre>
<h4 id="diagram" data-section="diagram" class="section"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="currentColor" class="bi bi-link-45deg mdButton pe-2" viewBox="0 0 16 16"><path d="M4.715 6.542 3.343 7.914a3 3 0 1 0 4.243 4.243l1.828-1.829A3 3 0 0 0 8.586 5.5L8 6.086a1.002 1.002 0 0 0-.154.199 2 2 0 0 1 .861 3.337L6.88 11.45a2 2 0 1 1-2.83-2.83l.793-.792a4.018 4.018 0 0 1-.128-1.287z"></path><path d="M6.586 4.672A3 3 0 0 0 7.414 9.5l.775-.776a2 2 0 0 1-.896-3.346L9.12 3.55a2 2 0 1 1 2.83 2.83l-.793.792c.112.42.155.855.128 1.287l1.372-1.372a3 3 0 1 0-4.243-4.243L6.586 4.672z"></path></svg>Diagram</h4>
<p>The <a href="https://wso2.com/ballerina/vscode/docs/implement-the-code/sequence-diagram-view/">sequence diagram view</a> for the implemented resource method is the following.</p>
<p><img src="/learn/images/tutorial_content_based_message_routing_diagram.png" alt="sequence diagram"/></p>
<h3 id="step-3-build-and-run-the-service" data-section="step-3-build-and-run-the-service" class="section"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="currentColor" class="bi bi-link-45deg mdButton pe-2" viewBox="0 0 16 16"><path d="M4.715 6.542 3.343 7.914a3 3 0 1 0 4.243 4.243l1.828-1.829A3 3 0 0 0 8.586 5.5L8 6.086a1.002 1.002 0 0 0-.154.199 2 2 0 0 1 .861 3.337L6.88 11.45a2 2 0 1 1-2.83-2.83l.793-.792a4.018 4.018 0 0 1-.128-1.287z"></path><path d="M6.586 4.672A3 3 0 0 0 7.414 9.5l.775-.776a2 2 0 0 1-.896-3.346L9.12 3.55a2 2 0 1 1 2.83 2.83l-.793.792c.112.42.155.855.128 1.287l1.372-1.372a3 3 0 1 0-4.243-4.243L6.586 4.672z"></path></svg>Step 3: Build and run the service</h3>
<p>You can run this service by navigating to the project root and using the <code>bal run</code> command.</p>
<pre><pre class="default"><code>content-based-message-routing$ bal run
Compiling source
        integration_tutorials/content_based_message_routing:0.1.0

Running executable
</code></pre></pre>
<h3 id="step-4-try-out-the-use-case" data-section="step-4-try-out-the-use-case" class="section"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="currentColor" class="bi bi-link-45deg mdButton pe-2" viewBox="0 0 16 16"><path d="M4.715 6.542 3.343 7.914a3 3 0 1 0 4.243 4.243l1.828-1.829A3 3 0 0 0 8.586 5.5L8 6.086a1.002 1.002 0 0 0-.154.199 2 2 0 0 1 .861 3.337L6.88 11.45a2 2 0 1 1-2.83-2.83l.793-.792a4.018 4.018 0 0 1-.128-1.287z"></path><path d="M6.586 4.672A3 3 0 0 0 7.414 9.5l.775-.776a2 2 0 0 1-.896-3.346L9.12 3.55a2 2 0 1 1 2.83 2.83l-.793.792c.112.42.155.855.128 1.287l1.372-1.372a3 3 0 1 0-4.243-4.243L6.586 4.672z"></path></svg>Step 4: Try out the use case</h3>
<p>Let&#x27;s test the use case by sending a request to the service.</p>
<h4 id="start-the-back-end-service" data-section="start-the-back-end-service" class="section"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="currentColor" class="bi bi-link-45deg mdButton pe-2" viewBox="0 0 16 16"><path d="M4.715 6.542 3.343 7.914a3 3 0 1 0 4.243 4.243l1.828-1.829A3 3 0 0 0 8.586 5.5L8 6.086a1.002 1.002 0 0 0-.154.199 2 2 0 0 1 .861 3.337L6.88 11.45a2 2 0 1 1-2.83-2.83l.793-.792a4.018 4.018 0 0 1-.128-1.287z"></path><path d="M6.586 4.672A3 3 0 0 0 7.414 9.5l.775-.776a2 2 0 0 1-.896-3.346L9.12 3.55a2 2 0 1 1 2.83 2.83l-.793.792c.112.42.155.855.128 1.287l1.372-1.372a3 3 0 1 0-4.243-4.243L6.586 4.672z"></path></svg>Start the back end service</h4>
<p>Download the JAR file for the backend service from <a href="https://github.com/ballerina-guides/integration-tutorials/blob/main/backends/hospital-service/">here</a> and execute the following command to start the service:</p>
<pre><pre class="default"><code>bal run hospitalservice.jar
</code></pre></pre>
<h4 id="send-a-request-to-the-service" data-section="send-a-request-to-the-service" class="section"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="currentColor" class="bi bi-link-45deg mdButton pe-2" viewBox="0 0 16 16"><path d="M4.715 6.542 3.343 7.914a3 3 0 1 0 4.243 4.243l1.828-1.829A3 3 0 0 0 8.586 5.5L8 6.086a1.002 1.002 0 0 0-.154.199 2 2 0 0 1 .861 3.337L6.88 11.45a2 2 0 1 1-2.83-2.83l.793-.792a4.018 4.018 0 0 1-.128-1.287z"></path><path d="M6.586 4.672A3 3 0 0 0 7.414 9.5l.775-.776a2 2 0 0 1-.896-3.346L9.12 3.55a2 2 0 1 1 2.83 2.83l-.793.792c.112.42.155.855.128 1.287l1.372-1.372a3 3 0 1 0-4.243-4.243L6.586 4.672z"></path></svg>Send a request to the service</h4>
<p>Let&#x27;s send a request to the service using cURL as follows.</p>
<ol>
<li>
<p>Install and set up <a href="https://curl.se/">cURL</a> as your client.</p>
</li>
<li>
<p>Create a file named <code>request.json</code> with the request payload.</p>
</li>
</ol>
<pre><pre class="default"><code>{
    &quot;patient&quot;: {
        &quot;name&quot;: &quot;John Doe&quot;,
        &quot;dob&quot;: &quot;1940-03-19&quot;,
        &quot;ssn&quot;: &quot;234-23-525&quot;,
        &quot;address&quot;: &quot;California&quot;,
        &quot;phone&quot;: &quot;8770586755&quot;,
        &quot;email&quot;: &quot;johndoe@gmail.com&quot;
    },
    &quot;doctor&quot;: &quot;thomas collins&quot;,
    &quot;hospital_id&quot;: &quot;grandoak&quot;,
    &quot;hospital&quot;: &quot;grand oak community hospital&quot;,
    &quot;appointment_date&quot;: &quot;2023-10-02&quot;
}
</code></pre></pre>
<ol start="3">
<li>Execute the following command.</li>
</ol>
<pre><pre class="default"><code>curl -v -X POST --data @request.json http://localhost:8290/healthcare/categories/surgery/reserve --header &quot;Content-Type:application/json&quot;
</code></pre></pre>
<h4 id="verify-the-response" data-section="verify-the-response" class="section"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="currentColor" class="bi bi-link-45deg mdButton pe-2" viewBox="0 0 16 16"><path d="M4.715 6.542 3.343 7.914a3 3 0 1 0 4.243 4.243l1.828-1.829A3 3 0 0 0 8.586 5.5L8 6.086a1.002 1.002 0 0 0-.154.199 2 2 0 0 1 .861 3.337L6.88 11.45a2 2 0 1 1-2.83-2.83l.793-.792a4.018 4.018 0 0 1-.128-1.287z"></path><path d="M6.586 4.672A3 3 0 0 0 7.414 9.5l.775-.776a2 2 0 0 1-.896-3.346L9.12 3.55a2 2 0 1 1 2.83 2.83l-.793.792c.112.42.155.855.128 1.287l1.372-1.372a3 3 0 1 0-4.243-4.243L6.586 4.672z"></path></svg>Verify the response</h4>
<p>You will see a response similar to the following for a successful appointment reservation.</p>
<pre><pre class="default"><code>{
    &quot;appointmentNumber&quot;: 8,
    &quot;doctor&quot;: {
        &quot;name&quot;: &quot;thomas collins&quot;,
        &quot;hospital&quot;: &quot;grand oak community hospital&quot;,
        &quot;category&quot;: &quot;surgery&quot;,
        &quot;availability&quot;: &quot;9.00 a.m - 11.00 a.m&quot;,
        &quot;fee&quot;: 7000.0
    },
    &quot;patient&quot;: {
        &quot;name&quot;: &quot;John Doe&quot;,
        &quot;dob&quot;: &quot;1940-03-19&quot;,
        &quot;ssn&quot;: &quot;234-23-525&quot;,
        &quot;address&quot;: &quot;California&quot;,
        &quot;phone&quot;: &quot;8770586755&quot;,
        &quot;email&quot;: &quot;johndoe@gmail.com&quot;
    },
    &quot;fee&quot;: 7000.0,
    &quot;hospital&quot;: &quot;grand oak community hospital&quot;,
    &quot;confirmed&quot;: false,
    &quot;appointmentDate&quot;: &quot;2017-04-02&quot;
}
</code></pre></pre>
<h2 id="complete-implementation" data-section="complete-implementation" class="section"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="currentColor" class="bi bi-link-45deg mdButton pe-2" viewBox="0 0 16 16"><path d="M4.715 6.542 3.343 7.914a3 3 0 1 0 4.243 4.243l1.828-1.829A3 3 0 0 0 8.586 5.5L8 6.086a1.002 1.002 0 0 0-.154.199 2 2 0 0 1 .861 3.337L6.88 11.45a2 2 0 1 1-2.83-2.83l.793-.792a4.018 4.018 0 0 1-.128-1.287z"></path><path d="M6.586 4.672A3 3 0 0 0 7.414 9.5l.775-.776a2 2 0 0 1-.896-3.346L9.12 3.55a2 2 0 1 1 2.83 2.83l-.793.792c.112.42.155.855.128 1.287l1.372-1.372a3 3 0 1 0-4.243-4.243L6.586 4.672z"></path></svg>Complete implementation</h2>
<p>Check out the <a href="https://github.com/ballerina-guides/integration-tutorials/tree/main/content-based-message-routing">complete implementation</a> on GitHub.</p>
<h2 id="references" data-section="references" class="section"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="currentColor" class="bi bi-link-45deg mdButton pe-2" viewBox="0 0 16 16"><path d="M4.715 6.542 3.343 7.914a3 3 0 1 0 4.243 4.243l1.828-1.829A3 3 0 0 0 8.586 5.5L8 6.086a1.002 1.002 0 0 0-.154.199 2 2 0 0 1 .861 3.337L6.88 11.45a2 2 0 1 1-2.83-2.83l.793-.792a4.018 4.018 0 0 1-.128-1.287z"></path><path d="M6.586 4.672A3 3 0 0 0 7.414 9.5l.775-.776a2 2 0 0 1-.896-3.346L9.12 3.55a2 2 0 1 1 2.83 2.83l-.793.792c.112.42.155.855.128 1.287l1.372-1.372a3 3 0 1 0-4.243-4.243L6.586 4.672z"></path></svg>References</h2>
<ul>
<li><a href="https://lib.ballerina.io/ballerina/http/latest"><code>ballerina/http</code> API docs</a></li>
<li><a href="https://lib.ballerina.io/ballerina/log/latest"><code>ballerina/log</code> API docs</a></li>
</ul></div></div></div><div class="pageToc d-none d-sm-block col-sm-2"></div></div></div><div class="Footer_stack__Y9iHo vstack gap-0"><div class="Footer_footer__gXdNn container"><div class="row"><div class="col-lg-6 col-md-6 col-sm-12 col-12"><div class="row"><div class="col-lg-6 col-md-12 col-sm-12 col-12"><div class="Footer_socialMedia__99VpI"><div class="Footer_smIcons__HD9f7"><ul><li><a href="https://github.com/ballerina-platform" target="_blank" rel="noreferrer" title="GitHub"></a></li><li><a href="https://twitter.com/ballerinalang" target="_blank" rel="noreferrer" title="Twitter"></a></li><li><a href="https://discord.gg/ballerinalang" target="_blank" rel="noreferrer" title="Discord"></a></li><li><a href="https://stackoverflow.com/questions/tagged/ballerina" target="_blank" rel="noreferrer" title="Stackoverflow"></a></li><li><a href="https://www.youtube.com/c/Ballerinalang" target="_blank" rel="noreferrer" title="YouTube"></a></li><li><a href="https://www.linkedin.com/company/79080790" target="_blank" rel="noreferrer" title="LinkedIn"></a></li></ul></div></div><div class="Footer_footerLinks__M9jUM"><ul><li><a href="/downloads/">DOWNLOAD</a></li><li><a class="footerLink" target="_blank" rel="noreferrer" href="https://github.com/ballerina-platform/ballerina-lang/issues/new/choose">REPORT ISSUES</a></li></ul></div></div><div class="col-lg-6 col-md-12 col-sm-12 col-12"><div class="Footer_subscription__N96Xy"><div class="Footer_subscribe__6aRU2"><a href="/community/#subscribe-to-our-newsletter">Subscribe to our newsletter</a></div><div class="Footer_subscribe__6aRU2"><a class="Footer_subRss__E8gAT" href="https://blog.ballerina.io/feed.xml" target="_blank" rel="noreferrer">Subscribe via RSS</a></div></div></div></div></div><div class="Footer_inspire__ZAi5V col-lg-6 col-md-6 col-sm-12 col-12"><p>In the creation of Ballerina, we were inspired by many technologies. Thank you to all that have come before us (and forgive us if we missed one): Java, Go, C, C++, D, Rust, Haskell, Kotlin, Dart, TypeScript, JavaScript, Python, Perl, Flow, Swift, Elm, RelaxNG, NPM, Crates, Maven, Gradle, Kubernetes, Docker, Envoy, Markdown, GitHub, and WSO2.</p></div></div><div class="Footer_policyLinks__q3ge1 row"><div class="col-sm-2 col-12"><span class="footerLink">© 2018-2023 WSO2 LLC</span></div><div class="col-sm-10 col-12"><ul><li><a class="footerLink" target="_blank" rel="noreferrer" href="https://github.com/ballerina-lang/ballerina/blob/master/LICENSE">CODE LICENSE</a></li><li><a href="/license-of-site/">SITE LICENSE</a></li><li><a href="/terms-of-service/">TERMS OF SERVICE</a></li><li><a href="/privacy-policy/">PRIVACY POLICY</a></li><li><a href="/cookie-policy/">COOKIE POLICY</a></li><li><a href="/security-policy/">SECURITY POLICY</a></li><li><a href="/trademark-usage-policy/">TRADEMARK USAGE POLICY</a></li></ul></div></div></div></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"frontmatter":{"layout":"ballerina-content-based-message-routing-left-nav-pages-swanlake","title":"Content-based message routing","permalink":"/learn/content-based-message-routing/","description":"Integration tutorial for message routing based on the content.","keywords":"ballerina, programming language, client, restful-api, integration","active":"content-based-message-routing","intro":"This tutorial helps you understand how content-based routing can be done in Ballerina."},"content":"\n## Overview\n\nIn this tutorial, you will develop a service via which you can reserve appointments at several hospitals. The requests are routed to the relevant hospital based on the content of the request payload.\n\nTo implement this use case, you will develop a REST service with a single resource using Visual Studio Code with the Ballerina Swan Lake extension. The resource will receive the user request, select the hospital endpoint based on the hospital ID, send a request to the relevant hospital service to make a reservation, and respond with the reservation details.\n\nThe flow is as follows:\n\n1. Receive a request with a JSON payload similar to the following.\n\n```\n{\n    \"patient\": {\n        \"name\": \"John Doe\",\n        \"dob\": \"1940-03-19\",\n        \"ssn\": \"234-23-525\",\n        \"address\": \"California\",\n        \"phone\": \"8770586755\",\n        \"email\": \"johndoe@gmail.com\",\n        \"card_no\": \"7844481124110331\"\n    },\n    \"doctor\": \"thomas collins\",\n    \"hospital\": \"grand oak community hospital\",\n    \"hospital_id\": \"grandoak\",\n    \"appointment_date\": \"2017-04-02\"\n}\n```\n\n2. Extract the `hospital_id` field and select the corresponding hospital service endpoint.\n\n- grandoak -\u003e `http://localhost:9090/grandoak/categories`\n- clemency -\u003e `http://localhost:9090/clemency/categories`\n- pinevalley -\u003e `http://localhost:9090/pinevalley/categories`\n\n3. Send a request to the selected hospital endpoint and retrieve the response which will be similar to the following.\n\n```\n{\n    \"appointmentNumber\": 8,\n    \"doctor\": {\n        \"name\": \"thomas collins\",\n        \"hospital\": \"grand oak community hospital\",\n        \"category\": \"surgery\",\n        \"availability\": \"9.00 a.m - 11.00 a.m\",\n        \"fee\": 7000.0\n    },\n    \"patient\": {\n        \"name\": \"John Doe\",\n        \"dob\": \"1940-03-19\",\n        \"ssn\": \"234-23-525\",\n        \"address\": \"California\",\n        \"phone\": \"8770586755\",\n        \"email\": \"johndoe@gmail.com\"\n    },\n    \"fee\": 7000.0,\n    \"hospital\": \"grand oak community hospital\",\n    \"confirmed\": false,\n    \"appointmentDate\": \"2017-04-02\"\n}\n```\n\n### Concepts covered\n\n- REST API\n- HTTP Client\n\n## Develop the application\n\n### Step 1: Set up the workspace\n\nInstall [Ballerina Swan Lake](https://ballerina.io/downloads/) and the [Ballerina Swan Lake VS Code extension](https://marketplace.visualstudio.com/items?itemName=wso2.ballerina) on VS Code.\n\n### Step 2: Develop the service\n\nFollow the instructions given in this section to develop the service.\n\n1. Create a new Ballerina project using the `bal` command and open it in VS Code.\n\n```\n$ bal new content-based-message-routing\n```\n\n2. Introduce the source code in files with the `.bal` extension. (e.g., the `main.bal` file)\n\nImport the\n- `ballerina/http` module to develop the REST API and define the clients that can be used to send requests to the backend services\n- `ballerina/log` module to log debug, error, or info level information for each client request\n\n```\nimport ballerina/http;\nimport ballerina/log;\n```\n\n3. Define a [configurable variable](https://ballerina.io/learn/by-example/#configurability) for the port on which the listener should listen.\n\n```\nconfigurable int port = 8290;\n```\n\n4. Define three [`http:Client`](https://ballerina.io/learn/by-example/#http-client) clients to send requests to the backend services.\n\n```\nfinal http:Client grandOakEP = check initializeHttpClient(\"http://localhost:9090/grandoak/categories\");\nfinal http:Client clemencyEP = check initializeHttpClient(\"http://localhost:9090/clemency/categories\");\nfinal http:Client pineValleyEP = check initializeHttpClient(\"http://localhost:9090/pinevalley/categories\");\n\nfunction initializeHttpClient(string url) returns http:Client|error =\u003e new (url);\n\n```\n\u003e **Note:** The argument passed to the `new` expression is the URL of the backend service.\n\u003e\n\u003e Here, a separate function is used to initialize the clients to aid with testing. Alternatively, the `new` expression can be used directly to initialize the clients.\n\u003e\n\u003e ```\n\u003e final http:Client grandoakEP = new (\"http://localhost:9090/grandoak/categories\");\n\u003e final http:Client clemencyEP = new (\"http://localhost:9090/clemency/categories\");\n\u003e final http:Client pinevalleyEP = new (\"http://localhost:9090/pinevalley/categories\");\n\u003e```\n\n5. Introduce an [enum](https://ballerina.io/learn/by-example/enumerations/) to define the hospital IDs.\n\n```\nenum HospitalId {\n    GRAND_OAK = \"grandoak\",\n    CLEMENCY = \"clemency\",\n    PINE_VALLEY = \"pinevalley\"\n};\n```\n\n6. Define records corresponding to the request payload and response payload.\n\n```\ntype Patient record {|\n    string name;\n    string dob;\n    string ssn;\n    string address;\n    string phone;\n    string email;\n|};\n\ntype ReservationRequest record {|\n    Patient patient;\n    string doctor;\n    string hospital_id;\n    HospitalId hospital;\n    string appointment_date;\n|};\n\ntype Doctor record {|\n    string name;\n    string hospital;\n    string category;\n    string availability;\n    float fee;\n|};\n\ntype ReservationResponse record {|\n    int appointmentNumber;\n    Doctor doctor;\n    Patient patient;\n    float fee;\n    string hospital;\n    boolean confirmed;\n    string appointmentDate;\n|};\n```\n\n7. Define the [HTTP service (REST API)](https://ballerina.io/learn/by-example/#rest-service) that has the resource that accepts user requests, makes calls to the relevant hospital backend service to retrieve relevant details, and responds to the client.\n\n```\nservice /healthcare on new http:Listener(port) {\n    resource function post categories/[string category]/reserve(ReservationRequest payload) \n            returns ReservationResponse|http:NotFound|http:BadRequest|http:InternalServerError {\n        \n    }\n```\n\n- Use `/healthcare` as the service path (or the context) of the service which is attached to the listener listening on port `port`. \n\n- The HTTP resource allows the `POST` operation on resource path `/categories/{category}/reserve`, where `category` is a path parameter. \n\n- Use `ReservationRequest` as a parameter indicating that the resource expects a JSON object corresponding to `ReservationRequest` as the payload. \n\n- Use `ReservationResponse|http:NotFound|http:BadRequest|http:InternalServerError` as the return type to indicate that the response will have a JSON payload corresponding to `ReservationResponse` on success or the response will be a \"NotFound\", \"BadRequest\" or \"InternalServerError\" response on error.\n\n8. Implement the logic.\n\n```\nservice /healthcare on new http:Listener(port) {\n    resource function post categories/[string category]/reserve(ReservationRequest payload)\n            returns ReservationResponse|http:NotFound|http:BadRequest|http:InternalServerError {\n        ReservationRequest {hospital_id, patient, ...reservationRequest} = payload;\n\n        log:printDebug(\"Routing reservation request\",\n                        hospital_id = hospital_id,\n                        patient = patient.name,\n                        doctor = reservationRequest.doctor);\n\n        http:Client hospitalEP;\n        match hospital_id {\n            GRAND_OAK =\u003e {\n                hospitalEP = grandOakEP;\n            }\n            CLEMENCY =\u003e {\n                hospitalEP = clemencyEP;\n            }\n            _ =\u003e {\n                hospitalEP = pineValleyEP;\n            }\n        }\n\n        ReservationResponse|http:ClientError resp = hospitalEP-\u003e/[category]/reserve.post({\n            patient,\n            ...reservationRequest\n        });\n\n        if resp is ReservationResponse {\n            log:printDebug(\"Reservation request successful\",\n                            name = patient.name,\n                            appointmentNumber = resp.appointmentNumber);\n            return resp;\n        }\n\n        log:printError(\"Reservation request failed\", resp);\n        if resp is http:ClientRequestError {\n            return \u003chttp:NotFound\u003e {body: \"Unknown hospital, doctor or category\"};\n        }\n\n        return \u003chttp:InternalServerError\u003e {body: resp.message()};\n    }\n}\n```\n\n- Define the `hospitalEP` variable. Later, the relevant client is assigned to this variable based on the `hospital_id` value.\n\n    ```\n    http:Client hospitalEP;\n    ```\n\n- Use a [typed binding pattern with a mapping binding pattern to destructure](https://ballerina.io/learn/by-example/rest-binding-pattern-in-mapping-binding-pattern/) the payload and assign required components of the value to separate variables.\n    \n    ```\n    ReservationRequest {hospital_id, patient, doctor, ...reservationRequest} = payload;\n    ```\n    \n    Here,\n    - The `hospital_id` value is assigned to the `hospital_id` variable. \n    - The `patient` value is assigned to the `patient` variable of type `Patient` (fields are exactly those expected by the `Patient` record). \n    - The remaining components of the payload are collected in a mapping value and assigned to the `reservationRequest` variable.\n\n- The `log` functions are used to [log](https://ballerina.io/learn/by-example/#log) information at `INFO`, `DEBUG`, and `ERROR` log levels.\n\n- Use a [match statement](https://ballerina.io/learn/by-example/match-statement) to assign the relevant client to the `hospitalEP` variable based on the `hospital_id` value.\n\n    ```\n        match hospital_id {\n            GRAND_OAK =\u003e {\n                hospitalEP = grandOakEP;\n            }\n            CLEMENCY =\u003e {\n                hospitalEP = clemencyEP;\n            }\n            _ =\u003e {\n                hospitalEP = pineValleyEP;\n            }\n        }\n    ```\n\n- Make a `POST` request to the backend hospital service to make the reservation. The `category` value is used as a path parameter.\n\n    ```\n    ReservationResponse|http:ClientError resp = hospitalEP-\u003e/[category]/reserve.post({\n        patient,\n        doctor,\n        ...reservationRequest\n    });\n    ```\n\n    The expected payload in the request to make the reservation consists of four fields, namely `patient`, `doctor`, `hospital`, and `appointment_date`. The `reservationRequest` variable is used as a rest argument since it contains `hospital`, and `appointment_date`. The payload is specified directly as an argument to the remote method call.\n\n    ```\n    {patient, doctor, ...reservationRequest}\n    ```\n\n- Use the `is` check to check whether the response is a `ReservationResponse` and return it as is (i.e., reservation successful).\n\n    ```\n    if resp is ReservationResponse {\n        log:printDebug(\"Reservation request successful\",\n                        name = patient.name,\n                        appointmentNumber = resp.appointmentNumber);\n        return resp;\n    }\n    ```\n\n- If the response is not a `ReservationResponse`, log the failure at `ERROR` level.  Return a \"NotFound\" response if the response is a `http:ClientRequestError`, or an \"InternalServerError\" response if the response is a `http:ServerError`.\n\n    ```\n    log:printError(\"Reservation request failed\", resp);\n    if resp is http:ClientRequestError {\n        return \u003chttp:NotFound\u003e {body: \"Unknown hospital, doctor or category\"};\n    }\n\n    return \u003chttp:InternalServerError\u003e {body: resp.message()};\n    ```\n\nYou have successfully developed the required service.\n\n#### Complete source code\n\n```\nimport ballerina/http;\nimport ballerina/log;\n\nconfigurable int port = 8290;\n\nfinal http:Client grandOakEP = check initializeHttpClient(\"http://localhost:9090/grandoak/categories\");\nfinal http:Client clemencyEP = check initializeHttpClient(\"http://localhost:9090/clemency/categories\");\nfinal http:Client pineValleyEP = check initializeHttpClient(\"http://localhost:9090/pinevalley/categories\");\n\nfunction initializeHttpClient(string url) returns http:Client|error =\u003e new (url);\n\nenum HospitalId {\n    GRAND_OAK = \"grandoak\",\n    CLEMENCY = \"clemency\",\n    PINE_VALLEY = \"pinevalley\"\n};\n\ntype Patient record {|\n    string name;\n    string dob;\n    string ssn;\n    string address;\n    string phone;\n    string email;\n|};\n\ntype ReservationRequest record {|\n    Patient patient;\n    string doctor;\n    HospitalId hospital_id;\n    string hospital;\n    string appointment_date;\n|};\n\ntype Doctor record {|\n    string name;\n    string hospital;\n    string category;\n    string availability;\n    float fee;\n|};\n\ntype ReservationResponse record {|\n    int appointmentNumber;\n    Doctor doctor;\n    Patient patient;\n    float fee;\n    string hospital;\n    boolean confirmed;\n    string appointmentDate;\n|};\n\nservice /healthcare on new http:Listener(port) {\n    resource function post categories/[string category]/reserve(ReservationRequest payload)\n            returns ReservationResponse|http:NotFound|http:BadRequest|http:InternalServerError {\n        ReservationRequest {hospital_id, patient, ...reservationRequest} = payload;\n\n        log:printDebug(\"Routing reservation request\",\n                        hospital_id = hospital_id,\n                        patient = patient.name,\n                        doctor = reservationRequest.doctor);\n\n        http:Client hospitalEP;\n        match hospital_id {\n            GRAND_OAK =\u003e {\n                hospitalEP = grandOakEP;\n            }\n            CLEMENCY =\u003e {\n                hospitalEP = clemencyEP;\n            }\n            _ =\u003e {\n                hospitalEP = pineValleyEP;\n            }\n        }\n\n        ReservationResponse|http:ClientError resp = hospitalEP-\u003e/[category]/reserve.post({\n            patient,\n            ...reservationRequest\n        });\n\n        if resp is ReservationResponse {\n            log:printDebug(\"Reservation request successful\",\n                            name = patient.name,\n                            appointmentNumber = resp.appointmentNumber);\n            return resp;\n        }\n\n        log:printError(\"Reservation request failed\", resp);\n        if resp is http:ClientRequestError {\n            return \u003chttp:NotFound\u003e {body: \"Unknown hospital, doctor or category\"};\n        }\n\n        return \u003chttp:InternalServerError\u003e {body: resp.message()};\n    }\n}\n```\n\n#### Diagram\n\nThe [sequence diagram view](https://wso2.com/ballerina/vscode/docs/implement-the-code/sequence-diagram-view/) for the implemented resource method is the following.\n\n![sequence diagram](/learn/images/tutorial_content_based_message_routing_diagram.png)\n\n### Step 3: Build and run the service\n\nYou can run this service by navigating to the project root and using the `bal run` command.\n\n```\ncontent-based-message-routing$ bal run\nCompiling source\n        integration_tutorials/content_based_message_routing:0.1.0\n\nRunning executable\n```\n\n### Step 4: Try out the use case\n\nLet's test the use case by sending a request to the service.\n\n#### Start the back end service\n\nDownload the JAR file for the backend service from [here](https://github.com/ballerina-guides/integration-tutorials/blob/main/backends/hospital-service/) and execute the following command to start the service:\n\n```\nbal run hospitalservice.jar\n```\n\n#### Send a request to the service\n\nLet's send a request to the service using cURL as follows.\n\n1. Install and set up [cURL](https://curl.se/) as your client.\n\n3. Create a file named `request.json` with the request payload.\n\n```\n{\n    \"patient\": {\n        \"name\": \"John Doe\",\n        \"dob\": \"1940-03-19\",\n        \"ssn\": \"234-23-525\",\n        \"address\": \"California\",\n        \"phone\": \"8770586755\",\n        \"email\": \"johndoe@gmail.com\"\n    },\n    \"doctor\": \"thomas collins\",\n    \"hospital_id\": \"grandoak\",\n    \"hospital\": \"grand oak community hospital\",\n    \"appointment_date\": \"2023-10-02\"\n}\n```\n\n3. Execute the following command.\n\n```\ncurl -v -X POST --data @request.json http://localhost:8290/healthcare/categories/surgery/reserve --header \"Content-Type:application/json\"\n```\n#### Verify the response\n\nYou will see a response similar to the following for a successful appointment reservation.\n\n```\n{\n    \"appointmentNumber\": 8,\n    \"doctor\": {\n        \"name\": \"thomas collins\",\n        \"hospital\": \"grand oak community hospital\",\n        \"category\": \"surgery\",\n        \"availability\": \"9.00 a.m - 11.00 a.m\",\n        \"fee\": 7000.0\n    },\n    \"patient\": {\n        \"name\": \"John Doe\",\n        \"dob\": \"1940-03-19\",\n        \"ssn\": \"234-23-525\",\n        \"address\": \"California\",\n        \"phone\": \"8770586755\",\n        \"email\": \"johndoe@gmail.com\"\n    },\n    \"fee\": 7000.0,\n    \"hospital\": \"grand oak community hospital\",\n    \"confirmed\": false,\n    \"appointmentDate\": \"2017-04-02\"\n}\n```\n\n## Complete implementation\n\nCheck out the [complete implementation](https://github.com/ballerina-guides/integration-tutorials/tree/main/content-based-message-routing) on GitHub.\n\n## References\n\n- [`ballerina/http` API docs](https://lib.ballerina.io/ballerina/http/latest)\n- [`ballerina/log` API docs](https://lib.ballerina.io/ballerina/log/latest)\n","slug":"content-based-message-routing"},"__N_SSG":true},"page":"/learn/integration/integration-tutorials/[slug]","query":{"slug":"content-based-message-routing"},"buildId":"YxMFR4Z1L0Ga7PZ_Z5EQ9","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>