<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="description" content="A programming language for the cloud that makes it easier to use, combine, and create network services."/><meta name="keywords" content="ballerinalang, integration, microservices, programming language, cloud native, ballerina language"/><title>Send emails from a service</title><meta property="og:type" content="article"/><meta property="og:title" content="Ballerina - Send emails from a service"/><meta property="og:description" content="A programming language for the cloud that makes it easier to use, combine, and create network services."/><meta property="og:title" content="Ballerina"/><meta property="twitter:description" content="A programming language for the cloud that makes it easier to use, combine, and create network services."/><meta property="twitter:text:description" content="A programming language for the cloud that makes it easier to use, combine, and create network services."/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><meta property="og:image" content="https://ballerina.io/images/ballerina-generic-social-media-image-2023.png"/><meta property="og:title" content="Ballerina"/><meta property="og:image" content="https://ballerina.io/images/ballerina-generic-social-media-image-2023.png"/><meta name="twitter:site" content="@ballerinalang"/><meta name="twitter:creator" content="@ballerinalang"/><meta name="twitter:title" content="Ballerina"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:image" content="https://ballerina.io/images/ballerina-generic-social-media-image-2023.png"/><meta property="twitter:image" content="https://ballerina.io/images/ballerina-generic-social-media-image-2023.png"/><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.setAttributeNode(d.createAttribute('data-ot-ignore'));j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-PSL2TX4');</script><script type="text/javascript" crossorigin="true" src="https://cdn.jsdelivr.net/npm/@docsearch/js@alpha"></script><script src="https://cookie-cdn.cookiepro.com/scripttemplates/otSDKStub.js" type="text/javascript" charSet="UTF-8" data-domain-script="630ad396-5fd5-4745-92ae-2765dc8841ee" defer=""></script><meta name="next-head-count" content="23"/><meta charSet="utf-8"/><meta name="author" content="WSO2 LLC"/><meta HTTP-EQUIV="X-Frame-Options" CONTENT="SAMEORIGIN"/><meta HTTP-EQUIV="Content-Security-Policy" CONTENT="frame-ancestors &#x27;none&#x27;;"/><link rel="shortcut icon" href="/images/favicon.ico"/><link rel="stylesheet" href="/css/roboto.css"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css"/><link rel="stylesheet" href="/css/ballerina-search-button.css"/><link rel="stylesheet" href="/css/ballerina-search-modal.css"/><link rel="stylesheet" href="/css/ballerina-search-variables.css"/><link rel="stylesheet" href="/css/ballerina-search-style.css"/><link rel="preload" href="/_next/static/css/4912777e2cfb47d2.css" as="style"/><link rel="stylesheet" href="/_next/static/css/4912777e2cfb47d2.css" data-n-g=""/><link rel="preload" href="/_next/static/css/ed928f4e0113510f.css" as="style"/><link rel="stylesheet" href="/_next/static/css/ed928f4e0113510f.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-676a25c773882039.js" defer=""></script><script src="/_next/static/chunks/framework-a070cbfff3c750c5.js" defer=""></script><script src="/_next/static/chunks/main-a66eb456a358e5ca.js" defer=""></script><script src="/_next/static/chunks/pages/_app-49e87402e1a02b9d.js" defer=""></script><script src="/_next/static/chunks/9733-caeb053dcf01b5fd.js" defer=""></script><script src="/_next/static/chunks/8999-b1f394634e8708da.js" defer=""></script><script src="/_next/static/chunks/5530-9e94516ef785d153.js" defer=""></script><script src="/_next/static/chunks/2092-643ce819261b95c6.js" defer=""></script><script src="/_next/static/chunks/4564-079435fb4878d182.js" defer=""></script><script src="/_next/static/chunks/5795-c59bab88fcc5a40c.js" defer=""></script><script src="/_next/static/chunks/pages/learn/integration/integration-tutorials/%5Bslug%5D-98bdeb669cbe7491.js" defer=""></script><script src="/_next/static/YxMFR4Z1L0Ga7PZ_Z5EQ9/_buildManifest.js" defer=""></script><script src="/_next/static/YxMFR4Z1L0Ga7PZ_Z5EQ9/_ssgManifest.js" defer=""></script><script src="/_next/static/YxMFR4Z1L0Ga7PZ_Z5EQ9/_middlewareManifest.js" defer=""></script></head><body><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-PSL2TX4" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript><div id="__next" data-reactroot=""><div class="main-wrapper other vstack gap-0"><div class="wrap-page-content container"><div class="row"><div class="mdContent col-sm-10 col-12"><div class="row"><div style="margin-bottom:20px;" class="patternContent col-12"><div class="backToLanding" href="/learn/integration-tutorials/"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="#3ad1ca" class="bi bi-box-arrow-left ms-0" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M6 12.5a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-9a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v2a.5.5 0 0 1-1 0v-2A1.5 1.5 0 0 1 6.5 2h8A1.5 1.5 0 0 1 16 3.5v9a1.5 1.5 0 0 1-1.5 1.5h-8A1.5 1.5 0 0 1 5 12.5v-2a.5.5 0 0 1 1 0v2z"></path><path fill-rule="evenodd" d="M.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L1.707 7.5H10.5a.5.5 0 0 1 0 1H1.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"></path></svg><p class="m-0 p-0">Back to integration tutorials</p></div></div></div><div class="topRow innerRow row"><div class="col-11"><h1>Send emails from a service</h1></div><div class="gitIcon col-1"><a href="https://github.com/ballerina-platform/ballerina-dev-website/blob/master/swan-lake/integration-tutorials/send-emails-from-a-service.md" target="_blank" rel="noreferrer" title="Edit in GitHub"></a></div></div><div style="margin-top:40px;margin-bottom:0;align-items:center" class="pageContentRow innerRow row"><div class="col-md-8 col-12"><p>This tutorial helps you understand the basics of Ballerina constructs, which allow you to do client calls and develop RESTful APIs.</p></div><div class="col-md-3 col-12"><img/></div></div><div class="pageContentRow innerRow row"><div class="col-12"><h2 id="overview" data-section="overview" class="section"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="currentColor" class="bi bi-link-45deg mdButton pe-2" viewBox="0 0 16 16"><path d="M4.715 6.542 3.343 7.914a3 3 0 1 0 4.243 4.243l1.828-1.829A3 3 0 0 0 8.586 5.5L8 6.086a1.002 1.002 0 0 0-.154.199 2 2 0 0 1 .861 3.337L6.88 11.45a2 2 0 1 1-2.83-2.83l.793-.792a4.018 4.018 0 0 1-.128-1.287z"></path><path d="M6.586 4.672A3 3 0 0 0 7.414 9.5l.775-.776a2 2 0 0 1-.896-3.346L9.12 3.55a2 2 0 1 1 2.83 2.83l-.793.792c.112.42.155.855.128 1.287l1.372-1.372a3 3 0 1 0-4.243-4.243L6.586 4.672z"></path></svg>Overview</h2>
<p>In this tutorial, you will develop a service that accepts requests to make an appointment at a hospital, makes the appointment, and sends an email to the client confirming the appointment details.</p>
<p>To implement this use case, you will develop a REST service with a single resource using Visual Studio Code with the Ballerina Swan Lake extension. This resource will receive the user request, reserve the appointment, and send an email to the user with the appointment details.</p>
<p>The flow is as follows.</p>
<ol>
<li>Receive a request with a JSON payload in the following form.</li>
</ol>
<pre><pre class="default"><code>{
    &quot;patient&quot;: {
        &quot;name&quot;: &quot;John Doe&quot;,
        &quot;dob&quot;: &quot;1940-03-19&quot;,
        &quot;ssn&quot;: &quot;234-23-525&quot;,
        &quot;address&quot;: &quot;California&quot;,
        &quot;phone&quot;: &quot;8770586755&quot;,
        &quot;email&quot;: &quot;johndoe@gmail.com&quot;,
        &quot;cardNo&quot;: &quot;7844481124110331&quot;
    },
    &quot;doctor&quot;: &quot;thomas collins&quot;,
    &quot;hospital_id&quot;: &quot;grandoaks&quot;,
    &quot;hospital&quot;: &quot;grand oak community hospital&quot;,
    &quot;appointment_date&quot;: &quot;2023-10-02&quot;
}
</code></pre></pre>
<ol start="2">
<li>Extract necessary details from the request (e.g., hospital, patient, doctor, etc.) and make a call to the hospital backend service to request an appointment. A response similar to the following will be returned from the hospital backend service on success.</li>
</ol>
<pre><pre class="default"><code>{
    &quot;appointmentNumber&quot;: 1,
    &quot;doctor&quot;: {
        &quot;name&quot;: &quot;thomas collins&quot;,
        &quot;hospital&quot;: &quot;grand oak community hospital&quot;,
        &quot;category&quot;: &quot;surgery&quot;,
        &quot;availability&quot;: &quot;9.00 a.m - 11.00 a.m&quot;,
        &quot;fee&quot;: 7000.0
    },
    &quot;patient&quot;: {
        &quot;name&quot;: &quot;John Doe&quot;,
        &quot;dob&quot;: &quot;1940-03-19&quot;,
        &quot;ssn&quot;: &quot;234-23-525&quot;,
        &quot;address&quot;: &quot;California&quot;,
        &quot;phone&quot;: &quot;8770586755&quot;,
        &quot;email&quot;: &quot;johndoe@gmail.com&quot;
    },
    &quot;hospital&quot;: &quot;grand oak community hospital&quot;,
    &quot;confirmed&quot;: false,
    &quot;appointmentDate&quot;: &quot;2023-10-02&quot;
}
</code></pre></pre>
<ol start="3">
<li>Call the payment backend service to make the payment and retrieve the reservation response which will have a payload similar to that shown below. If the payment is successful, send an email to the user with the appointment details.</li>
</ol>
<pre><pre class="default"><code>{
    &quot;appointmentNo&quot;: 1,
    &quot;doctorName&quot;: &quot;thomas collins&quot;,
    &quot;patient&quot;: &quot;John Doe&quot;,
    &quot;actualFee&quot;: 7000,
    &quot;discount&quot;: 20,
    &quot;discounted&quot;: 5600.0,
    &quot;paymentID&quot;: &quot;8458c75a-c8e0-4d49-8da4-5e56043b1a20&quot;,
    &quot;status&quot;: &quot;settled&quot;
}
</code></pre></pre>
<h3 id="concepts-covered" data-section="concepts-covered" class="section"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="currentColor" class="bi bi-link-45deg mdButton pe-2" viewBox="0 0 16 16"><path d="M4.715 6.542 3.343 7.914a3 3 0 1 0 4.243 4.243l1.828-1.829A3 3 0 0 0 8.586 5.5L8 6.086a1.002 1.002 0 0 0-.154.199 2 2 0 0 1 .861 3.337L6.88 11.45a2 2 0 1 1-2.83-2.83l.793-.792a4.018 4.018 0 0 1-.128-1.287z"></path><path d="M6.586 4.672A3 3 0 0 0 7.414 9.5l.775-.776a2 2 0 0 1-.896-3.346L9.12 3.55a2 2 0 1 1 2.83 2.83l-.793.792c.112.42.155.855.128 1.287l1.372-1.372a3 3 0 1 0-4.243-4.243L6.586 4.672z"></path></svg>Concepts covered</h3>
<ul>
<li>REST API</li>
<li>HTTP Client</li>
<li>Email Client</li>
</ul>
<h2 id="develop-the-application" data-section="develop-the-application" class="section"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="currentColor" class="bi bi-link-45deg mdButton pe-2" viewBox="0 0 16 16"><path d="M4.715 6.542 3.343 7.914a3 3 0 1 0 4.243 4.243l1.828-1.829A3 3 0 0 0 8.586 5.5L8 6.086a1.002 1.002 0 0 0-.154.199 2 2 0 0 1 .861 3.337L6.88 11.45a2 2 0 1 1-2.83-2.83l.793-.792a4.018 4.018 0 0 1-.128-1.287z"></path><path d="M6.586 4.672A3 3 0 0 0 7.414 9.5l.775-.776a2 2 0 0 1-.896-3.346L9.12 3.55a2 2 0 1 1 2.83 2.83l-.793.792c.112.42.155.855.128 1.287l1.372-1.372a3 3 0 1 0-4.243-4.243L6.586 4.672z"></path></svg>Develop the application</h2>
<h3 id="step-1-set-up-the-workspace" data-section="step-1-set-up-the-workspace" class="section"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="currentColor" class="bi bi-link-45deg mdButton pe-2" viewBox="0 0 16 16"><path d="M4.715 6.542 3.343 7.914a3 3 0 1 0 4.243 4.243l1.828-1.829A3 3 0 0 0 8.586 5.5L8 6.086a1.002 1.002 0 0 0-.154.199 2 2 0 0 1 .861 3.337L6.88 11.45a2 2 0 1 1-2.83-2.83l.793-.792a4.018 4.018 0 0 1-.128-1.287z"></path><path d="M6.586 4.672A3 3 0 0 0 7.414 9.5l.775-.776a2 2 0 0 1-.896-3.346L9.12 3.55a2 2 0 1 1 2.83 2.83l-.793.792c.112.42.155.855.128 1.287l1.372-1.372a3 3 0 1 0-4.243-4.243L6.586 4.672z"></path></svg>Step 1: Set up the workspace</h3>
<p>Install <a href="https://ballerina.io/downloads/">Ballerina Swan Lake</a> and the <a href="https://marketplace.visualstudio.com/items?itemName=wso2.ballerina">Ballerina Swan Lake VS Code extension</a> on VS Code.</p>
<h3 id="step-2-develop-the-service" data-section="step-2-develop-the-service" class="section"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="currentColor" class="bi bi-link-45deg mdButton pe-2" viewBox="0 0 16 16"><path d="M4.715 6.542 3.343 7.914a3 3 0 1 0 4.243 4.243l1.828-1.829A3 3 0 0 0 8.586 5.5L8 6.086a1.002 1.002 0 0 0-.154.199 2 2 0 0 1 .861 3.337L6.88 11.45a2 2 0 1 1-2.83-2.83l.793-.792a4.018 4.018 0 0 1-.128-1.287z"></path><path d="M6.586 4.672A3 3 0 0 0 7.414 9.5l.775-.776a2 2 0 0 1-.896-3.346L9.12 3.55a2 2 0 1 1 2.83 2.83l-.793.792c.112.42.155.855.128 1.287l1.372-1.372a3 3 0 1 0-4.243-4.243L6.586 4.672z"></path></svg>Step 2: Develop the service</h3>
<p>Follow the instructions given in this section to develop the service.</p>
<ol>
<li>Create a new Ballerina project using the <code>bal</code> command and open it in VS Code.</li>
</ol>
<pre><div>$ bal new send-emails-from-a-service</div></pre>
<ol start="2">
<li>Introduce the source code in files with the <code>.bal</code> extension (e.g., the <code>main.bal</code> file).</li>
</ol>
<p>Import the</p>
<ul>
<li><code>ballerina/email</code> module to send emails using the SMTP protocol</li>
<li><code>ballerina/http</code> module to develop the REST API and define the clients that can be used to send requests to the backend services</li>
<li><code>ballerina/log</code> module to log debug, error or info level information for each client request</li>
</ul>
<pre><pre class="default"><code>import ballerina/email;
import ballerina/http;
import ballerina/log;
</code></pre></pre>
<ol start="3">
<li>Define <a href="https://ballerina.io/learn/by-example/#configurability">configurable variables</a> for the port on which the listener should listen and the URLs of the backend services. Also define configurable variables for the host, username, and password of the SMTP client.</li>
</ol>
<blockquote>
<p><strong>Note:</strong> Enable two factor authentication on your Google account, generate an app password, and use the app password in place of your email password. The app password can be generated with <a href="https://myaccount.google.com/apppasswords?pli=1&amp;rapt=AEjHL4Mf5XDD4rE79YJpP5E2NoNwhvXMET_TWyBcQRn-HMzt0PI8BmptpMGRiBVIamW-0ECgVZtXxMRA19bL4Wfnq_hmjBEMqA">this link</a>.</p>
</blockquote>
<pre><pre class="default"><code>configurable int port = 8290;
configurable string hospitalServicesBackend = &quot;http://localhost:9090&quot;;
configurable string paymentBackend = &quot;http://localhost:9090/healthcare/payments&quot;;
configurable string host = &quot;smtp.gmail.com&quot;;
configurable string username = ?;
configurable string password = ?;
</code></pre></pre>
<ol start="4">
<li>Define two <a href="https://ballerina.io/learn/by-example/#http-client"><code>http:Client</code></a> clients to send requests to the backend services and one <a href="https://ballerina.io/learn/by-example/#email-client"><code>email:SmtpClient</code></a> client to send emails.</li>
</ol>
<pre><pre class="default"><code>final http:Client hospitalServicesEP = check initializeHttpClient(hospitalServicesBackend);
final http:Client paymentEP = check initializeHttpClient(paymentBackend);
final email:SmtpClient smtpClient = check initializeEmailClient();

function initializeHttpClient(string url) returns http:Client|error =&gt; new (url);

function initializeEmailClient() returns email:SmtpClient|error =&gt; new (host, username, password);
</code></pre></pre>
<blockquote>
<p><strong>Note:</strong> The argument to the <code>new</code> expression is the URL for the backend service.</p>
<p>Alternatively, the clients can be initialized directly with <code>new</code> expressions, but a separate function is used to aid with testing.</p>
<pre><pre class="default"><code>final http:Client hospitalServicesEP = check new (hospitalServicesBackend);
final http:Client paymentEP = check new (paymentBackend);
</code></pre></pre>
</blockquote>
<ol start="5">
<li>Define records corresponding to the request payload and response payloads.</li>
</ol>
<pre><pre class="default"><code>type Patient record {|
    string name;
    string dob;
    string ssn;
    string address;
    string phone;
    string email;
|};

type Doctor record {|
    string name;
    string hospital;
    string category;
    string availability;
    decimal fee;
|};

type Appointment record {|
    int appointmentNumber;
    Doctor doctor;
    Patient patient;
    boolean confirmed;
    string hospital;
    string appointmentDate;
|};

type PaymentSettlement record {|
    int appointmentNumber;
    Doctor doctor;
    Patient patient;
    decimal fee;
    boolean confirmed;
    string card_number;
|};

type Payment record {|
    int appointmentNo;
    string doctorName;
    string patient;
    decimal actualFee;
    int discount;
    decimal discounted;
    string paymentID;
    string status;
|};

type ReservationRequest record {|
    record {|
        *Patient;
        string cardNo;
    |} patient;
    string doctor;
    string hospital_id;
    string hospital;
    string appointment_date;
|};

type ReservationResponse record {|
    int appointmentNo;
    string doctorName;
    string patient;
    decimal actualFee;
    int discount;
    decimal discounted;
    string paymentID;
    string status;
|};
</code></pre></pre>
<ul>
<li>
<p>The <code>ReservationRequest</code> record uses <a href="https://ballerina.io/learn/by-example/type-inclusion-for-records/">record type inclusion</a> in the type of the <code>patient</code> field to include all the fields from the <code>Patient</code> record along with the <code>cardNo</code> field.</p>
</li>
<li>
<p>The initial record definitions can be generated using the &quot;Paste JSON as record&quot; VSCode command with the relevant JSON payloads and the records can then be modified as necessary.</p>
</li>
</ul>
<ol start="6">
<li>Define the <a href="https://ballerina.io/learn/by-example/#rest-service">HTTP service (REST API)</a> that has the resource function that accepts user requests, makes calls to the backend services to retrieve relevant details, and sends emails to the client with appointment details.</li>
</ol>
<pre><pre class="default"><code>service /healthcare on new http:Listener(port) {
    resource function post categories/[string category]/reserve(ReservationRequest payload) 
            returns http:Created|http:InternalServerError|http:NotFound {
        
    }
}
</code></pre></pre>
<ul>
<li>
<p>Use <code>/healthcare</code> as the service path (or the context) for the service attached to the listener that is listening on port <code>port</code>.</p>
</li>
<li>
<p>The HTTP resource allows the <code>POST</code> operation on resource path <code>/categories/{category}/reserve</code>, where <code>category</code> (corresponding to the specialization) is a path parameter.</p>
</li>
<li>
<p>Use <code>ReservationRequest</code> as a parameter indicating that the resource expects a JSON object corresponding to <code>ReservationRequest</code> as the payload.</p>
</li>
<li>
<p>Use <code>http:Created|http:InternalServerError|http:NotFound</code> as the return type to indicate that the response will be a &quot;Created&quot; response when the email is sent successfully to the user or the response will be an &quot;InternalServerError&quot; or &quot;NotFound&quot; response on error.</p>
</li>
</ul>
<ol start="7">
<li>Implement the logic.</li>
</ol>
<pre><pre class="default"><code>service /healthcare on new http:Listener(port) {

    resource function post categories/[string category]/reserve(ReservationRequest payload)
            returns http:Created|http:InternalServerError|http:NotFound {

        ReservationRequest {
            patient: {cardNo, ...patient},
            doctor,
            hospital,
            hospital_id,
            appointment_date
        } = payload;

        Appointment|http:ClientError appointment =
                hospitalServicesEP-&gt;/[hospital_id]/categories/[category]/reserve.post({
            patient,
            doctor,
            hospital,
            appointment_date
        });

        if appointment !is Appointment {
            log:printError(&quot;Appointment reservation failed&quot;, appointment);
            if appointment is http:ClientRequestError {
                return &lt;http:NotFound&gt;{body: string `unknown hospital, doctor, or category`};
            }
            return &lt;http:InternalServerError&gt;{body: appointment.message()};
        }

        int appointmentNumber = appointment.appointmentNumber;

        Payment|http:ClientError payment = paymentEP-&gt;/.post({
            appointmentNumber,
            doctor: appointment.doctor,
            patient: appointment.patient,
            fee: appointment.doctor.fee,
            confirmed: appointment.confirmed,
            card_number: cardNo
        });

        if payment !is Payment {
            log:printError(&quot;Payment settlement failed&quot;, payment);
            if payment is http:ClientRequestError {
                return &lt;http:NotFound&gt;{body: string `payment failed: unknown appointment number`};
            }
            return &lt;http:InternalServerError&gt;{body: payment.message()};
        }

        email:Error? sendMessage = smtpClient-&gt;sendMessage({
            to: patient.email,
            subject: &quot;Appointment reservation confirmed at &quot; + hospital,
            body: getEmailContent(appointmentNumber, appointment, payment)
        });

        if sendMessage is email:Error {
            return &lt;http:InternalServerError&gt;{body: sendMessage.message()};
        }
        log:printDebug(&quot;Email sent successfully&quot;,
                        name = patient.name,
                        appointmentNumber = appointmentNumber);
        &lt;http:Created&gt;{};
    }
}

function getEmailContent(int appointmentNumber, Appointment appointment, Payment payment)
        returns string =&gt;
    let Patient patient = appointment.patient, Doctor doctor = appointment.doctor in
    string `Appointment Confirmation

    Appointment Details
        Appointment Number: ${appointmentNumber}
        Appointment Date: ${appointment.appointmentDate}

    Patient Details
        Name: ${patient.name}
        Contact Number: ${patient.phone}

    Doctor Details
        Name: ${doctor.name}
        Specialization: ${doctor.category}

    Payment Details
        Doctor Fee: ${payment.actualFee}
        Discount: ${payment.discount}
        Total Fee: ${payment.discounted}
        Payment Status: ${payment.status}`;
</code></pre></pre>
<ul>
<li>
<p>The first backend call is a <code>POST</code> request to the hospital service to reserve the appointment. The <code>hospital_id</code> and <code>category</code> values are used as path parameters.</p>
<pre><pre class="default"><code>Appointment|http:ClientError appointment =
        hospitalServicesEP-&gt;/[hospital_id]/categories/[category]/reserve.post({
    patient,
    doctor,
    hospital,
    appointment_date
});
</code></pre></pre>
</li>
<li>
<p>Use the <code>is</code> check to decide the flow based on the response to the client call. If the request failed, return a &quot;NotFound&quot; response. Else, if the payload could not be bound to <code>Appointment</code> as expected or if there were any other failures, respond with an &quot;InternalServerError&quot; response.</p>
<pre><pre class="default"><code>if appointment !is Appointment {
    log:printError(&quot;Appointment reservation failed&quot;, appointment);
    if appointment is http:ClientRequestError {
        return &lt;http:NotFound&gt;{body: string `unknown hospital, doctor, or category`};
    }
    return &lt;http:InternalServerError&gt;{body: appointment.message()};
}
</code></pre></pre>
</li>
<li>
<p>If the appointment reservation was successful, we can make the payment by making a <code>POST</code> request to the payment service. The payload includes details extracted out from the original request (for <code>card_number</code>) and the appointment reservation response (for <code>appointmentNumber</code>, <code>doctor</code>, <code>patient</code>, <code>fee</code>, and <code>confirmed</code>).</p>
<pre><pre class="default"><code>Payment|http:ClientError payment = paymentEP-&gt;/.post({
    appointmentNumber,
    doctor: appointment.doctor,
    patient: appointment.patient,
    fee: appointment.doctor.fee,
    confirmed: appointment.confirmed,
    card_number: cardNo
});

if payment !is Payment {
    log:printError(&quot;Payment settlement failed&quot;, payment);
    if payment is http:ClientRequestError {
        return &lt;http:NotFound&gt;{body: string `payment failed: unknown appointment number`};
    }
    return &lt;http:InternalServerError&gt;{body: payment.message()};
}
</code></pre></pre>
</li>
<li>
<p>If the payment was successful, the next and final step is to send an email to the user with the appointment details. We send the email specifying the user&#x27;s email address, the subject, and the email body.</p>
<pre><pre class="default"><code>email:Error? sendMessage = smtpClient-&gt;sendMessage({
    to: patient.email,
    subject: &quot;Appointment reservation confirmed at &quot; + hospital,
    body: getEmailContent(appointmentNumber, appointment, payment)
});
</code></pre></pre>
<pre><pre class="default"><code>function getEmailContent(int appointmentNumber, Appointment appointment, Payment payment)
        returns string =&gt;
    let Patient patient = appointment.patient, Doctor doctor = appointment.doctor in
    string `Appointment Confirmation

    Appointment Details
        Appointment Number: ${appointmentNumber}
        Appointment Date: ${appointment.appointmentDate}

    Patient Details
        Name: ${patient.name}
        Contact Number: ${patient.phone}

    Doctor Details
        Name: ${doctor.name}
        Specialization: ${doctor.category}

    Payment Details
        Doctor Fee: ${payment.actualFee}
        Discount: ${payment.discount}
        Total Fee: ${payment.discounted}
        Payment Status: ${payment.status}`;
</code></pre></pre>
</li>
<li>
<p>If the email is sent successfully, the response will be a &quot;Created&quot; response. If the email sending process resulted in an error, an &quot;InternalServerError&quot; response will be returned.</p>
<pre><pre class="default"><code>email:Error? sendMessage = smtpClient-&gt;sendMessage({
    to: patient.email,
    subject: &quot;Appointment reservation confirmed at &quot; + hospital,
    body: getEmailContent(appointmentNumber, appointment, payment)
});

if sendMessage is email:Error {
    return &lt;http:InternalServerError&gt;{body: sendMessage.message()};
}
log:printDebug(&quot;Email sent successfully&quot;,
                name = patient.name,
                appointmentNumber = appointmentNumber);
&lt;http:Created&gt;{};
</code></pre></pre>
</li>
</ul>
<p>You have successfully developed the required service.</p>
<h4 id="complete-source" data-section="complete-source" class="section"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="currentColor" class="bi bi-link-45deg mdButton pe-2" viewBox="0 0 16 16"><path d="M4.715 6.542 3.343 7.914a3 3 0 1 0 4.243 4.243l1.828-1.829A3 3 0 0 0 8.586 5.5L8 6.086a1.002 1.002 0 0 0-.154.199 2 2 0 0 1 .861 3.337L6.88 11.45a2 2 0 1 1-2.83-2.83l.793-.792a4.018 4.018 0 0 1-.128-1.287z"></path><path d="M6.586 4.672A3 3 0 0 0 7.414 9.5l.775-.776a2 2 0 0 1-.896-3.346L9.12 3.55a2 2 0 1 1 2.83 2.83l-.793.792c.112.42.155.855.128 1.287l1.372-1.372a3 3 0 1 0-4.243-4.243L6.586 4.672z"></path></svg>Complete source</h4>
<pre><pre class="default"><code>import ballerina/email;
import ballerina/http;
import ballerina/log;

type Patient record {|
    string name;
    string dob;
    string ssn;
    string address;
    string phone;
    string email;
|};

type Doctor record {|
    string name;
    string hospital;
    string category;
    string availability;
    decimal fee;
|};

type Appointment record {|
    int appointmentNumber;
    Doctor doctor;
    Patient patient;
    boolean confirmed;
    string hospital;
    string appointmentDate;
|};

type PaymentSettlement record {|
    int appointmentNumber;
    Doctor doctor;
    Patient patient;
    decimal fee;
    boolean confirmed;
    string card_number;
|};

type Payment record {|
    int appointmentNo;
    string doctorName;
    string patient;
    decimal actualFee;
    int discount;
    decimal discounted;
    string paymentID;
    string status;
|};

type ReservationRequest record {|
    record {|
        *Patient;
        string cardNo;
    |} patient;
    string doctor;
    string hospital_id;
    string hospital;
    string appointment_date;
|};

type ReservationResponse record {|
    int appointmentNo;
    string doctorName;
    string patient;
    decimal actualFee;
    int discount;
    decimal discounted;
    string paymentID;
    string status;
|};

configurable int port = 8290;
configurable string hospitalServicesBackend = &quot;http://localhost:9090&quot;;
configurable string paymentBackend = &quot;http://localhost:9090/healthcare/payments&quot;;
configurable string host = &quot;smtp.gmail.com&quot;;
configurable string username = ?;
configurable string password = ?;

final http:Client hospitalServicesEP = check initializeHttpClient(hospitalServicesBackend);
final http:Client paymentEP = check initializeHttpClient(paymentBackend);
final email:SmtpClient smtpClient = check initializeEmailClient();

function initializeHttpClient(string url) returns http:Client|error =&gt; new (url);

function initializeEmailClient() returns email:SmtpClient|error =&gt; new (host, username, password);

service /healthcare on new http:Listener(port) {

    resource function post categories/[string category]/reserve(ReservationRequest payload)
            returns http:Created|http:InternalServerError|http:NotFound {

        ReservationRequest {
            patient: {cardNo, ...patient},
            doctor,
            hospital,
            hospital_id,
            appointment_date
        } = payload;

        Appointment|http:ClientError appointment =
                hospitalServicesEP-&gt;/[hospital_id]/categories/[category]/reserve.post({
            patient,
            doctor,
            hospital,
            appointment_date
        });

        if appointment !is Appointment {
            log:printError(&quot;Appointment reservation failed&quot;, appointment);
            if appointment is http:ClientRequestError {
                return &lt;http:NotFound&gt;{body: string `unknown hospital, doctor, or category`};
            }
            return &lt;http:InternalServerError&gt;{body: appointment.message()};
        }

        int appointmentNumber = appointment.appointmentNumber;

        Payment|http:ClientError payment = paymentEP-&gt;/.post({
            appointmentNumber,
            doctor: appointment.doctor,
            patient: appointment.patient,
            fee: appointment.doctor.fee,
            confirmed: appointment.confirmed,
            card_number: cardNo
        });

        if payment !is Payment {
            log:printError(&quot;Payment settlement failed&quot;, payment);
            if payment is http:ClientRequestError {
                return &lt;http:NotFound&gt;{body: string `payment failed: unknown appointment number`};
            }
            return &lt;http:InternalServerError&gt;{body: payment.message()};
        }

        email:Error? sendMessage = smtpClient-&gt;sendMessage({
            to: patient.email,
            subject: &quot;Appointment reservation confirmed at &quot; + hospital,
            body: getEmailContent(appointmentNumber, appointment, payment)
        });

        if sendMessage is email:Error {
            return &lt;http:InternalServerError&gt;{body: sendMessage.message()};
        }
        log:printDebug(&quot;Email sent successfully&quot;,
                        name = patient.name,
                        appointmentNumber = appointmentNumber);
        return &lt;http:Created&gt;{};
    }
}

function getEmailContent(int appointmentNumber, Appointment appointment, Payment payment)
        returns string =&gt;
    let Patient patient = appointment.patient, Doctor doctor = appointment.doctor in
    string `Appointment Confirmation

    Appointment Details
        Appointment Number: ${appointmentNumber}
        Appointment Date: ${appointment.appointmentDate}

    Patient Details
        Name: ${patient.name}
        Contact Number: ${patient.phone}

    Doctor Details
        Name: ${doctor.name}
        Specialization: ${doctor.category}

    Payment Details
        Doctor Fee: ${payment.actualFee}
        Discount: ${payment.discount}
        Total Fee: ${payment.discounted}
        Payment Status: ${payment.status}`;
</code></pre></pre>
<h3 id="step-3-build-and-run-the-service" data-section="step-3-build-and-run-the-service" class="section"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="currentColor" class="bi bi-link-45deg mdButton pe-2" viewBox="0 0 16 16"><path d="M4.715 6.542 3.343 7.914a3 3 0 1 0 4.243 4.243l1.828-1.829A3 3 0 0 0 8.586 5.5L8 6.086a1.002 1.002 0 0 0-.154.199 2 2 0 0 1 .861 3.337L6.88 11.45a2 2 0 1 1-2.83-2.83l.793-.792a4.018 4.018 0 0 1-.128-1.287z"></path><path d="M6.586 4.672A3 3 0 0 0 7.414 9.5l.775-.776a2 2 0 0 1-.896-3.346L9.12 3.55a2 2 0 1 1 2.83 2.83l-.793.792c.112.42.155.855.128 1.287l1.372-1.372a3 3 0 1 0-4.243-4.243L6.586 4.672z"></path></svg>Step 3: Build and run the service</h3>
<p>You can run this service by navigating to the project root and using the <code>bal run</code> command.</p>
<pre><pre class="default"><code>send-emails-from-a-service$ bal run
Compiling source
        integration_tutorials/send_emails_from_a_service:0.1.0

Running executable
</code></pre></pre>
<h3 id="step-4-try-out-the-use-case" data-section="step-4-try-out-the-use-case" class="section"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="currentColor" class="bi bi-link-45deg mdButton pe-2" viewBox="0 0 16 16"><path d="M4.715 6.542 3.343 7.914a3 3 0 1 0 4.243 4.243l1.828-1.829A3 3 0 0 0 8.586 5.5L8 6.086a1.002 1.002 0 0 0-.154.199 2 2 0 0 1 .861 3.337L6.88 11.45a2 2 0 1 1-2.83-2.83l.793-.792a4.018 4.018 0 0 1-.128-1.287z"></path><path d="M6.586 4.672A3 3 0 0 0 7.414 9.5l.775-.776a2 2 0 0 1-.896-3.346L9.12 3.55a2 2 0 1 1 2.83 2.83l-.793.792c.112.42.155.855.128 1.287l1.372-1.372a3 3 0 1 0-4.243-4.243L6.586 4.672z"></path></svg>Step 4: Try out the use case</h3>
<p>Let&#x27;s test the use case by sending a request to the service.</p>
<h4 id="start-the-backend-service" data-section="start-the-backend-service" class="section"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="currentColor" class="bi bi-link-45deg mdButton pe-2" viewBox="0 0 16 16"><path d="M4.715 6.542 3.343 7.914a3 3 0 1 0 4.243 4.243l1.828-1.829A3 3 0 0 0 8.586 5.5L8 6.086a1.002 1.002 0 0 0-.154.199 2 2 0 0 1 .861 3.337L6.88 11.45a2 2 0 1 1-2.83-2.83l.793-.792a4.018 4.018 0 0 1-.128-1.287z"></path><path d="M6.586 4.672A3 3 0 0 0 7.414 9.5l.775-.776a2 2 0 0 1-.896-3.346L9.12 3.55a2 2 0 1 1 2.83 2.83l-.793.792c.112.42.155.855.128 1.287l1.372-1.372a3 3 0 1 0-4.243-4.243L6.586 4.672z"></path></svg>Start the backend service</h4>
<p>Download the JAR file for the backend service from the <a href="https://github.com/ballerina-guides/integration-tutorials/blob/main/backends/hospital-service/">backend service</a> and execute the following command to start the service:</p>
<pre><pre class="default"><code>bal run hospitalservice.jar
</code></pre></pre>
<h4 id="send-a-request" data-section="send-a-request" class="section"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="currentColor" class="bi bi-link-45deg mdButton pe-2" viewBox="0 0 16 16"><path d="M4.715 6.542 3.343 7.914a3 3 0 1 0 4.243 4.243l1.828-1.829A3 3 0 0 0 8.586 5.5L8 6.086a1.002 1.002 0 0 0-.154.199 2 2 0 0 1 .861 3.337L6.88 11.45a2 2 0 1 1-2.83-2.83l.793-.792a4.018 4.018 0 0 1-.128-1.287z"></path><path d="M6.586 4.672A3 3 0 0 0 7.414 9.5l.775-.776a2 2 0 0 1-.896-3.346L9.12 3.55a2 2 0 1 1 2.83 2.83l-.793.792c.112.42.155.855.128 1.287l1.372-1.372a3 3 0 1 0-4.243-4.243L6.586 4.672z"></path></svg>Send a request</h4>
<p>Let&#x27;s send a request to the service using cURL as follows.</p>
<ol>
<li>
<p>Install and set up <a href="https://curl.se/">cURL</a> as your client.</p>
</li>
<li>
<p>Create a file named <code>request.json</code> with the request payload.</p>
</li>
</ol>
<pre><pre class="default"><code>{
    &quot;patient&quot;: {
        &quot;name&quot;: &quot;John Doe&quot;,
        &quot;dob&quot;: &quot;1940-03-19&quot;,
        &quot;ssn&quot;: &quot;234-23-525&quot;,
        &quot;address&quot;: &quot;California&quot;,
        &quot;phone&quot;: &quot;8770586755&quot;,
        &quot;email&quot;: &quot;johndoe@gmail.com&quot;,
        &quot;cardNo&quot;: &quot;7844481124110331&quot;
    },
    &quot;doctor&quot;: &quot;thomas collins&quot;,
    &quot;hospital_id&quot;: &quot;grandoaks&quot;,
    &quot;hospital&quot;: &quot;grand oak community hospital&quot;,
    &quot;appointment_date&quot;: &quot;2023-10-02&quot;
}
</code></pre></pre>
<ol start="3">
<li>Execute the following command.</li>
</ol>
<pre><pre class="default"><code>curl -v -X POST --data @request.json http://localhost:8290/healthcare/categories/surgery/reserve --header &quot;Content-Type:application/json&quot;
</code></pre></pre>
<h4 id="verify-the-email" data-section="verify-the-email" class="section"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="currentColor" class="bi bi-link-45deg mdButton pe-2" viewBox="0 0 16 16"><path d="M4.715 6.542 3.343 7.914a3 3 0 1 0 4.243 4.243l1.828-1.829A3 3 0 0 0 8.586 5.5L8 6.086a1.002 1.002 0 0 0-.154.199 2 2 0 0 1 .861 3.337L6.88 11.45a2 2 0 1 1-2.83-2.83l.793-.792a4.018 4.018 0 0 1-.128-1.287z"></path><path d="M6.586 4.672A3 3 0 0 0 7.414 9.5l.775-.776a2 2 0 0 1-.896-3.346L9.12 3.55a2 2 0 1 1 2.83 2.83l-.793.792c.112.42.155.855.128 1.287l1.372-1.372a3 3 0 1 0-4.243-4.243L6.586 4.672z"></path></svg>Verify the email</h4>
<p>You will receive an email with information similar to the following for a successful appointment reservation.</p>
<pre><pre class="default"><code>Appointment Confirmation

    Appointment Details
        Appointment Number: 1
        Appointment Date: 2023-10-02

    Patient Details
        Name: John Doe
        Contact Number : 8770586755

    Doctor Details
        Name: thomas collins
        Specialization: surgery

    Payment Details
        Doctor Fee: 7000.0
        Discount: 20
        Total Fee: 5600.0
        Payment Status: settled
</code></pre></pre>
<h2 id="complete-implementation" data-section="complete-implementation" class="section"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="currentColor" class="bi bi-link-45deg mdButton pe-2" viewBox="0 0 16 16"><path d="M4.715 6.542 3.343 7.914a3 3 0 1 0 4.243 4.243l1.828-1.829A3 3 0 0 0 8.586 5.5L8 6.086a1.002 1.002 0 0 0-.154.199 2 2 0 0 1 .861 3.337L6.88 11.45a2 2 0 1 1-2.83-2.83l.793-.792a4.018 4.018 0 0 1-.128-1.287z"></path><path d="M6.586 4.672A3 3 0 0 0 7.414 9.5l.775-.776a2 2 0 0 1-.896-3.346L9.12 3.55a2 2 0 1 1 2.83 2.83l-.793.792c.112.42.155.855.128 1.287l1.372-1.372a3 3 0 1 0-4.243-4.243L6.586 4.672z"></path></svg>Complete implementation</h2>
<p>Check out the <a href="https://github.com/ballerina-guides/integration-tutorials/tree/main/send-emails-from-a-service">complete implementation</a> on GitHub.</p>
<h2 id="references" data-section="references" class="section"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="currentColor" class="bi bi-link-45deg mdButton pe-2" viewBox="0 0 16 16"><path d="M4.715 6.542 3.343 7.914a3 3 0 1 0 4.243 4.243l1.828-1.829A3 3 0 0 0 8.586 5.5L8 6.086a1.002 1.002 0 0 0-.154.199 2 2 0 0 1 .861 3.337L6.88 11.45a2 2 0 1 1-2.83-2.83l.793-.792a4.018 4.018 0 0 1-.128-1.287z"></path><path d="M6.586 4.672A3 3 0 0 0 7.414 9.5l.775-.776a2 2 0 0 1-.896-3.346L9.12 3.55a2 2 0 1 1 2.83 2.83l-.793.792c.112.42.155.855.128 1.287l1.372-1.372a3 3 0 1 0-4.243-4.243L6.586 4.672z"></path></svg>References</h2>
<ul>
<li><a href="https://lib.ballerina.io/ballerina/http/latest"><code>ballerina/http</code> API docs</a></li>
<li><a href="https://lib.ballerina.io/ballerina/email/latest"><code>ballerina/email</code> API docs</a></li>
<li><a href="https://lib.ballerina.io/ballerina/log/latest"><code>ballerina/log</code> API docs</a></li>
</ul></div></div></div><div class="pageToc d-none d-sm-block col-sm-2"></div></div></div><div class="Footer_stack__Y9iHo vstack gap-0"><div class="Footer_footer__gXdNn container"><div class="row"><div class="col-lg-6 col-md-6 col-sm-12 col-12"><div class="row"><div class="col-lg-6 col-md-12 col-sm-12 col-12"><div class="Footer_socialMedia__99VpI"><div class="Footer_smIcons__HD9f7"><ul><li><a href="https://github.com/ballerina-platform" target="_blank" rel="noreferrer" title="GitHub"></a></li><li><a href="https://twitter.com/ballerinalang" target="_blank" rel="noreferrer" title="Twitter"></a></li><li><a href="https://discord.gg/ballerinalang" target="_blank" rel="noreferrer" title="Discord"></a></li><li><a href="https://stackoverflow.com/questions/tagged/ballerina" target="_blank" rel="noreferrer" title="Stackoverflow"></a></li><li><a href="https://www.youtube.com/c/Ballerinalang" target="_blank" rel="noreferrer" title="YouTube"></a></li><li><a href="https://www.linkedin.com/company/79080790" target="_blank" rel="noreferrer" title="LinkedIn"></a></li></ul></div></div><div class="Footer_footerLinks__M9jUM"><ul><li><a href="/downloads/">DOWNLOAD</a></li><li><a class="footerLink" target="_blank" rel="noreferrer" href="https://github.com/ballerina-platform/ballerina-lang/issues/new/choose">REPORT ISSUES</a></li></ul></div></div><div class="col-lg-6 col-md-12 col-sm-12 col-12"><div class="Footer_subscription__N96Xy"><div class="Footer_subscribe__6aRU2"><a href="/community/#subscribe-to-our-newsletter">Subscribe to our newsletter</a></div><div class="Footer_subscribe__6aRU2"><a class="Footer_subRss__E8gAT" href="https://blog.ballerina.io/feed.xml" target="_blank" rel="noreferrer">Subscribe via RSS</a></div></div></div></div></div><div class="Footer_inspire__ZAi5V col-lg-6 col-md-6 col-sm-12 col-12"><p>In the creation of Ballerina, we were inspired by many technologies. Thank you to all that have come before us (and forgive us if we missed one): Java, Go, C, C++, D, Rust, Haskell, Kotlin, Dart, TypeScript, JavaScript, Python, Perl, Flow, Swift, Elm, RelaxNG, NPM, Crates, Maven, Gradle, Kubernetes, Docker, Envoy, Markdown, GitHub, and WSO2.</p></div></div><div class="Footer_policyLinks__q3ge1 row"><div class="col-sm-2 col-12"><span class="footerLink">© 2018-2023 WSO2 LLC</span></div><div class="col-sm-10 col-12"><ul><li><a class="footerLink" target="_blank" rel="noreferrer" href="https://github.com/ballerina-lang/ballerina/blob/master/LICENSE">CODE LICENSE</a></li><li><a href="/license-of-site/">SITE LICENSE</a></li><li><a href="/terms-of-service/">TERMS OF SERVICE</a></li><li><a href="/privacy-policy/">PRIVACY POLICY</a></li><li><a href="/cookie-policy/">COOKIE POLICY</a></li><li><a href="/security-policy/">SECURITY POLICY</a></li><li><a href="/trademark-usage-policy/">TRADEMARK USAGE POLICY</a></li></ul></div></div></div></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"frontmatter":{"layout":"ballerina-send-emails-from-a-service-left-nav-pages-swanlake","title":"Send emails from a service","permalink":"/learn/send-emails-from-a-service/","description":"Integration tutorial for sending emails from a service.","keywords":"ballerina, programming language, client, restful-api, integration, smtp, email","active":"send-emails-from-a-service","intro":"This tutorial helps you understand the basics of Ballerina constructs, which allow you to do client calls and develop RESTful APIs."},"content":"\n## Overview\n\nIn this tutorial, you will develop a service that accepts requests to make an appointment at a hospital, makes the appointment, and sends an email to the client confirming the appointment details.\n\nTo implement this use case, you will develop a REST service with a single resource using Visual Studio Code with the Ballerina Swan Lake extension. This resource will receive the user request, reserve the appointment, and send an email to the user with the appointment details.\n\nThe flow is as follows.\n\n1. Receive a request with a JSON payload in the following form.\n\n```\n{\n    \"patient\": {\n        \"name\": \"John Doe\",\n        \"dob\": \"1940-03-19\",\n        \"ssn\": \"234-23-525\",\n        \"address\": \"California\",\n        \"phone\": \"8770586755\",\n        \"email\": \"johndoe@gmail.com\",\n        \"cardNo\": \"7844481124110331\"\n    },\n    \"doctor\": \"thomas collins\",\n    \"hospital_id\": \"grandoaks\",\n    \"hospital\": \"grand oak community hospital\",\n    \"appointment_date\": \"2023-10-02\"\n}\n```\n\n2. Extract necessary details from the request (e.g., hospital, patient, doctor, etc.) and make a call to the hospital backend service to request an appointment. A response similar to the following will be returned from the hospital backend service on success.\n\n```\n{\n    \"appointmentNumber\": 1,\n    \"doctor\": {\n        \"name\": \"thomas collins\",\n        \"hospital\": \"grand oak community hospital\",\n        \"category\": \"surgery\",\n        \"availability\": \"9.00 a.m - 11.00 a.m\",\n        \"fee\": 7000.0\n    },\n    \"patient\": {\n        \"name\": \"John Doe\",\n        \"dob\": \"1940-03-19\",\n        \"ssn\": \"234-23-525\",\n        \"address\": \"California\",\n        \"phone\": \"8770586755\",\n        \"email\": \"johndoe@gmail.com\"\n    },\n    \"hospital\": \"grand oak community hospital\",\n    \"confirmed\": false,\n    \"appointmentDate\": \"2023-10-02\"\n}\n```\n\n3. Call the payment backend service to make the payment and retrieve the reservation response which will have a payload similar to that shown below. If the payment is successful, send an email to the user with the appointment details.\n\n```\n{\n    \"appointmentNo\": 1,\n    \"doctorName\": \"thomas collins\",\n    \"patient\": \"John Doe\",\n    \"actualFee\": 7000,\n    \"discount\": 20,\n    \"discounted\": 5600.0,\n    \"paymentID\": \"8458c75a-c8e0-4d49-8da4-5e56043b1a20\",\n    \"status\": \"settled\"\n}\n```\n\n### Concepts covered\n\n- REST API\n- HTTP Client\n- Email Client\n\n## Develop the application\n\n### Step 1: Set up the workspace\n\nInstall [Ballerina Swan Lake](https://ballerina.io/downloads/) and the [Ballerina Swan Lake VS Code extension](https://marketplace.visualstudio.com/items?itemName=wso2.ballerina) on VS Code.\n\n### Step 2: Develop the service\n\nFollow the instructions given in this section to develop the service.\n\n1. Create a new Ballerina project using the `bal` command and open it in VS Code.\n\n```bash\n$ bal new send-emails-from-a-service\n```\n\n2. Introduce the source code in files with the `.bal` extension (e.g., the `main.bal` file). \n\nImport the \n- `ballerina/email` module to send emails using the SMTP protocol\n- `ballerina/http` module to develop the REST API and define the clients that can be used to send requests to the backend services\n- `ballerina/log` module to log debug, error or info level information for each client request\n\n```\nimport ballerina/email;\nimport ballerina/http;\nimport ballerina/log;\n```\n\n3. Define [configurable variables](https://ballerina.io/learn/by-example/#configurability) for the port on which the listener should listen and the URLs of the backend services. Also define configurable variables for the host, username, and password of the SMTP client.\n\n\u003e **Note:** Enable two factor authentication on your Google account, generate an app password, and use the app password in place of your email password. The app password can be generated with [this link](https://myaccount.google.com/apppasswords?pli=1\u0026rapt=AEjHL4Mf5XDD4rE79YJpP5E2NoNwhvXMET_TWyBcQRn-HMzt0PI8BmptpMGRiBVIamW-0ECgVZtXxMRA19bL4Wfnq_hmjBEMqA).\n\n```\nconfigurable int port = 8290;\nconfigurable string hospitalServicesBackend = \"http://localhost:9090\";\nconfigurable string paymentBackend = \"http://localhost:9090/healthcare/payments\";\nconfigurable string host = \"smtp.gmail.com\";\nconfigurable string username = ?;\nconfigurable string password = ?;\n```\n\n4. Define two [`http:Client`](https://ballerina.io/learn/by-example/#http-client) clients to send requests to the backend services and one [`email:SmtpClient`](https://ballerina.io/learn/by-example/#email-client) client to send emails.\n\n```\nfinal http:Client hospitalServicesEP = check initializeHttpClient(hospitalServicesBackend);\nfinal http:Client paymentEP = check initializeHttpClient(paymentBackend);\nfinal email:SmtpClient smtpClient = check initializeEmailClient();\n\nfunction initializeHttpClient(string url) returns http:Client|error =\u003e new (url);\n\nfunction initializeEmailClient() returns email:SmtpClient|error =\u003e new (host, username, password);\n```\n\n\u003e **Note:** The argument to the `new` expression is the URL for the backend service. \n\u003e \n\u003e Alternatively, the clients can be initialized directly with `new` expressions, but a separate function is used to aid with testing.\n\u003e \n\u003e ```\n\u003e final http:Client hospitalServicesEP = check new (hospitalServicesBackend);\n\u003e final http:Client paymentEP = check new (paymentBackend);\n\u003e ```\n\n5. Define records corresponding to the request payload and response payloads.\n\n```\ntype Patient record {|\n    string name;\n    string dob;\n    string ssn;\n    string address;\n    string phone;\n    string email;\n|};\n\ntype Doctor record {|\n    string name;\n    string hospital;\n    string category;\n    string availability;\n    decimal fee;\n|};\n\ntype Appointment record {|\n    int appointmentNumber;\n    Doctor doctor;\n    Patient patient;\n    boolean confirmed;\n    string hospital;\n    string appointmentDate;\n|};\n\ntype PaymentSettlement record {|\n    int appointmentNumber;\n    Doctor doctor;\n    Patient patient;\n    decimal fee;\n    boolean confirmed;\n    string card_number;\n|};\n\ntype Payment record {|\n    int appointmentNo;\n    string doctorName;\n    string patient;\n    decimal actualFee;\n    int discount;\n    decimal discounted;\n    string paymentID;\n    string status;\n|};\n\ntype ReservationRequest record {|\n    record {|\n        *Patient;\n        string cardNo;\n    |} patient;\n    string doctor;\n    string hospital_id;\n    string hospital;\n    string appointment_date;\n|};\n\ntype ReservationResponse record {|\n    int appointmentNo;\n    string doctorName;\n    string patient;\n    decimal actualFee;\n    int discount;\n    decimal discounted;\n    string paymentID;\n    string status;\n|};\n```\n\n- The `ReservationRequest` record uses [record type inclusion](https://ballerina.io/learn/by-example/type-inclusion-for-records/) in the type of the `patient` field to include all the fields from the `Patient` record along with the `cardNo` field.\n\n- The initial record definitions can be generated using the \"Paste JSON as record\" VSCode command with the relevant JSON payloads and the records can then be modified as necessary.\n\n6. Define the [HTTP service (REST API)](https://ballerina.io/learn/by-example/#rest-service) that has the resource function that accepts user requests, makes calls to the backend services to retrieve relevant details, and sends emails to the client with appointment details.\n\n```\nservice /healthcare on new http:Listener(port) {\n    resource function post categories/[string category]/reserve(ReservationRequest payload) \n            returns http:Created|http:InternalServerError|http:NotFound {\n        \n    }\n}\n```\n\n- Use `/healthcare` as the service path (or the context) for the service attached to the listener that is listening on port `port`.\n  \n- The HTTP resource allows the `POST` operation on resource path `/categories/{category}/reserve`, where `category` (corresponding to the specialization) is a path parameter.\n\n- Use `ReservationRequest` as a parameter indicating that the resource expects a JSON object corresponding to `ReservationRequest` as the payload. \n\n- Use `http:Created|http:InternalServerError|http:NotFound` as the return type to indicate that the response will be a \"Created\" response when the email is sent successfully to the user or the response will be an \"InternalServerError\" or \"NotFound\" response on error.\n\n7. Implement the logic.\n\n```\nservice /healthcare on new http:Listener(port) {\n\n    resource function post categories/[string category]/reserve(ReservationRequest payload)\n            returns http:Created|http:InternalServerError|http:NotFound {\n\n        ReservationRequest {\n            patient: {cardNo, ...patient},\n            doctor,\n            hospital,\n            hospital_id,\n            appointment_date\n        } = payload;\n\n        Appointment|http:ClientError appointment =\n                hospitalServicesEP-\u003e/[hospital_id]/categories/[category]/reserve.post({\n            patient,\n            doctor,\n            hospital,\n            appointment_date\n        });\n\n        if appointment !is Appointment {\n            log:printError(\"Appointment reservation failed\", appointment);\n            if appointment is http:ClientRequestError {\n                return \u003chttp:NotFound\u003e{body: string `unknown hospital, doctor, or category`};\n            }\n            return \u003chttp:InternalServerError\u003e{body: appointment.message()};\n        }\n\n        int appointmentNumber = appointment.appointmentNumber;\n\n        Payment|http:ClientError payment = paymentEP-\u003e/.post({\n            appointmentNumber,\n            doctor: appointment.doctor,\n            patient: appointment.patient,\n            fee: appointment.doctor.fee,\n            confirmed: appointment.confirmed,\n            card_number: cardNo\n        });\n\n        if payment !is Payment {\n            log:printError(\"Payment settlement failed\", payment);\n            if payment is http:ClientRequestError {\n                return \u003chttp:NotFound\u003e{body: string `payment failed: unknown appointment number`};\n            }\n            return \u003chttp:InternalServerError\u003e{body: payment.message()};\n        }\n\n        email:Error? sendMessage = smtpClient-\u003esendMessage({\n            to: patient.email,\n            subject: \"Appointment reservation confirmed at \" + hospital,\n            body: getEmailContent(appointmentNumber, appointment, payment)\n        });\n\n        if sendMessage is email:Error {\n            return \u003chttp:InternalServerError\u003e{body: sendMessage.message()};\n        }\n        log:printDebug(\"Email sent successfully\",\n                        name = patient.name,\n                        appointmentNumber = appointmentNumber);\n        \u003chttp:Created\u003e{};\n    }\n}\n\nfunction getEmailContent(int appointmentNumber, Appointment appointment, Payment payment)\n        returns string =\u003e\n    let Patient patient = appointment.patient, Doctor doctor = appointment.doctor in\n    string `Appointment Confirmation\n\n    Appointment Details\n        Appointment Number: ${appointmentNumber}\n        Appointment Date: ${appointment.appointmentDate}\n\n    Patient Details\n        Name: ${patient.name}\n        Contact Number: ${patient.phone}\n\n    Doctor Details\n        Name: ${doctor.name}\n        Specialization: ${doctor.category}\n\n    Payment Details\n        Doctor Fee: ${payment.actualFee}\n        Discount: ${payment.discount}\n        Total Fee: ${payment.discounted}\n        Payment Status: ${payment.status}`;\n```\n\n- The first backend call is a `POST` request to the hospital service to reserve the appointment. The `hospital_id` and `category` values are used as path parameters.\n\n    ```\n    Appointment|http:ClientError appointment =\n            hospitalServicesEP-\u003e/[hospital_id]/categories/[category]/reserve.post({\n        patient,\n        doctor,\n        hospital,\n        appointment_date\n    });\n    ```\n\n- Use the `is` check to decide the flow based on the response to the client call. If the request failed, return a \"NotFound\" response. Else, if the payload could not be bound to `Appointment` as expected or if there were any other failures, respond with an \"InternalServerError\" response.\n\n    ```\n    if appointment !is Appointment {\n        log:printError(\"Appointment reservation failed\", appointment);\n        if appointment is http:ClientRequestError {\n            return \u003chttp:NotFound\u003e{body: string `unknown hospital, doctor, or category`};\n        }\n        return \u003chttp:InternalServerError\u003e{body: appointment.message()};\n    }\n    ```\n\n- If the appointment reservation was successful, we can make the payment by making a `POST` request to the payment service. The payload includes details extracted out from the original request (for `card_number`) and the appointment reservation response (for `appointmentNumber`, `doctor`, `patient`, `fee`, and `confirmed`).\n\n    ```\n    Payment|http:ClientError payment = paymentEP-\u003e/.post({\n        appointmentNumber,\n        doctor: appointment.doctor,\n        patient: appointment.patient,\n        fee: appointment.doctor.fee,\n        confirmed: appointment.confirmed,\n        card_number: cardNo\n    });\n\n    if payment !is Payment {\n        log:printError(\"Payment settlement failed\", payment);\n        if payment is http:ClientRequestError {\n            return \u003chttp:NotFound\u003e{body: string `payment failed: unknown appointment number`};\n        }\n        return \u003chttp:InternalServerError\u003e{body: payment.message()};\n    }\n    ```\n\n- If the payment was successful, the next and final step is to send an email to the user with the appointment details. We send the email specifying the user's email address, the subject, and the email body.\n\n    ```\n    email:Error? sendMessage = smtpClient-\u003esendMessage({\n        to: patient.email,\n        subject: \"Appointment reservation confirmed at \" + hospital,\n        body: getEmailContent(appointmentNumber, appointment, payment)\n    });\n    ```\n\n    ```\n    function getEmailContent(int appointmentNumber, Appointment appointment, Payment payment)\n            returns string =\u003e\n        let Patient patient = appointment.patient, Doctor doctor = appointment.doctor in\n        string `Appointment Confirmation\n\n        Appointment Details\n            Appointment Number: ${appointmentNumber}\n            Appointment Date: ${appointment.appointmentDate}\n\n        Patient Details\n            Name: ${patient.name}\n            Contact Number: ${patient.phone}\n\n        Doctor Details\n            Name: ${doctor.name}\n            Specialization: ${doctor.category}\n\n        Payment Details\n            Doctor Fee: ${payment.actualFee}\n            Discount: ${payment.discount}\n            Total Fee: ${payment.discounted}\n            Payment Status: ${payment.status}`;\n    ```\n\n- If the email is sent successfully, the response will be a \"Created\" response. If the email sending process resulted in an error, an \"InternalServerError\" response will be returned.\n\n    ```\n    email:Error? sendMessage = smtpClient-\u003esendMessage({\n        to: patient.email,\n        subject: \"Appointment reservation confirmed at \" + hospital,\n        body: getEmailContent(appointmentNumber, appointment, payment)\n    });\n\n    if sendMessage is email:Error {\n        return \u003chttp:InternalServerError\u003e{body: sendMessage.message()};\n    }\n    log:printDebug(\"Email sent successfully\",\n                    name = patient.name,\n                    appointmentNumber = appointmentNumber);\n    \u003chttp:Created\u003e{};\n    ```\n\nYou have successfully developed the required service.\n\n#### Complete source\n\n```\nimport ballerina/email;\nimport ballerina/http;\nimport ballerina/log;\n\ntype Patient record {|\n    string name;\n    string dob;\n    string ssn;\n    string address;\n    string phone;\n    string email;\n|};\n\ntype Doctor record {|\n    string name;\n    string hospital;\n    string category;\n    string availability;\n    decimal fee;\n|};\n\ntype Appointment record {|\n    int appointmentNumber;\n    Doctor doctor;\n    Patient patient;\n    boolean confirmed;\n    string hospital;\n    string appointmentDate;\n|};\n\ntype PaymentSettlement record {|\n    int appointmentNumber;\n    Doctor doctor;\n    Patient patient;\n    decimal fee;\n    boolean confirmed;\n    string card_number;\n|};\n\ntype Payment record {|\n    int appointmentNo;\n    string doctorName;\n    string patient;\n    decimal actualFee;\n    int discount;\n    decimal discounted;\n    string paymentID;\n    string status;\n|};\n\ntype ReservationRequest record {|\n    record {|\n        *Patient;\n        string cardNo;\n    |} patient;\n    string doctor;\n    string hospital_id;\n    string hospital;\n    string appointment_date;\n|};\n\ntype ReservationResponse record {|\n    int appointmentNo;\n    string doctorName;\n    string patient;\n    decimal actualFee;\n    int discount;\n    decimal discounted;\n    string paymentID;\n    string status;\n|};\n\nconfigurable int port = 8290;\nconfigurable string hospitalServicesBackend = \"http://localhost:9090\";\nconfigurable string paymentBackend = \"http://localhost:9090/healthcare/payments\";\nconfigurable string host = \"smtp.gmail.com\";\nconfigurable string username = ?;\nconfigurable string password = ?;\n\nfinal http:Client hospitalServicesEP = check initializeHttpClient(hospitalServicesBackend);\nfinal http:Client paymentEP = check initializeHttpClient(paymentBackend);\nfinal email:SmtpClient smtpClient = check initializeEmailClient();\n\nfunction initializeHttpClient(string url) returns http:Client|error =\u003e new (url);\n\nfunction initializeEmailClient() returns email:SmtpClient|error =\u003e new (host, username, password);\n\nservice /healthcare on new http:Listener(port) {\n\n    resource function post categories/[string category]/reserve(ReservationRequest payload)\n            returns http:Created|http:InternalServerError|http:NotFound {\n\n        ReservationRequest {\n            patient: {cardNo, ...patient},\n            doctor,\n            hospital,\n            hospital_id,\n            appointment_date\n        } = payload;\n\n        Appointment|http:ClientError appointment =\n                hospitalServicesEP-\u003e/[hospital_id]/categories/[category]/reserve.post({\n            patient,\n            doctor,\n            hospital,\n            appointment_date\n        });\n\n        if appointment !is Appointment {\n            log:printError(\"Appointment reservation failed\", appointment);\n            if appointment is http:ClientRequestError {\n                return \u003chttp:NotFound\u003e{body: string `unknown hospital, doctor, or category`};\n            }\n            return \u003chttp:InternalServerError\u003e{body: appointment.message()};\n        }\n\n        int appointmentNumber = appointment.appointmentNumber;\n\n        Payment|http:ClientError payment = paymentEP-\u003e/.post({\n            appointmentNumber,\n            doctor: appointment.doctor,\n            patient: appointment.patient,\n            fee: appointment.doctor.fee,\n            confirmed: appointment.confirmed,\n            card_number: cardNo\n        });\n\n        if payment !is Payment {\n            log:printError(\"Payment settlement failed\", payment);\n            if payment is http:ClientRequestError {\n                return \u003chttp:NotFound\u003e{body: string `payment failed: unknown appointment number`};\n            }\n            return \u003chttp:InternalServerError\u003e{body: payment.message()};\n        }\n\n        email:Error? sendMessage = smtpClient-\u003esendMessage({\n            to: patient.email,\n            subject: \"Appointment reservation confirmed at \" + hospital,\n            body: getEmailContent(appointmentNumber, appointment, payment)\n        });\n\n        if sendMessage is email:Error {\n            return \u003chttp:InternalServerError\u003e{body: sendMessage.message()};\n        }\n        log:printDebug(\"Email sent successfully\",\n                        name = patient.name,\n                        appointmentNumber = appointmentNumber);\n        return \u003chttp:Created\u003e{};\n    }\n}\n\nfunction getEmailContent(int appointmentNumber, Appointment appointment, Payment payment)\n        returns string =\u003e\n    let Patient patient = appointment.patient, Doctor doctor = appointment.doctor in\n    string `Appointment Confirmation\n\n    Appointment Details\n        Appointment Number: ${appointmentNumber}\n        Appointment Date: ${appointment.appointmentDate}\n\n    Patient Details\n        Name: ${patient.name}\n        Contact Number: ${patient.phone}\n\n    Doctor Details\n        Name: ${doctor.name}\n        Specialization: ${doctor.category}\n\n    Payment Details\n        Doctor Fee: ${payment.actualFee}\n        Discount: ${payment.discount}\n        Total Fee: ${payment.discounted}\n        Payment Status: ${payment.status}`;\n```\n\n### Step 3: Build and run the service\n\nYou can run this service by navigating to the project root and using the `bal run` command.\n\n```\nsend-emails-from-a-service$ bal run\nCompiling source\n        integration_tutorials/send_emails_from_a_service:0.1.0\n\nRunning executable\n```\n\n### Step 4: Try out the use case\n\nLet's test the use case by sending a request to the service.\n\n#### Start the backend service\n\nDownload the JAR file for the backend service from the [backend service](https://github.com/ballerina-guides/integration-tutorials/blob/main/backends/hospital-service/) and execute the following command to start the service:\n\n```\nbal run hospitalservice.jar\n```\n\n#### Send a request\n\nLet's send a request to the service using cURL as follows.\n\n1. Install and set up [cURL](https://curl.se/) as your client.\n\n2. Create a file named `request.json` with the request payload.\n\n```\n{\n    \"patient\": {\n        \"name\": \"John Doe\",\n        \"dob\": \"1940-03-19\",\n        \"ssn\": \"234-23-525\",\n        \"address\": \"California\",\n        \"phone\": \"8770586755\",\n        \"email\": \"johndoe@gmail.com\",\n        \"cardNo\": \"7844481124110331\"\n    },\n    \"doctor\": \"thomas collins\",\n    \"hospital_id\": \"grandoaks\",\n    \"hospital\": \"grand oak community hospital\",\n    \"appointment_date\": \"2023-10-02\"\n}\n```\n\n3. Execute the following command.\n\n```\ncurl -v -X POST --data @request.json http://localhost:8290/healthcare/categories/surgery/reserve --header \"Content-Type:application/json\"\n```\n\n#### Verify the email\n\nYou will receive an email with information similar to the following for a successful appointment reservation.\n\n```\nAppointment Confirmation\n\n    Appointment Details\n        Appointment Number: 1\n        Appointment Date: 2023-10-02\n\n    Patient Details\n        Name: John Doe\n        Contact Number : 8770586755\n\n    Doctor Details\n        Name: thomas collins\n        Specialization: surgery\n\n    Payment Details\n        Doctor Fee: 7000.0\n        Discount: 20\n        Total Fee: 5600.0\n        Payment Status: settled\n```\n\n## Complete implementation\n\nCheck out the [complete implementation](https://github.com/ballerina-guides/integration-tutorials/tree/main/send-emails-from-a-service) on GitHub.\n\n## References\n\n- [`ballerina/http` API docs](https://lib.ballerina.io/ballerina/http/latest)\n- [`ballerina/email` API docs](https://lib.ballerina.io/ballerina/email/latest)\n- [`ballerina/log` API docs](https://lib.ballerina.io/ballerina/log/latest)\n","slug":"send-emails-from-a-service"},"__N_SSG":true},"page":"/learn/integration/integration-tutorials/[slug]","query":{"slug":"send-emails-from-a-service"},"buildId":"YxMFR4Z1L0Ga7PZ_Z5EQ9","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>